<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>luau: parse.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>parse.c</h1><a href="parse_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"> * luau (Lib Update/Auto-Update): Simple Update Library</span>
00003 <span class="comment"> * Copyright (C) 2003  David Eklund</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * - This library is free software; you can redistribute it and/or             -</span>
00006 <span class="comment"> * - modify it under the terms of the GNU Lesser General Public                -</span>
00007 <span class="comment"> * - License as published by the Free Software Foundation; either              -</span>
00008 <span class="comment"> * - version 2.1 of the License, or (at your option) any later version.        -</span>
00009 <span class="comment"> * -                                                                           -</span>
00010 <span class="comment"> * - This library is distributed in the hope that it will be useful,           -</span>
00011 <span class="comment"> * - but WITHOUT ANY WARRANTY; without even the implied warranty of            -</span>
00012 <span class="comment"> * - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU         -</span>
00013 <span class="comment"> * - Lesser General Public License for more details.                           -</span>
00014 <span class="comment"> * -                                                                           -</span>
00015 <span class="comment"> * - You should have received a copy of the GNU Lesser General Public          -</span>
00016 <span class="comment"> * - License along with this library; if not, write to the Free Software       -</span>
00017 <span class="comment"> * - Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA -</span>
00018 <span class="comment"> */</span>
00019 
00020 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;config.h&gt;</span>
00022 <span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#include &lt;string.h&gt;</span>
00025 <span class="preprocessor">#include &lt;glib.h&gt;</span>
00026 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="parse_8h.html">parse.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="error_8h.html">error.h</a>"</span>
00031 
00032 <span class="preprocessor">#ifdef WITH_DMALLOC</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;dmalloc.h&gt;</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00045 <a class="code" href="structLUAU__parsedLine.html">LUAU_parsedLine</a> *
<a name="l00046"></a><a class="code" href="parse_8h.html#a0">00046</a> <a class="code" href="parse_8h.html#a0">lutil_parse_parseLine</a>(<span class="keywordtype">char</span> *input) {
00047         <a class="code" href="structLUAU__parsedLine.html">LUAU_parsedLine</a> *parsed = (<a class="code" href="structLUAU__parsedLine.html">LUAU_parsedLine</a>*) g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structLUAU__parsedLine.html">LUAU_parsedLine</a>));
00048         <span class="keywordtype">char</span> *arg, *ptr;
00049         
00050         parsed-&gt;<a class="code" href="structLUAU__parsedLine.html#o1">args</a> = g_ptr_array_new();
00051         
00052         parsed-&gt;<a class="code" href="structLUAU__parsedLine.html#o0">keyword</a> = <a class="code" href="parse_8h.html#a5">lutil_parse_nextToken_r</a>(input, &amp;ptr);
00053         <span class="keywordflow">while</span> ((arg = <a class="code" href="parse_8h.html#a5">lutil_parse_nextToken_r</a>(NULL, &amp;ptr)) != NULL)
00054                 g_ptr_array_add(parsed-&gt;<a class="code" href="structLUAU__parsedLine.html#o1">args</a>, arg);
00055         
00056         <span class="keywordflow">return</span> parsed;
00057 }
00058 
00075 <span class="keywordtype">char</span>
<a name="l00076"></a><a class="code" href="parse_8h.html#a1">00076</a> <a class="code" href="parse_8h.html#a1">lutil_parse_parseSymbol</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *input, <span class="keyword">const</span> GPtrArray *symbols) {
00077         <span class="keywordtype">char</span> *curr;
00078         <span class="keywordtype">char</span> result = -1;
00079         <span class="keywordtype">int</span> i;
00080         
00081         <span class="keywordflow">for</span> (i = 0; i &lt; symbols-&gt;len; i += 2) {
00082                 curr = g_ptr_array_index(symbols, i);
00083                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(input, curr)) {
00084                         result = GPOINTER_TO_INT (g_ptr_array_index(symbols, i+1));
00085                         <span class="keywordflow">break</span>;
00086                 }
00087         }
00088         
00089         <span class="keywordflow">return</span> result;
00090 }
00091 
00102 <span class="keywordtype">char</span>
<a name="l00103"></a><a class="code" href="parse_8h.html#a2">00103</a> <a class="code" href="parse_8h.html#a2">lutil_parse_parseSymbolArray</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *input, <span class="keyword">const</span> <span class="keywordtype">char</span> *symbols[]) {
00104         <span class="keyword">const</span> <span class="keywordtype">char</span> *curr;
00105         <span class="keywordtype">char</span> result = -1;
00106         <span class="keywordtype">int</span> i;
00107         
00108         <span class="keywordflow">for</span> (i = 0; symbols[i] != NULL; i += 2) {
00109                 curr = symbols[i];
00110                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(input, curr)) {
00111                         result = (symbols[i+1])[0];
00112                         <span class="keywordflow">break</span>;
00113                 }
00114         }
00115         
00116         <span class="keywordflow">return</span> result;
00117 }
00118 
00125 <span class="keywordtype">void</span>
<a name="l00126"></a><a class="code" href="parse_8h.html#a3">00126</a> <a class="code" href="parse_8h.html#a3">lutil_parse_freeParsedLine</a>(<a class="code" href="structLUAU__parsedLine.html">LUAU_parsedLine</a> *line) {
00127         <span class="keywordtype">int</span> i;
00128         
00129         <span class="keywordflow">if</span> (line != NULL) {
00130                 g_free(line-&gt;<a class="code" href="structLUAU__parsedLine.html#o0">keyword</a>);
00131                 
00132                 <span class="keywordflow">for</span> (i = 0; i &lt; line-&gt;<a class="code" href="structLUAU__parsedLine.html#o1">args</a>-&gt;len; ++i)
00133                         g_free(g_ptr_array_index(line-&gt;<a class="code" href="structLUAU__parsedLine.html#o1">args</a>, i));
00134                 
00135                 g_ptr_array_free(line-&gt;<a class="code" href="structLUAU__parsedLine.html#o1">args</a>, TRUE);
00136                 
00137                 g_free(line);
00138         }
00139 }
00140 
00153 <span class="keywordtype">char</span> *
<a name="l00154"></a><a class="code" href="parse_8h.html#a4">00154</a> <a class="code" href="parse_8h.html#a4">lutil_parse_nextToken</a>(<span class="keywordtype">char</span> *input) {
00155         <span class="keyword">static</span> <span class="keywordtype">char</span> *currentString = NULL;
00156         
00157         <span class="keywordflow">return</span> <a class="code" href="parse_8h.html#a5">lutil_parse_nextToken_r</a>(input, &amp;currentString);
00158 }
00159 
00160 <span class="keywordtype">char</span> *
<a name="l00161"></a><a class="code" href="parse_8h.html#a5">00161</a> <a class="code" href="parse_8h.html#a5">lutil_parse_nextToken_r</a>(<span class="keywordtype">char</span> *input, <span class="keywordtype">char</span> **ptrptr) {
00162         <span class="keywordtype">char</span> quoted = 0, *temp;
00163         GString *result = g_string_new(<span class="stringliteral">""</span>);
00164         gboolean escaped = FALSE, append;
00165         
00166         <span class="keywordflow">if</span> (input != NULL)
00167                 *ptrptr = input;
00168         <span class="keywordflow">if</span> (*ptrptr == NULL) {
00169                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"No input specified!"</span>);
00170                 <span class="keywordflow">return</span> NULL;
00171         }
00172         
00173         <span class="comment">/* skip leading whitespace */</span>
00174         <span class="keywordflow">while</span> (**ptrptr == <span class="charliteral">' '</span>) 
00175                 ++*ptrptr;
00176         
00177         <span class="keywordflow">while</span> (**ptrptr != <span class="charliteral">'\0'</span>) {
00178                 <span class="keywordflow">if</span> (escaped) {
00179                         <span class="comment">/* if given an escaped sequence of anything other than '\\' or '\"' inside a doubly quoted string or</span>
00180 <span class="comment">                         * a '\'' inside a singly quoted string, we pass the back-slash through. */</span>
00181                         <span class="keywordflow">if</span> (**ptrptr != <span class="charliteral">'\\'</span> &amp;&amp; **ptrptr != quoted)
00182                                 g_string_append_c(result, <span class="charliteral">'\\'</span>);
00183                         
00184                         append = TRUE;
00185                         escaped = FALSE;
00186                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (quoted) {
00187                         <span class="keywordflow">if</span> (**ptrptr == quoted) {
00188                                 append = FALSE;
00189                                 quoted = 0;
00190                         } <span class="keywordflow">else</span> {
00191                                 append = TRUE;
00192                         }
00193                 } <span class="keywordflow">else</span> {
00194                         <span class="keywordflow">if</span> (**ptrptr == <span class="charliteral">' '</span>) {
00195                                 ++*ptrptr;
00196                                 <span class="keywordflow">break</span>;
00197                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (**ptrptr == <span class="charliteral">'\\'</span>) {
00198                                 escaped = TRUE;
00199                                 append = FALSE;
00200                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (**ptrptr == <span class="charliteral">'"'</span> || **ptrptr == <span class="charliteral">'\''</span>) {
00201                                 quoted = **ptrptr;
00202                                 append = FALSE;
00203                         } <span class="keywordflow">else</span> {
00204                                 append = TRUE;
00205                         }
00206                 }
00207                 <span class="keywordflow">if</span> (append)
00208                         g_string_append_c(result, **ptrptr);
00209                 
00210                 ++*ptrptr;
00211         }
00212         
00213         <span class="keywordflow">if</span> (quoted) 
00214                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Quote not closed - multi-line quotes not supported"</span>);
00215         <span class="keywordflow">if</span> (escaped)
00216                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Back-slash at end of line - not supported"</span>);
00217         
00218         temp = result-&gt;str;
00219         g_string_free(result, FALSE);
00220         
00221         <span class="keywordflow">if</span> (*temp == <span class="charliteral">'\0'</span>) { <span class="comment">/* empty string */</span>
00222                 g_free(temp);
00223                 <span class="keywordflow">return</span> NULL;
00224         } <span class="keywordflow">else</span> {
00225                 <span class="keywordflow">return</span> temp;
00226         }
00227 }
00228 
00237 <span class="keywordtype">char</span> *
<a name="l00238"></a><a class="code" href="parse_8h.html#a6">00238</a> <a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(<span class="keywordtype">char</span>* string) {
00239         <span class="keywordtype">int</span> i;
00240         
00241         <span class="keywordflow">if</span> (string == NULL)
00242                 <span class="keywordflow">return</span> NULL;
00243         
00244         <span class="keywordflow">while</span> (isspace(*string)) ++string;
00245         <span class="keywordflow">for</span> (i = strlen(string)-1; i &gt;= 0 &amp;&amp; isspace(string[i]); --i) 
00246                 string[i] = <span class="charliteral">'\0'</span>;
00247         
00248         <span class="keywordflow">return</span> string;
00249 }
00250 
00258 <span class="keywordtype">char</span> *
<a name="l00259"></a><a class="code" href="parse_8h.html#a7">00259</a> <a class="code" href="parse_8h.html#a7">lutil_parse_skipString</a>(<span class="keywordtype">char</span>* input, <span class="keywordtype">char</span>* string) {
00260         <span class="keywordflow">return</span> (input + strlen(string));
00261 }
00262 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat Jan 15 16:52:30 2005 for luau by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
