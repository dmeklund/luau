<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>luau: libuau.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>libuau.c</h1><a href="libuau_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"> * luau (Lib Update/Auto-Update): Simple Update Library</span>
00003 <span class="comment"> * Copyright (C) 2003  David Eklund</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * - This library is free software; you can redistribute it and/or             -</span>
00006 <span class="comment"> * - modify it under the terms of the GNU Lesser General Public                -</span>
00007 <span class="comment"> * - License as published by the Free Software Foundation; either              -</span>
00008 <span class="comment"> * - version 2.1 of the License, or (at your option) any later version.        -</span>
00009 <span class="comment"> * -                                                                           -</span>
00010 <span class="comment"> * - This library is distributed in the hope that it will be useful,           -</span>
00011 <span class="comment"> * - but WITHOUT ANY WARRANTY; without even the implied warranty of            -</span>
00012 <span class="comment"> * - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU         -</span>
00013 <span class="comment"> * - Lesser General Public License for more details.                           -</span>
00014 <span class="comment"> * -                                                                           -</span>
00015 <span class="comment"> * - You should have received a copy of the GNU Lesser General Public          -</span>
00016 <span class="comment"> * - License along with this library; if not, write to the Free Software       -</span>
00017 <span class="comment"> * - Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA -</span>
00018 <span class="comment"> */</span>
00019 
00020 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;config.h&gt;</span>
00022 <span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00025 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00026 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00027 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00028 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00029 <span class="preprocessor">#include &lt;string.h&gt;</span>
00030 <span class="preprocessor">#include &lt;math.h&gt;</span>
00031 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00032 
00033 <span class="preprocessor">#include &lt;glib.h&gt;</span>
00034 
00035 <span class="preprocessor">#include "<a class="code" href="libuau_8h.html">libuau.h</a>"</span>
00036 <span class="preprocessor">#include "<a class="code" href="network_8h.html">network.h</a>"</span>
00037 <span class="preprocessor">#include "<a class="code" href="parseupdates_8h.html">parseupdates.h</a>"</span>
00038 <span class="preprocessor">#include "<a class="code" href="error_8h.html">error.h</a>"</span>
00039 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00040 <span class="preprocessor">#include "<a class="code" href="install_8h.html">install.h</a>"</span>
00041 <span class="preprocessor">#include "<a class="code" href="ftp_8h.html">ftp.h</a>"</span>
00042 
00043 <span class="preprocessor">#ifdef WITH_DMALLOC</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;dmalloc.h&gt;</span>
00045 <span class="preprocessor">#endif</span>
00046 <span class="preprocessor"></span>
00047 <span class="preprocessor">#ifdef WITH_LEAKBUG</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;leakbug.h&gt;</span>
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="libuau_8c.html#a0">compareAlphaNumeric</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *v1, <span class="keyword">const</span> <span class="keywordtype">char</span> *v2);
00052 
00053 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="libuau_8c.html#a1">categorizeUpdates</a>(<a class="code" href="structGContainer.html">GContainer</a> *updates, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo);
00054 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="libuau_8c.html#a2">categorizeUpdate</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo);
00055 <span class="keyword">static</span> gboolean <a class="code" href="libuau_8c.html#a3">isIncompatible</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo);
00056 <span class="keyword">static</span> gboolean <a class="code" href="libuau_8c.html#a4">isOld</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo);
00057 
00058 
00059 gboolean
<a name="l00060"></a><a class="code" href="libuau_8h.html#a50">00060</a> <a class="code" href="libuau_8h.html#a50">luau_getProgInfoFromXML_url</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, <span class="keyword">const</span> <span class="keywordtype">char</span> *url, GError **err) {
00061         GString *data;
00062         gboolean result;
00063         
00064         g_return_val_if_fail(err == NULL || *err == NULL, FALSE);
00065         
00066         data = <a class="code" href="ftp_8h.html#a2">lutil_ftp_getURL</a>(url, err);
00067         <span class="keywordflow">if</span> (data == NULL) {
00068                 g_assert(err == NULL || *err != NULL);
00069                 <span class="keywordflow">return</span> FALSE;
00070         }
00071         
00072         result = <a class="code" href="parseupdatesxml_8c.html#a32">luau_parseXML_progInfo</a>(data, progInfo, err);
00073         <span class="keywordflow">if</span> (result == FALSE) {
00074                 g_assert(err == NULL || *err != NULL);
00075                 <span class="keywordflow">return</span> FALSE;
00076         }
00077         
00078         <span class="keywordflow">return</span> TRUE;
00079 }
00080 
00081 gboolean
<a name="l00082"></a><a class="code" href="libuau_8h.html#a51">00082</a> <a class="code" href="libuau_8h.html#a51">luau_getProgInfoFromXML_data</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, GError **err) {
00083         GString *gdata;
00084         gboolean result;
00085         
00086         gdata = g_string_new(data);
00087         
00088         result = <a class="code" href="parseupdatesxml_8c.html#a32">luau_parseXML_progInfo</a>(gdata, progInfo, err);
00089         <span class="keywordflow">if</span> (result == FALSE) {
00090                 g_assert(err == NULL || *err != NULL);
00091                 <span class="keywordflow">return</span> FALSE;
00092         }
00093         
00094         g_string_free(gdata, TRUE);
00095         
00096         <span class="keywordflow">return</span> TRUE;
00097 }
00098 
00112 gboolean
<a name="l00113"></a><a class="code" href="libuau_8h.html#a52">00113</a> <a class="code" href="libuau_8h.html#a52">luau_getUpdateInfo</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *updateInfo, <span class="keyword">const</span> <span class="keywordtype">char</span>* updateID, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, GError **err) {
00114         <a class="code" href="structGContainer.html">GContainer</a> *allUpdates;
00115         GList *updateList;
00116         <a class="code" href="structGIterator.html">GIterator</a> iter;
00117         <a class="code" href="structAUpdate.html">AUpdate</a> *temp;
00118         gboolean found;
00119         
00120         g_return_val_if_fail(err == NULL || *err == NULL, FALSE);
00121         
00122         allUpdates = <a class="code" href="network_8h.html#a0">luau_net_queryServer</a>(progInfo, err);
00123         <span class="keywordflow">if</span> (allUpdates == NULL) {
00124                 g_assert(err == NULL || *err != NULL);
00125                 <span class="keywordflow">return</span> FALSE;
00126         }
00127         
00128         <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, allUpdates);
00129         found = FALSE;
00130         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter)) {
00131                 temp = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
00132                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(temp-&gt;<a class="code" href="structAUpdate.html#o0">id</a>, updateID)) {
00133                         <a class="code" href="libuau_8h.html#a88">luau_copyUpdate</a>(updateInfo, temp);
00134                         found = TRUE;
00135                         <span class="keywordflow">break</span>;
00136                 }
00137         }
00138         updateList = <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(allUpdates, FALSE);
00139         <a class="code" href="libuau_8h.html#a95">luau_freeUpdateList</a>(updateList);
00140         
00141         <span class="keywordflow">if</span> (found)
00142                 <a class="code" href="libuau_8c.html#a2">categorizeUpdate</a>(updateInfo, progInfo);
00143         <span class="keywordflow">else</span>
00144                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a37">LUAU_BASE_ERROR_INVALID_ARG</a>,
00145                         <span class="stringliteral">"No such update ID: %s (%s)"</span>, updateID, progInfo-&gt;<a class="code" href="structAProgInfo.html#o0">id</a>);
00146         
00147         <span class="keywordflow">return</span> found;
00148 }
00149 
00160 GList *
<a name="l00161"></a><a class="code" href="libuau_8h.html#a53">00161</a> <a class="code" href="libuau_8h.html#a53">luau_checkForUpdates</a>(<span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *info, GError **err) {
00162         <a class="code" href="structGContainer.html">GContainer</a> *result;
00163         GList *ret;
00164         
00165         g_return_val_if_fail(err == NULL || *err == NULL, NULL);
00166         
00167         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Checking for updates for %s: %s"</span>, info-&gt;<a class="code" href="structAProgInfo.html#o0">id</a>, info-&gt;<a class="code" href="structAProgInfo.html#o4">url</a>);
00168         result = <a class="code" href="network_8h.html#a0">luau_net_queryServer</a>(info, err);
00169         <span class="keywordflow">if</span> (result == NULL) {
00170                 g_assert(err == NULL || *err != NULL);
00171                 <span class="keywordflow">return</span> NULL;
00172         }
00173         
00174         <a class="code" href="libuau_8c.html#a1">categorizeUpdates</a>(result, info);
00175         
00176         ret = <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(result, FALSE);
00177         
00178         <span class="keywordflow">return</span> ret;
00179 }
00180 
00181 GList *
<a name="l00182"></a><a class="code" href="libuau_8h.html#a54">00182</a> <a class="code" href="libuau_8h.html#a54">luau_checkForUpdates_url</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *url, GError **err) {
00183         <a class="code" href="structAProgInfo.html">AProgInfo</a> progInfo;
00184         
00185         g_return_val_if_fail(err == NULL || *err == NULL, NULL);
00186         
00187         progInfo.<a class="code" href="structAProgInfo.html#o0">id</a> = <span class="stringliteral">"(unknown)"</span>;
00188         progInfo.<a class="code" href="structAProgInfo.html#o4">url</a> = (<span class="keywordtype">char</span>*) url;
00189         
00190         <span class="keywordflow">return</span> <a class="code" href="libuau_8h.html#a53">luau_checkForUpdates</a>(&amp;progInfo, err);
00191 }
00192 
00193 
00194 
00204 gboolean
<a name="l00205"></a><a class="code" href="libuau_8h.html#a55">00205</a> <a class="code" href="libuau_8h.html#a55">luau_installUpdate</a>(<span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *info, <span class="keyword">const</span> <a class="code" href="structAUpdate.html">AUpdate</a> *newUpdate, <span class="keyword">const</span> APkgType type, GError **err) {
00206         <span class="keywordtype">char</span> *filename, *actualFilename;
00207         gboolean result;
00208         
00209         g_return_val_if_fail(err == NULL || *err == NULL, FALSE);
00210         
00211         filename = <a class="code" href="util_8c.html#a16">lutil_getTempFilename</a>();
00212         
00213         actualFilename = <a class="code" href="libuau_8h.html#a56">luau_downloadUpdate</a>(info, newUpdate, type, filename, err);
00214         g_free(filename);
00215         <span class="keywordflow">if</span> (actualFilename == NULL) {
00216                 g_assert(err == NULL || *err != NULL);
00217                 <span class="keywordflow">return</span> FALSE;
00218         }
00219         
00220         result = <a class="code" href="libuau_8h.html#a57">luau_installPackage</a>(actualFilename, type, err);        
00221         g_free(actualFilename);
00222         <span class="keywordflow">if</span> (result == FALSE) {
00223                 g_assert(err == NULL || *err != NULL);
00224                 <span class="keywordflow">return</span> FALSE;
00225         }
00226         
00227         <span class="keywordflow">return</span> result;
00228 }
00229 
00245 <span class="keywordtype">char</span> *
<a name="l00246"></a><a class="code" href="libuau_8h.html#a56">00246</a> <a class="code" href="libuau_8h.html#a56">luau_downloadUpdate</a>(<span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *info, <span class="keyword">const</span> <a class="code" href="structAUpdate.html">AUpdate</a> *newUpdate, <span class="keyword">const</span> APkgType type, <span class="keyword">const</span> <span class="keywordtype">char</span>* downloadTo, GError **err) {
00247         <span class="keywordtype">char</span> *actualFilename = NULL, *temp;
00248         <a class="code" href="structAPackage.html">APackage</a> *pkg;
00249         <span class="keyword">struct </span>stat fileinfo;
00250         <span class="keywordtype">int</span> ret;
00251         gboolean result = FALSE;
00252         
00253         g_return_val_if_fail(err == NULL || *err == NULL, FALSE);
00254 
00255         <span class="keywordflow">if</span> (downloadTo != NULL &amp;&amp; downloadTo[0] != <span class="charliteral">'\0'</span>) {
00256                 <span class="keywordflow">while</span> (result == FALSE) {
00257                         ret = stat(downloadTo, &amp;fileinfo);
00258                         <span class="keywordflow">if</span> (ret == -1) {
00259                                 <span class="keywordflow">if</span> (errno != ENOENT) {
00260                                         g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a34">LUAU_BASE_ERROR_PERMS</a>, <span class="stringliteral">"Can't write to %s: %s"</span>, downloadTo, strerror(errno));
00261                                         <span class="keywordflow">return</span> NULL;
00262                                 } <span class="keywordflow">else</span> {
00263                                         result = TRUE;
00264                                 }
00265                         } <span class="keywordflow">else</span> {
00266                                 <span class="keywordflow">if</span> (S_ISREG(fileinfo.st_mode)) {
00267                                         ret = <a class="code" href="error_8h.html#a8">lutil_error_prompt</a>(<span class="stringliteral">"File Exists"</span>, <span class="stringliteral">"The specified download location already exists.  What would you like to do?"</span>, 2, 0, <span class="stringliteral">"Overwrite"</span>, <span class="stringliteral">"Cancel"</span>);
00268                                         <span class="keywordflow">if</span> (ret == 0) {
00269                                                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"File '%s' exists: overwriting"</span>, downloadTo);
00270                                                 result = TRUE;
00271                                         } <span class="keywordflow">else</span> {
00272                                                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a35">LUAU_BASE_ERROR_ABORTED</a>, <span class="stringliteral">"File '%s' exists: not overwriting"</span>, downloadTo);
00273                                                 <span class="keywordflow">return</span> NULL;
00274                                         }
00275                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISDIR(fileinfo.st_mode)) {
00276                                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Is a directory: writing into that directory"</span>);
00277                                         pkg = <a class="code" href="libuau_8h.html#a73">luau_getUpdatePackage</a>(newUpdate, type, err);
00278                                         <span class="keywordflow">if</span> (pkg == NULL) {
00279                                                 g_assert(err == NULL || *err != NULL);
00280                                                 <span class="keywordflow">return</span> NULL;
00281                                         }
00282                                         temp = <a class="code" href="libuau_8h.html#a75">luau_getPackageURL</a>(pkg, err);
00283                                         <span class="keywordflow">if</span> (temp == NULL) {
00284                                                 g_assert(err == NULL || *err != NULL);
00285                                                 <span class="keywordflow">return</span> NULL;
00286                                         }
00287                                         
00288                                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Preparing to download: %s"</span>, temp);
00289                                         temp = g_path_get_basename(temp);
00290                                         actualFilename = <a class="code" href="util_8h.html#a13">lutil_vstrcreate</a>(downloadTo, <span class="stringliteral">"/"</span>, temp, NULL);
00291                                         g_free(temp);
00292                                         downloadTo = actualFilename;
00293                                         <span class="comment">/* Loop back and check if this file now exists */</span>
00294                                 } <span class="keywordflow">else</span> {
00295                                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"FIFO, device, symlink, or socket given: treating as regular file"</span>);
00296                                         result = TRUE;
00297                                 }
00298                         }
00299                 }
00300                 
00301                 <span class="keywordflow">if</span> (actualFilename == NULL)
00302                         actualFilename = g_strdup(downloadTo);
00303         } <span class="keywordflow">else</span> {
00304                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a37">LUAU_BASE_ERROR_INVALID_ARG</a>, <span class="stringliteral">"No filename given"</span>);
00305                 <span class="keywordflow">return</span> NULL;
00306         }
00307         
00308         result = <a class="code" href="network_8h.html#a1">luau_net_downloadUpdate</a>(info, newUpdate, type, actualFilename, err);
00309         
00310         <span class="keywordflow">if</span> (result == FALSE) {
00311                 g_assert(err == NULL || *err != NULL);
00312                 g_free(actualFilename);
00313                 <span class="keywordflow">return</span> NULL;
00314         }
00315         
00316         <span class="keywordflow">return</span> actualFilename;
00317 }
00318 
00326 gboolean
<a name="l00327"></a><a class="code" href="libuau_8h.html#a57">00327</a> <a class="code" href="libuau_8h.html#a57">luau_installPackage</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename, <span class="keyword">const</span> APkgType type, GError **err) {
00328         gboolean result = FALSE;
00329         
00330         g_return_val_if_fail(err == NULL || *err == NULL, FALSE);
00331         
00332         <span class="keywordflow">switch</span> (type) {
00333                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a6">LUAU_RPM</a>:
00334                         result = <a class="code" href="install_8h.html#a0">luau_install_rpm</a>(filename, err);
00335                         <span class="keywordflow">break</span>;
00336                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a7">LUAU_DEB</a>:
00337                         result = <a class="code" href="install_8h.html#a1">luau_install_deb</a>(filename, err);
00338                         <span class="keywordflow">break</span>;
00339                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a8">LUAU_SRC</a>:
00340                         result = <a class="code" href="install_8h.html#a2">luau_install_src</a>(filename, err);
00341                         <span class="keywordflow">break</span>;
00342                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a9">LUAU_EXEC</a>:
00343                         result = <a class="code" href="install_8h.html#a3">luau_install_exec</a>(filename, err);
00344                         <span class="keywordflow">break</span>;
00345                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>:
00346                         result = <a class="code" href="install_8h.html#a4">luau_install_autopkg</a>(filename, err);
00347                         <span class="keywordflow">break</span>;
00348                 <span class="keywordflow">default</span>:
00349                         g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a37">LUAU_BASE_ERROR_INVALID_ARG</a>, <span class="stringliteral">"Invalid packager type qualifier: %d"</span>, type);
00350                         result = FALSE;
00351         }
00352         
00353         <span class="keywordflow">return</span> result;
00354 }
00355 
00364 <span class="comment">/*void</span>
00365 <span class="comment">luau_registerErrorFunc(AErrorFunc errorFunc) {</span>
00366 <span class="comment">        lutil_error_setErrorFunc(errorFunc); // in error.[ch]</span>
00367 <span class="comment">}*/</span>
00368 
00379 <span class="keywordtype">void</span>
<a name="l00380"></a><a class="code" href="libuau_8h.html#a58">00380</a> <a class="code" href="libuau_8h.html#a58">luau_registerPromptFunc</a>(<a class="code" href="libuau_8h.html#a18">APromptFunc</a> promptFunc) {
00381         <a class="code" href="error_8h.html#a5">lutil_error_setPromptFunc</a>(promptFunc);
00382 }
00383 
00394 <span class="keywordtype">void</span>
<a name="l00395"></a><a class="code" href="libuau_8h.html#a59">00395</a> <a class="code" href="libuau_8h.html#a59">luau_registerProgressCallback</a>(<a class="code" href="libuau_8h.html#a22">AProgressCallback</a> callback) {
00396         <a class="code" href="ftp_8h.html#a3">lutil_ftp_setCallbackFunc</a>(callback);
00397 }
00398 
00405 <span class="comment">/*void</span>
00406 <span class="comment">luau_resetErrorFunc(void) {</span>
00407 <span class="comment">        lutil_error_resetErrorFunc();</span>
00408 <span class="comment">}*/</span>
00409 
00416 <span class="keywordtype">void</span>
<a name="l00417"></a><a class="code" href="libuau_8h.html#a60">00417</a> <a class="code" href="libuau_8c.html#a15">luau_resetPromptFunc</a>(<span class="keywordtype">void</span>) {
00418         <a class="code" href="error_8c.html#a4">lutil_error_resetPromptFunc</a>();
00419 }
00420 
00426 <span class="keywordtype">void</span>
<a name="l00427"></a><a class="code" href="libuau_8h.html#a61">00427</a> <a class="code" href="libuau_8c.html#a16">luau_resetProgressCallback</a>(<span class="keywordtype">void</span>) {
00428         <a class="code" href="ftp_8c.html#a5">lutil_ftp_resetCallbackFunc</a>();
00429 }
00430 
00431 
00432 
00433 <span class="comment">/*</span>
00434 <span class="comment"> *  *** UTILITY FUNCTIONS ***</span>
00435 <span class="comment"> */</span>
00436 
00445 <a class="code" href="structAPackage.html">APackage</a> *
<a name="l00446"></a><a class="code" href="libuau_8h.html#a73">00446</a> <a class="code" href="libuau_8h.html#a73">luau_getUpdatePackage</a>(<span class="keyword">const</span> <a class="code" href="structAUpdate.html">AUpdate</a> *update, APkgType pkgType, GError **err) {
00447         GPtrArray *updateArray = update-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>;
00448         <a class="code" href="structAPackage.html">APackage</a> *temp, *result = NULL;
00449         <span class="keywordtype">int</span> i;
00450         
00451         g_return_val_if_fail(err == NULL || *err == NULL, NULL);
00452         
00453         <span class="keywordflow">if</span> (pkgType == <a class="code" href="libuau_8h.html#a5">LUAU_EMPTY</a>)
00454         {
00455                 <span class="keywordflow">if</span> (updateArray-&gt;len == 1)
00456                         <span class="keywordflow">return</span> g_ptr_array_index(updateArray, 0);
00457                 <span class="keywordflow">else</span>
00458                 {
00459                         g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a37">LUAU_BASE_ERROR_INVALID_ARG</a>, <span class="stringliteral">"Must specify package type"</span>);
00460                         <span class="keywordflow">return</span> NULL;
00461                 }
00462         }
00463         
00464         <span class="keywordflow">for</span> (i = 0; i &lt; updateArray-&gt;len; ++i) {
00465                 temp = g_ptr_array_index(updateArray, i);
00466                 <span class="keywordflow">if</span> (temp-&gt;<a class="code" href="structAPackage.html#o0">type</a> == pkgType) {
00467                         result = temp;
00468                         <span class="keywordflow">break</span>;
00469                 }
00470         }
00471         
00472         <span class="keywordflow">if</span> (result == NULL) {
00473                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a37">LUAU_BASE_ERROR_INVALID_ARG</a>, <span class="stringliteral">"No package of type %s in selected update!"</span>, <a class="code" href="libuau_8h.html#a64">luau_packageTypeString</a>(pkgType));
00474                 <span class="keywordflow">return</span> NULL;
00475         } <span class="keywordflow">else</span> {
00476                 <span class="keywordflow">return</span> result;
00477         }
00478 }
00479 
00487 <span class="keywordtype">char</span> *
<a name="l00488"></a><a class="code" href="libuau_8h.html#a62">00488</a> <a class="code" href="libuau_8h.html#a62">luau_dateString</a>(<span class="keyword">const</span> <a class="code" href="structADate.html">ADate</a> *date) {
00489         <span class="comment">/* 2003-04-28 */</span>
00490         <span class="keywordtype">char</span>* string;
00491         <span class="keywordflow">if</span> (date == NULL)
00492                 string = g_strdup(<span class="stringliteral">"(null)"</span>);
00493         <span class="keywordflow">else</span>
00494                 string = <a class="code" href="util_8h.html#a14">lutil_mprintf</a>(<span class="stringliteral">"%.4d-%.2d-%.2d"</span>, date-&gt;<a class="code" href="structADate.html#o2">year</a>, date-&gt;<a class="code" href="structADate.html#o1">month</a>, date-&gt;<a class="code" href="structADate.html#o0">day</a>);
00495         
00496         <span class="keywordflow">return</span> string;
00497 }
00498 
00508 gboolean
<a name="l00509"></a><a class="code" href="libuau_8h.html#a69">00509</a> <a class="code" href="libuau_8h.html#a69">luau_parseDate</a>(<a class="code" href="structADate.html">ADate</a> *date, <span class="keyword">const</span> <span class="keywordtype">char</span> *string) {
00510         <span class="keywordtype">char</span> *ptr1, *ptr2, *dup;
00511         gboolean result;
00512         
00513         <span class="comment">/* Clear date field */</span>
00514         date-&gt;<a class="code" href="structADate.html#o2">year</a> = 0;
00515         date-&gt;<a class="code" href="structADate.html#o1">month</a> = 0;
00516         date-&gt;<a class="code" href="structADate.html#o0">day</a> = 0;
00517         
00518         <span class="keywordflow">if</span> (string == NULL) {
00519                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"NULL pointer passed to luau_parseDate"</span>);
00520                 <span class="keywordflow">return</span> TRUE;
00521         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (string[0] == <span class="charliteral">'\0'</span>) {
00522                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Empty string passed to luau_parseDate"</span>);
00523                 <span class="keywordflow">return</span> TRUE;
00524         }
00525         
00526         <span class="comment">/* Make a duplicate which we can edit as we please */</span>
00527         dup = g_strdup(string);
00528         
00529         <span class="comment">/* Convert all dashes into '\0' and then read in the three</span>
00530 <span class="comment">           strings created into the year, month, and date fields</span>
00531 <span class="comment">           respectively.  We only do some very basic sanity checks</span>
00532 <span class="comment">           here - more might be advisable (eg checking to make sure</span>
00533 <span class="comment">           that there aren't any non-numeric characters, aside from</span>
00534 <span class="comment">           the dashes). */</span>
00535            
00536         result = TRUE;
00537         <span class="keywordflow">do</span> {
00538                 
00539                 ptr1 = dup;
00540                 ptr2 = strchr(ptr1, <span class="charliteral">'-'</span>);
00541                 <span class="keywordflow">if</span> (ptr2 == NULL) {
00542                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Invalid date: no '-' separator found"</span>);
00543                         result = FALSE;
00544                         <span class="keywordflow">break</span>;
00545                 }
00546                 
00547                 *ptr2 = <span class="charliteral">'\0'</span>;
00548                 date-&gt;<a class="code" href="structADate.html#o2">year</a> = atoi(ptr1);
00549                 
00550                 ptr1 = ptr2+1;
00551                 ptr2 = strchr(ptr1, <span class="charliteral">'-'</span>);
00552                 <span class="keywordflow">if</span> (ptr2 == NULL) {
00553                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Invalid date: not enough fields (2 found, 3 needed)"</span>);
00554                         result = FALSE;
00555                         <span class="keywordflow">break</span>;
00556                 }
00557                 
00558                 *ptr2 = <span class="charliteral">'\0'</span>;
00559                 date-&gt;<a class="code" href="structADate.html#o1">month</a> = atoi(ptr1);
00560                 <span class="keywordflow">if</span> (date-&gt;<a class="code" href="structADate.html#o1">month</a> &lt; 1 || date-&gt;<a class="code" href="structADate.html#o1">month</a> &gt; 12)  {
00561                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Invalid date: given month (%d) is out of valid range (1-12)"</span>, date-&gt;<a class="code" href="structADate.html#o1">month</a>);
00562                         result = FALSE;
00563                         <span class="comment">/* we still continue (instead of breaking out here) just because we can, and so</span>
00564 <span class="comment">                           the user can still read in the day argument even if the month is invalid */</span>
00565                 }
00566                 
00567                 ptr1 = ptr2+1;
00568                 date-&gt;<a class="code" href="structADate.html#o0">day</a> = atoi(ptr1);
00569                 <span class="keywordflow">if</span> (date-&gt;<a class="code" href="structADate.html#o0">day</a> &lt; 1 || date-&gt;<a class="code" href="structADate.html#o0">day</a> &gt; 31) {
00570                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Invalid date: given day (%d) is out of valid range (1-31)"</span>, date-&gt;<a class="code" href="structADate.html#o0">day</a>);
00571                         result = FALSE;
00572                         <span class="comment">/* only a basic check: April 31st would still be accepted even though it isn't</span>
00573 <span class="comment">                           a valid date. */</span>
00574                 }
00575                 
00576                 <span class="keywordflow">if</span> (strchr(ptr1, <span class="charliteral">'-'</span>) != NULL) {
00577                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Invalid date: too many fields"</span>);
00578                         result = FALSE;
00579                         <span class="keywordflow">break</span>;
00580                 }
00581         } <span class="keywordflow">while</span> (0);
00582         
00583         g_free(dup);
00584         
00585         <span class="keywordflow">return</span> result;
00586 }
00587 
00598 <span class="keywordtype">int</span>
<a name="l00599"></a><a class="code" href="libuau_8h.html#a76">00599</a> <a class="code" href="libuau_8h.html#a76">luau_datecmp</a>(<a class="code" href="structADate.html">ADate</a> *d1, <a class="code" href="structADate.html">ADate</a> *d2) {
00600         <span class="keywordtype">int</span> result;
00601         
00602         <span class="keywordflow">if</span> (d1 == NULL || d2 == NULL)
00603                 <span class="keywordflow">return</span> 0;
00604         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((result = <a class="code" href="util_8h.html#a30">lutil_intcmp</a>(d1-&gt;<a class="code" href="structADate.html#o2">year</a>, d2-&gt;<a class="code" href="structADate.html#o2">year</a>)) != 0)
00605                 <span class="keywordflow">return</span> result;
00606         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((result = <a class="code" href="util_8h.html#a30">lutil_intcmp</a>(d1-&gt;<a class="code" href="structADate.html#o1">month</a>, d2-&gt;<a class="code" href="structADate.html#o1">month</a>)) != 0)
00607                 <span class="keywordflow">return</span> result;
00608         <span class="keywordflow">else</span>
00609                 <span class="keywordflow">return</span> <a class="code" href="util_8h.html#a30">lutil_intcmp</a>(d1-&gt;<a class="code" href="structADate.html#o0">day</a>, d2-&gt;<a class="code" href="structADate.html#o0">day</a>);
00610 }
00611 
00612 
00613 <span class="comment">/*</span>
00614 <span class="comment"> * compareVersions &lt;REQUIRED&gt; &lt;CURRENT&gt;</span>
00615 <span class="comment"> * REQUIRED: Required version.</span>
00616 <span class="comment"> * CURRENT: Current version.</span>
00617 <span class="comment"> * Returns: 0 if passed, 1 if failed.</span>
00618 <span class="comment"> *</span>
00619 <span class="comment"> * This function compares 2 strings - infinite level of decimal groups.</span>
00620 <span class="comment"> * REQUIRED string for required version; CURRENT string for current version.</span>
00621 <span class="comment"> * Returns 1 if REQUIRED is &gt; CURRENT, else 0. [ 0 - PASS, 1 - FAIL ]</span>
00622 <span class="comment"> *</span>
00623 <span class="comment"> * Parameter string format: "x.y.z", where y and z are optional. Wildcards can</span>
00624 <span class="comment"> * only be used for an entire decimal group like "1.6.x" or "2.x" NOT "2.5x" .</span>
00625 <span class="comment"> * Function looks ahead in the decimal groups with alphabetic and numeric</span>
00626 <span class="comment"> * identifers to match full numbers. For instance REQUIRED:2-RC10f and</span>
00627 <span class="comment"> * CURRENT:2-rc2d, it ends up comparing 10 to 2 and returns 1 [ FAIL ]</span>
00628 <span class="comment"> * instead of 1 to 2 returning 0 [ PASS ].</span>
00629 <span class="comment"> *</span>
00630 <span class="comment"> * Example:</span>
00631 <span class="comment"> *                     Required    Current          Return Value</span>
00632 <span class="comment"> *    compareVersions  "1"         "1.2"       ---&gt;  0 [ PASS ]</span>
00633 <span class="comment"> *    compareVersions  "1.2"       "1"         ---&gt;  1 [ FAIL ]</span>
00634 <span class="comment"> *    compareVersions  "1.1"       "1.2"       ---&gt;  0 [ PASS ]</span>
00635 <span class="comment"> *    compareVersions  "1.3"       "1.2"       ---&gt;  1 [ FAIL ]</span>
00636 <span class="comment"> *    compareVersions  "1.2"       "1.2"       ---&gt;  0 [ PASS ]</span>
00637 <span class="comment"> *    compareVersions  "1.2b"      "1.2b"      ---&gt;  0 [ PASS ]</span>
00638 <span class="comment"> *    compareVersions  "2.5-pre3"  "2.5"       ---&gt;  0 [ PASS ]</span>
00639 <span class="comment"> *    compareVersions  "2.5-pre3"  "2.5-pre2"  ---&gt;  1 [ FAIL ]</span>
00640 <span class="comment"> *    compareVersions  "2-RC10f"   "2-rc2d"    ---&gt;  1 [ FAIL ]</span>
00641 <span class="comment"> *    compareVersions  "3.1-RC3"   "3.1-rc12"  ---&gt;  0 [ PASS ]</span>
00642 <span class="comment"> *    compareVersions  "1.3"       "0.1.5"     ---&gt;  1 [ FAIL ]</span>
00643 <span class="comment"> *    compareVersions  "1.99.6"    "2"         ---&gt;  0 [ PASS ]</span>
00644 <span class="comment"> *    compareVersions  "1.6.x"     "1.6.7"     ---&gt;  0 [ PASS ]</span>
00645 <span class="comment"> *    compareVersions  "1.6.x"     "1.6"       ---&gt;  0 [ PASS ]</span>
00646 <span class="comment"> *    compareVersions  "1.6.x"     "1.5.7"     ---&gt;  1 [ FAIL ]</span>
00647 <span class="comment"> *    compareVersions  "1.x"       "1.5.7"     ---&gt;  0 [ PASS ]</span>
00648 <span class="comment"> */</span>
00649 <span class="comment">/* FIXME - don't reference indices of the GContainer explicitly!  use iterator! */</span>
00650 <span class="keywordtype">int</span>
<a name="l00651"></a><a class="code" href="libuau_8h.html#a77">00651</a> <a class="code" href="libuau_8h.html#a77">luau_versioncmp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *required, <span class="keyword">const</span> <span class="keywordtype">char</span> *current) {
00652         <a class="code" href="structGContainer.html">GContainer</a> *reqElements, *curElements;
00653         <span class="keywordtype">char</span> *req, *cur;
00654         <span class="keywordtype">int</span> max, i, len, result, x, y;
00655         
00656         result = 0;
00657         
00658         req = g_strdup(required);
00659         cur = g_strdup(current);
00660         
00661         <a class="code" href="util_8h.html#a21">lutil_strToLower</a>(req);
00662         <a class="code" href="util_8h.html#a21">lutil_strToLower</a>(cur);
00663         
00664         <span class="comment">/* replace all '-' '_' '/' '+' with '.' to index for arrays */</span>
00665         len = strlen(req);
00666         <span class="keywordflow">for</span> (i = 0; i &lt; len; ++i) {
00667                 <span class="keywordflow">if</span> (req[i] == <span class="charliteral">'-'</span> || req[i] == <span class="charliteral">'_'</span> || req[i] == <span class="charliteral">'/'</span> || req[i] == <span class="charliteral">'+'</span> || req[i] == <span class="charliteral">'\\'</span>)
00668                                 req[i] = <span class="charliteral">'.'</span>;
00669         }
00670         
00671         len = strlen(cur);
00672         <span class="keywordflow">for</span> (i = 0; i &lt; len; ++i) {
00673                 <span class="keywordflow">if</span> (cur[i] == <span class="charliteral">'-'</span> || cur[i] == <span class="charliteral">'_'</span> || cur[i] == <span class="charliteral">'/'</span> || cur[i] == <span class="charliteral">'+'</span> || cur[i] == <span class="charliteral">'\\'</span>)
00674                                 cur[i] = <span class="charliteral">'.'</span>;
00675         }
00676         
00677         <span class="comment">/* create arrays from parameters */</span>
00678         reqElements = <a class="code" href="util_8h.html#a16">lutil_gsplit</a>(<span class="stringliteral">"."</span>, req);
00679         curElements = <a class="code" href="util_8h.html#a16">lutil_gsplit</a>(<span class="stringliteral">"."</span>, cur);
00680         
00681         g_free(req);
00682         g_free(cur);
00683         
00684         <span class="comment">/* obtain maximum count of elements from either array */</span>
00685         <span class="keywordflow">if</span> (reqElements-&gt;<a class="code" href="structGContainer.html#o1">len</a> &gt; curElements-&gt;<a class="code" href="structGContainer.html#o1">len</a>)
00686                 max = reqElements-&gt;<a class="code" href="structGContainer.html#o1">len</a>;
00687         <span class="keywordflow">else</span>
00688                 max = curElements-&gt;<a class="code" href="structGContainer.html#o1">len</a>;
00689 
00690         <span class="keywordflow">for</span> (i = 0; i &lt; max; ++i) {
00691                 <span class="comment">/* process each respective decimal group ...</span>
00692 <span class="comment">                 * if alphanumeric group then extend the compare to compareAlphaNumeric, otherwise do integer comparisons */</span>
00693                 
00694                 req = (i &lt; reqElements-&gt;<a class="code" href="structGContainer.html#o1">len</a>) ? <a class="code" href="gcontainer_8h.html#a12">g_container_index</a>(reqElements, i) : NULL;
00695                 cur = (i &lt; curElements-&gt;<a class="code" href="structGContainer.html#o1">len</a>) ? <a class="code" href="gcontainer_8h.html#a12">g_container_index</a>(curElements, i) : NULL;
00696                 
00697                 <span class="comment">/* special case: if wildcard in either decimal group then they are "equal" */</span>
00698                 <span class="keywordflow">if</span> ((req != NULL &amp;&amp; <a class="code" href="util_8h.html#a10">lutil_streq</a>(req, <span class="stringliteral">"x"</span>)) || (cur != NULL &amp;&amp; <a class="code" href="util_8h.html#a10">lutil_streq</a>(cur, <span class="stringliteral">"x"</span>))) {
00699                         result = 0;
00700                         <span class="keywordflow">break</span>;
00701                 }
00702                 
00703                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a23">lutil_containsAlpha</a>(cur) || <a class="code" href="util_8h.html#a23">lutil_containsAlpha</a>(req)) {
00704                         result = <a class="code" href="libuau_8c.html#a0">compareAlphaNumeric</a>(req, cur);
00705                         
00706                         <span class="keywordflow">if</span> (result != 0)
00707                                 <span class="keywordflow">break</span>;
00708                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (req == NULL) {
00709                         result = -1;
00710                         <span class="keywordflow">break</span>;
00711                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cur == NULL) {
00712                         result = 1;
00713                         <span class="keywordflow">break</span>;
00714                 } <span class="keywordflow">else</span> {
00715                         x = atoi(req);
00716                         y = atoi(cur);
00717                         
00718                         <span class="keywordflow">if</span> (x != y) {
00719                                 result = (x &lt; y) ? -1 : 1;
00720                                 <span class="keywordflow">break</span>;
00721                         }
00722                 }
00723         }
00724         
00725         <a class="code" href="gcontainer_8h.html#a23">g_container_destroy</a>(reqElements);
00726         <a class="code" href="gcontainer_8h.html#a23">g_container_destroy</a>(curElements);
00727         
00728         <span class="keywordflow">return</span> result;
00729 }
00730 
00738 gboolean
<a name="l00739"></a><a class="code" href="libuau_8h.html#a74">00739</a> <a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(APkgType query, APkgType type) {
00740   <span class="keywordflow">return</span> ( (query &amp; type) == 0 ? FALSE : TRUE);
00741 }
00742 
00752 <span class="keywordtype">char</span> *
<a name="l00753"></a><a class="code" href="libuau_8h.html#a63">00753</a> <a class="code" href="libuau_8h.html#a63">luau_multPackageTypeString</a>(APkgType types) {
00754         <span class="keywordtype">char</span> *str = <a class="code" href="util_8h.html#a12">lutil_createString</a>(25);
00755         <span class="keywordtype">int</span> n;
00756         
00757         str[0] = <span class="charliteral">'\0'</span>;
00758         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a6">LUAU_RPM</a>))
00759                 strcat(str, <span class="stringliteral">"RPM "</span>);
00760         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a7">LUAU_DEB</a>))
00761                 strcat(str, <span class="stringliteral">"DEB "</span>);
00762         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a8">LUAU_SRC</a>))
00763                 strcat(str, <span class="stringliteral">"SRC "</span>);
00764         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a9">LUAU_EXEC</a>))
00765                 strcat(str, <span class="stringliteral">"EXEC "</span>);
00766         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>))
00767                 strcat(str, <span class="stringliteral">"AUTOPKG "</span>);
00768         
00769         <span class="keywordflow">if</span> ((n = strlen(str)) != 0) {
00770                 str[n-1] = <span class="charliteral">'\0'</span>; <span class="comment">/* Cut off trailing white space */</span>
00771         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (types == <a class="code" href="libuau_8h.html#a5">LUAU_EMPTY</a>) {
00772                 strcpy(str, <span class="stringliteral">"(none)"</span>);
00773         } <span class="keywordflow">else</span> {
00774                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Unrecognized package type: %d"</span>, types);
00775                 strcpy(str, <span class="stringliteral">"UNKNOWN"</span>);
00776         }
00777         
00778         <span class="keywordflow">return</span> str;
00779 }
00780 
00790 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00791"></a><a class="code" href="libuau_8h.html#a64">00791</a> <a class="code" href="libuau_8h.html#a64">luau_packageTypeString</a>(APkgType type) {
00792         <span class="keyword">const</span> <span class="keywordtype">char</span> *str = NULL;
00793         
00794         <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a6">LUAU_RPM</a>)
00795                 str = <span class="stringliteral">"RPM"</span>;
00796         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a7">LUAU_DEB</a>)
00797                 str = <span class="stringliteral">"DEB"</span>;
00798         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a8">LUAU_SRC</a>)
00799                 str = <span class="stringliteral">"SRC"</span>;
00800         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a9">LUAU_EXEC</a>)
00801                 str = <span class="stringliteral">"EXEC"</span>;
00802         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>)
00803                 str = <span class="stringliteral">"AUTOPKG"</span>;
00804         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a5">LUAU_EMPTY</a>)
00805                 str = <span class="stringliteral">"(none)"</span>;
00806         <span class="keywordflow">else</span>
00807                 str = <span class="stringliteral">"UNKNOWN"</span>;
00808         
00809         <span class="keywordflow">return</span> str;
00810 }
00811 
00821 <a class="code" href="libuau_8h.html#a17">APkgType</a>
<a name="l00822"></a><a class="code" href="libuau_8h.html#a70">00822</a> <a class="code" href="libuau_8h.html#a70">luau_parsePkgType</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* typeString) {
00823         <a class="code" href="libuau_8h.html#a17">APkgType</a> type = <a class="code" href="libuau_8h.html#a11">LUAU_UNKNOWN</a>;
00824         <span class="keywordflow">if</span>      (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(typeString, <span class="stringliteral">"RPM"</span>)) type = <a class="code" href="libuau_8h.html#a6">LUAU_RPM</a>;
00825         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(typeString, <span class="stringliteral">"DEB"</span>)) type = <a class="code" href="libuau_8h.html#a7">LUAU_DEB</a>;
00826         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(typeString, <span class="stringliteral">"SRC"</span>)) type = <a class="code" href="libuau_8h.html#a8">LUAU_SRC</a>;
00827         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(typeString, <span class="stringliteral">"EXEC"</span>)) type = <a class="code" href="libuau_8h.html#a9">LUAU_EXEC</a>;
00828         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(typeString, <span class="stringliteral">"autopackage"</span>)) type = <a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>;
00829         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(typeString, <span class="stringliteral">"AUTOPKG"</span>)) type = <a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>;
00830         <span class="keywordflow">return</span> type;
00831 }
00832 
00833 <span class="keywordtype">char</span> *
<a name="l00834"></a><a class="code" href="libuau_8h.html#a75">00834</a> <a class="code" href="libuau_8h.html#a75">luau_getPackageURL</a>(<a class="code" href="structAPackage.html">APackage</a> *pkgInfo, GError **err) {
00835         GPtrArray *mirrors = pkgInfo-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>;
00836         <span class="keywordtype">char</span> *loc = NULL;
00837         <span class="keywordtype">int</span> percentage, random, i;
00838         
00839         g_return_val_if_fail(err == NULL || *err == NULL, NULL);
00840 
00841 <span class="preprocessor">#ifdef DEBUG</span>
00842 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; mirrors-&gt;len; i += 2)
00843                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"URL: %s; weight: %d\n"</span>, (<span class="keywordtype">char</span>*)g_ptr_array_index(mirrors, i+1), GPOINTER_TO_INT (g_ptr_array_index(mirrors, i)));
00844 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
00845         
00846         <span class="keywordflow">if</span> (mirrors == NULL || mirrors-&gt;len == 0) {
00847                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a37">LUAU_BASE_ERROR_INVALID_ARG</a>, <span class="stringliteral">"Cannot retrieve package URL: none available in supplied argument"</span>);
00848                 <span class="keywordflow">return</span> NULL;
00849         }
00850         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mirrors-&gt;len == 2)
00851                 <span class="keywordflow">return</span> g_ptr_array_index(mirrors, 1);
00852         
00853         random = rand() % 100; <span class="comment">/* integer between 0 and 100 */</span>
00854         
00855         <span class="keywordflow">for</span> (i = 0; i &lt; mirrors-&gt;len; i+=2) {
00856                 percentage = GPOINTER_TO_INT( g_ptr_array_index(mirrors, i) );
00857                 <span class="keywordflow">if</span> (random &lt;= percentage) {
00858                         loc = g_ptr_array_index(mirrors, i+1);
00859                         <span class="keywordflow">break</span>;
00860                 } <span class="keywordflow">else</span> {
00861                         random -= percentage;
00862                 }
00863         }
00864         
00865         <span class="keywordflow">if</span> (loc == NULL &amp;&amp; mirrors-&gt;len &gt;= 2)
00866                 loc = g_ptr_array_index(mirrors, 1);
00867         
00868         <span class="keywordflow">return</span> loc;
00869 }
00870 
00878 GSList *
<a name="l00879"></a><a class="code" href="libuau_8h.html#a72">00879</a> <a class="code" href="libuau_8h.html#a72">luau_packageTypeList</a>(APkgType types) {
00880         GSList *list = NULL;
00881         
00882         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a6">LUAU_RPM</a>))
00883                 list = g_slist_append(list, GINT_TO_POINTER (<a class="code" href="libuau_8h.html#a6">LUAU_RPM</a>));
00884         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a7">LUAU_DEB</a>))
00885                 list = g_slist_append(list, GINT_TO_POINTER (<a class="code" href="libuau_8h.html#a7">LUAU_DEB</a>));
00886         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a8">LUAU_SRC</a>))
00887                 list = g_slist_append(list, GINT_TO_POINTER (<a class="code" href="libuau_8h.html#a8">LUAU_SRC</a>));
00888         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a9">LUAU_EXEC</a>))
00889                 list = g_slist_append(list, GINT_TO_POINTER (<a class="code" href="libuau_8h.html#a9">LUAU_EXEC</a>));
00890         <span class="keywordflow">if</span> (<a class="code" href="libuau_8h.html#a74">luau_isOfType</a>(types, <a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>))
00891                 list = g_slist_append(list, GINT_TO_POINTER (<a class="code" href="libuau_8h.html#a10">LUAU_AUTOPKG</a>));
00892         
00893         <span class="keywordflow">return</span> list;
00894 }
00895 
00903 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00904"></a><a class="code" href="libuau_8h.html#a68">00904</a> <a class="code" href="libuau_8h.html#a68">luau_updateTypeString</a>(AUpdateType type) {
00905         <span class="keywordflow">switch</span> (type) {
00906                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a99a23">LUAU_SOFTWARE</a>: <span class="keywordflow">return</span> <span class="stringliteral">"Software"</span>;
00907                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a99a24">LUAU_MESSAGE</a>: <span class="keywordflow">return</span> <span class="stringliteral">"Message"</span>;
00908                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a99a25">LUAU_LIBUPDATE</a>: <span class="keywordflow">return</span> <span class="stringliteral">"Luau Config"</span>;
00909                 <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <span class="stringliteral">"UNKNOWN"</span>;
00910         }
00911 }
00912 
00919 <span class="keywordtype">char</span> *
<a name="l00920"></a><a class="code" href="libuau_8h.html#a65">00920</a> <a class="code" href="libuau_8h.html#a65">luau_progInfoString</a>(<span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *info) {
00921         <span class="keywordtype">char</span> *str, *keywordsStr, *dateStr;
00922         
00923         keywordsStr = <a class="code" href="libuau_8h.html#a66">luau_keywordsString</a>(info-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>);
00924         dateStr = <a class="code" href="libuau_8h.html#a62">luau_dateString</a>(info-&gt;<a class="code" href="structAProgInfo.html#o7">date</a>);
00925         str = <a class="code" href="util_8h.html#a14">lutil_mprintf</a>(<span class="stringliteral">"{ ID =&gt; %s,\n  Name =&gt; %s,\n  Desc =&gt; %s,\n  URL =&gt; %s,\n  Version =&gt; %s,\n Date =&gt; %s,\n Keywords =&gt; %s\n}"</span>,
00926                              info-&gt;<a class="code" href="structAProgInfo.html#o0">id</a>, info-&gt;<a class="code" href="structAProgInfo.html#o2">fullname</a>, info-&gt;<a class="code" href="structAProgInfo.html#o3">desc</a>, info-&gt;<a class="code" href="structAProgInfo.html#o4">url</a>, info-&gt;<a class="code" href="structAProgInfo.html#o5">version</a>, dateStr, keywordsStr);
00927         
00928         g_free(keywordsStr);
00929         g_free(dateStr);
00930         
00931         <span class="keywordflow">return</span> str;
00932 }
00933 
00941 <span class="keywordtype">char</span> *
<a name="l00942"></a><a class="code" href="libuau_8h.html#a66">00942</a> <a class="code" href="libuau_8h.html#a66">luau_keywordsString</a>(<span class="keyword">const</span> GPtrArray *keywords) {
00943         <a class="code" href="structGContainer.html">GContainer</a> *keyCont;
00944         <span class="keywordtype">char</span> *str;
00945         
00946         <span class="keywordflow">if</span> (keywords == NULL)
00947                 str = g_strdup(<span class="stringliteral">""</span>);
00948         <span class="keywordflow">else</span> {
00949                 keyCont = <a class="code" href="gcontainer_8h.html#a4">g_container_new_from_data</a>(<a class="code" href="gcontainer_8h.html#a25a0">GCONT_PTR_ARRAY</a>, (<span class="keywordtype">void</span>*)keywords);
00950                 str = <a class="code" href="util_8h.html#a15">lutil_strjoin</a>(<span class="stringliteral">", "</span>, keyCont);
00951                 <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(keyCont, FALSE);
00952         }
00953         
00954         <span class="keywordflow">return</span> str;
00955 }
00956 
00963 <span class="keywordtype">void</span>
<a name="l00964"></a><a class="code" href="libuau_8h.html#a78">00964</a> <a class="code" href="libuau_8h.html#a78">luau_setKeyword</a>(GPtrArray *keywords, <span class="keyword">const</span> <span class="keywordtype">char</span> *newKeyword) {
00965         <span class="keywordflow">if</span> (keywords != NULL &amp;&amp; newKeyword != NULL)
00966                 g_ptr_array_add(keywords, g_strdup(newKeyword));
00967 }
00968 
00977 gboolean
<a name="l00978"></a><a class="code" href="libuau_8h.html#a79">00978</a> <a class="code" href="libuau_8h.html#a79">luau_unsetKeyword</a>(GPtrArray *keywords, <span class="keyword">const</span> <span class="keywordtype">char</span> *oldKeyword) {
00979         <span class="keywordtype">int</span> i;
00980         gboolean found = FALSE;
00981         <span class="keywordtype">char</span> *curr;
00982         
00983         <span class="keywordflow">for</span> (i = 0; i &lt; keywords-&gt;len; ++i) {
00984                 curr = g_ptr_array_index(keywords, i);
00985                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(curr, oldKeyword)) {
00986                         found = TRUE;
00987                         g_ptr_array_remove_index_fast(keywords, i);
00988                         <span class="keywordflow">break</span>;
00989                 }
00990         }
00991         
00992         <span class="keywordflow">return</span> found;
00993 }
00994 
01002 gboolean
<a name="l01003"></a><a class="code" href="libuau_8h.html#a80">01003</a> <a class="code" href="libuau_8h.html#a80">luau_checkKeyword</a>(<span class="keyword">const</span> GPtrArray *keywords, <span class="keyword">const</span> <span class="keywordtype">char</span> *needle) {
01004         <a class="code" href="structGContainer.html">GContainer</a> *cont;
01005         gboolean result;
01006         
01007         <span class="keywordflow">if</span> (keywords != NULL &amp;&amp; needle != NULL) {
01008                 cont = <a class="code" href="gcontainer_8h.html#a4">g_container_new_from_data</a>(<a class="code" href="gcontainer_8h.html#a25a0">GCONT_PTR_ARRAY</a>, (<span class="keywordtype">void</span>*)keywords);
01009                 result = <a class="code" href="util_8h.html#a18">lutil_findString</a>(cont, needle);
01010                 <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(cont, FALSE);
01011         }
01012         <span class="keywordflow">else</span>
01013                 result = FALSE;
01014         
01015         <span class="keywordflow">return</span> result;
01016 }
01017 
01024 gboolean
<a name="l01025"></a><a class="code" href="libuau_8h.html#a81">01025</a> <a class="code" href="libuau_8h.html#a81">luau_isIncompatible</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update) {
01026         <span class="keywordflow">if</span> (update != NULL &amp;&amp; update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> != NULL)
01027                 <span class="keywordflow">return</span> <a class="code" href="libuau_8h.html#a80">luau_checkKeyword</a>(update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, <span class="stringliteral">"_incompatible"</span>);
01028         <span class="keywordflow">else</span>
01029                 <span class="keywordflow">return</span> FALSE;
01030 }
01031 
01038 gboolean
<a name="l01039"></a><a class="code" href="libuau_8h.html#a82">01039</a> <a class="code" href="libuau_8h.html#a82">luau_isHidden</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update) {
01040         <span class="keywordflow">if</span> (update != NULL &amp;&amp; update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> != NULL)
01041                 <span class="keywordflow">return</span> <a class="code" href="libuau_8h.html#a80">luau_checkKeyword</a>(update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, <span class="stringliteral">"_hidden"</span>);
01042         <span class="keywordflow">else</span>
01043                 <span class="keywordflow">return</span> FALSE;
01044 }
01045 
01046 gboolean
<a name="l01047"></a><a class="code" href="libuau_8h.html#a83">01047</a> <a class="code" href="libuau_8h.html#a83">luau_isOld</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update) {
01048         <span class="keywordflow">if</span> (update != NULL &amp;&amp; update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> != NULL)
01049                 <span class="keywordflow">return</span> <a class="code" href="libuau_8h.html#a80">luau_checkKeyword</a>(update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, <span class="stringliteral">"_old"</span>);
01050         <span class="keywordflow">else</span>
01051                 <span class="keywordflow">return</span> FALSE;
01052 }
01053 
01054 gboolean
<a name="l01055"></a><a class="code" href="libuau_8h.html#a84">01055</a> <a class="code" href="libuau_8h.html#a84">luau_isVisible</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update) {
01056         <span class="keywordflow">return</span> !(<a class="code" href="libuau_8h.html#a83">luau_isOld</a>(update) || <a class="code" href="libuau_8h.html#a82">luau_isHidden</a>(update) || <a class="code" href="libuau_8h.html#a81">luau_isIncompatible</a>(update));
01057 }
01058 
01071 gboolean
<a name="l01072"></a><a class="code" href="libuau_8h.html#a85">01072</a> <a class="code" href="libuau_8h.html#a85">luau_satisfiesInterface</a>(<span class="keyword">const</span> <a class="code" href="structAInterface.html">AInterface</a> *wanted, <span class="keyword">const</span> <a class="code" href="structAInterface.html">AInterface</a> *needed) {
01073         <span class="keywordflow">return</span> ((wanted-&gt;<a class="code" href="structAInterface.html#o0">major</a> == needed-&gt;<a class="code" href="structAInterface.html#o0">major</a>) &amp;&amp; (wanted-&gt;<a class="code" href="structAInterface.html#o1">minor</a> &gt;= needed-&gt;<a class="code" href="structAInterface.html#o1">minor</a>));
01074 }
01075 
01076 gboolean
<a name="l01077"></a><a class="code" href="libuau_8h.html#a86">01077</a> <a class="code" href="libuau_8h.html#a86">luau_satisfiesQuant</a>(<span class="keyword">const</span> <a class="code" href="structAQuantifier.html">AQuantifier</a> *needed, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *installed) {
01078         gboolean result;
01079         <span class="keywordtype">int</span> compare;
01080         
01081         <span class="comment">/* Note that if one of the quantifiers is invalid (anywhere you see an "ERROR" call here), we</span>
01082 <span class="comment">           return TRUE - in essense, we ignore that the quantifier even exists by saying that any</span>
01083 <span class="comment">           program version satisfies it */</span>
01084         
01085         <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> == <a class="code" href="libuau_8h.html#a101a31">LUAU_QUANT_DATA_INTERFACE</a>) {
01086                 <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> == <a class="code" href="libuau_8h.html#a100a28">LUAU_QUANT_FOR</a>)
01087                         result = <a class="code" href="libuau_8h.html#a85">luau_satisfiesInterface</a>(&amp;(installed-&gt;<a class="code" href="structAProgInfo.html#o8">interface</a>), (<a class="code" href="structAInterface.html">AInterface</a>*) needed-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01088                 <span class="keywordflow">else</span> {
01089                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Interface quantifiers can only be of type 'for', not of 'from' or 'to'"</span>);
01090                         result = TRUE;
01091                 }
01092         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> == <a class="code" href="libuau_8h.html#a101a32">LUAU_QUANT_DATA_KEYWORD</a>) {
01093                 <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> == <a class="code" href="libuau_8h.html#a100a28">LUAU_QUANT_FOR</a>)
01094                         result = <a class="code" href="libuau_8h.html#a80">luau_checkKeyword</a>(installed-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>, (<span class="keywordtype">char</span>*)needed-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01095                 <span class="keywordflow">else</span> {
01096                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Keyword quantifiers can only be of type 'for', not of 'from' or 'to'"</span>);
01097                         result = TRUE;
01098                 }
01099         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> == <a class="code" href="libuau_8h.html#a101a29">LUAU_QUANT_DATA_DATE</a> || needed-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> == <a class="code" href="libuau_8h.html#a101a30">LUAU_QUANT_DATA_VERSION</a>) {
01100                 <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> == <a class="code" href="libuau_8h.html#a101a29">LUAU_QUANT_DATA_DATE</a>)
01101                         compare = <a class="code" href="libuau_8h.html#a76">luau_datecmp</a>(installed-&gt;<a class="code" href="structAProgInfo.html#o7">date</a>, (<a class="code" href="structADate.html">ADate</a>*) needed-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01102                 <span class="keywordflow">else</span> <span class="comment">/* needed-&gt;dtype == LUAU_QUANT_DATA_VERSION */</span>
01103                         compare = <a class="code" href="libuau_8h.html#a77">luau_versioncmp</a>(installed-&gt;<a class="code" href="structAProgInfo.html#o5">version</a>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *) needed-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01104                 
01105                 <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> == <a class="code" href="libuau_8h.html#a100a28">LUAU_QUANT_FOR</a>)
01106                         result = (compare == 0);
01107                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> == <a class="code" href="libuau_8h.html#a100a26">LUAU_QUANT_FROM</a>)
01108                         result = (compare != -1); <span class="comment">/* Inclusive */</span>
01109                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (needed-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> == <a class="code" href="libuau_8h.html#a100a27">LUAU_QUANT_TO</a>)
01110                         result = (compare == -1); <span class="comment">/* Exclusive */</span>
01111                 <span class="keywordflow">else</span> {
01112                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Internal Error: Unrecognized quantifier type (%d)"</span>, needed-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a>);
01113                         result = TRUE;
01114                 }
01115         } <span class="keywordflow">else</span> {
01116                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Internal Error: Unrecognized quantifier data type (%d)"</span>, needed-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a>);
01117                 result = TRUE;
01118         }
01119         
01120         <span class="keywordflow">return</span> result;
01121 }
01122 
01123 <a class="code" href="libuau_8h.html#a101">AQuantDataType</a>
<a name="l01124"></a><a class="code" href="libuau_8h.html#a87">01124</a> <a class="code" href="libuau_8h.html#a87">luau_parseQuantDataType</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str) {
01125         <a class="code" href="libuau_8h.html#a101">AQuantDataType</a> type;
01126         
01127         <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(str, <span class="stringliteral">"version"</span>))
01128                 type = <a class="code" href="libuau_8h.html#a101a30">LUAU_QUANT_DATA_VERSION</a>;
01129         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(str, <span class="stringliteral">"interface"</span>))
01130                 type = <a class="code" href="libuau_8h.html#a101a31">LUAU_QUANT_DATA_INTERFACE</a>;
01131         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(str, <span class="stringliteral">"date"</span>))
01132                 type = <a class="code" href="libuau_8h.html#a101a29">LUAU_QUANT_DATA_DATE</a>;
01133         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a11">lutil_strcaseeq</a>(str, <span class="stringliteral">"keyword"</span>))
01134                 type = <a class="code" href="libuau_8h.html#a101a32">LUAU_QUANT_DATA_KEYWORD</a>;
01135         <span class="keywordflow">else</span>
01136                 type = <a class="code" href="libuau_8h.html#a101a33">LUAU_QUANT_DATA_INVALID</a>;
01137         
01138         <span class="keywordflow">return</span> type;
01139 }
01140 
01151 gboolean
<a name="l01152"></a><a class="code" href="libuau_8h.html#a71">01152</a> <a class="code" href="libuau_8h.html#a71">luau_parseInterface</a>(<a class="code" href="structAInterface.html">AInterface</a> *interface, <span class="keyword">const</span> <span class="keywordtype">char</span> *intStr) {
01153         gboolean result = FALSE;
01154         <span class="keywordtype">int</span> ret = 0;
01155         
01156         interface-&gt;<a class="code" href="structAInterface.html#o0">major</a> = -1;
01157         interface-&gt;<a class="code" href="structAInterface.html#o1">minor</a> = -1;
01158 
01159         <span class="keywordflow">if</span> (intStr != NULL) {
01160                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a20">lutil_isCompletelyBlank</a>(intStr))
01161                         result = TRUE;
01162                 <span class="keywordflow">else</span> {
01163                         ret = sscanf(intStr, <span class="stringliteral">"%d.%d"</span>, &amp;(interface-&gt;<a class="code" href="structAInterface.html#o0">major</a>), &amp;(interface-&gt;<a class="code" href="structAInterface.html#o1">minor</a>));
01164                         result = (ret == 2);
01165                 }
01166         }
01167         
01168         <span class="keywordflow">return</span> result;
01169 }
01170 
01179 <span class="keywordtype">char</span> *
<a name="l01180"></a><a class="code" href="libuau_8h.html#a67">01180</a> <a class="code" href="libuau_8h.html#a67">luau_interfaceString</a>(<span class="keyword">const</span> <a class="code" href="structAInterface.html">AInterface</a> *interface) {
01181         <span class="keywordtype">char</span> *ret;
01182         
01183         <span class="keywordflow">if</span> (interface-&gt;<a class="code" href="structAInterface.html#o0">major</a> == -1 &amp;&amp; interface-&gt;<a class="code" href="structAInterface.html#o1">minor</a> == -1)
01184                 ret = g_strdup(<span class="stringliteral">""</span>);
01185         <span class="keywordflow">else</span>
01186                 ret = <a class="code" href="util_8h.html#a14">lutil_mprintf</a>(<span class="stringliteral">"%d.%d"</span>, interface-&gt;<a class="code" href="structAInterface.html#o0">major</a>, interface-&gt;<a class="code" href="structAInterface.html#o1">minor</a>);
01187         
01188         <span class="keywordflow">return</span> ret;
01189 }
01190 
01191 
01192 <span class="comment">/* Structure copying */</span>
01193 
01200 <span class="keywordtype">void</span>
<a name="l01201"></a><a class="code" href="libuau_8h.html#a88">01201</a> <a class="code" href="libuau_8h.html#a88">luau_copyUpdate</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *dest, <span class="keyword">const</span> <a class="code" href="structAUpdate.html">AUpdate</a> *src) {
01202         <a class="code" href="structAPackage.html">APackage</a> *destPkg, *srcPkg;
01203         <span class="keywordtype">int</span> i;
01204         
01205         <span class="keywordflow">if</span> (dest == NULL || src == NULL) {
01206                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Null pointer passed to luau_copyUpdate"</span>);
01207         } <span class="keywordflow">else</span> {
01208                 <span class="comment">/* Note that g_strdup(NULL) == NULL, as desired for this code block */</span>
01209                 dest-&gt;<a class="code" href="structAUpdate.html#o0">id</a> = g_strdup(src-&gt;<a class="code" href="structAUpdate.html#o0">id</a>);
01210                 dest-&gt;<a class="code" href="structAUpdate.html#o4">shortDesc</a> = g_strdup(src-&gt;<a class="code" href="structAUpdate.html#o4">shortDesc</a>);
01211                 dest-&gt;<a class="code" href="structAUpdate.html#o5">fullDesc</a> = g_strdup(src-&gt;<a class="code" href="structAUpdate.html#o5">fullDesc</a>);
01212                 dest-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a> = g_strdup(src-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a>);
01213                 dest-&gt;<a class="code" href="structAUpdate.html#o12">newURL</a> = g_strdup(src-&gt;<a class="code" href="structAUpdate.html#o12">newURL</a>);
01214                 
01215                 dest-&gt;<a class="code" href="structAUpdate.html#o2">type</a> = src-&gt;<a class="code" href="structAUpdate.html#o2">type</a>;
01216                 dest-&gt;<a class="code" href="structAUpdate.html#o7">availableFormats</a> = src-&gt;<a class="code" href="structAUpdate.html#o7">availableFormats</a>;
01217                 <a class="code" href="libuau_8h.html#a91">luau_copyInterface</a>(&amp;(dest-&gt;<a class="code" href="structAUpdate.html#o11">interface</a>), &amp;(src-&gt;<a class="code" href="structAUpdate.html#o11">interface</a>));
01218                 
01219                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> != NULL) {
01220                         <a class="code" href="structGContainer.html">GContainer</a> *destCont, *srcCont;
01221 
01222                         dest-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> = g_ptr_array_new();
01223                         destCont = <a class="code" href="gcontainer_8h.html#a4">g_container_new_from_data</a>(<a class="code" href="gcontainer_8h.html#a25a0">GCONT_PTR_ARRAY</a>, dest-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>);
01224                         srcCont = <a class="code" href="gcontainer_8h.html#a4">g_container_new_from_data</a>(<a class="code" href="gcontainer_8h.html#a25a0">GCONT_PTR_ARRAY</a>, src-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>);
01225                         <a class="code" href="gcontainer_8h.html#a21">g_container_copy</a>(destCont, srcCont);
01226                         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(srcCont, FALSE);
01227                         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(destCont, FALSE);
01228                 } <span class="keywordflow">else</span> {
01229                         dest-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> = NULL;
01230                 }
01231                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAUpdate.html#o8">packages</a> != NULL) {
01232                         dest-&gt;<a class="code" href="structAUpdate.html#o8">packages</a> = g_ptr_array_new();
01233                         <span class="keywordflow">for</span> (i = 0; i &lt; src-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>-&gt;len; ++i) {
01234                                 srcPkg = g_ptr_array_index(src-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>, i);
01235                                 destPkg = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAPackage.html">APackage</a>));
01236                                 
01237                                 <a class="code" href="libuau_8h.html#a89">luau_copyPackage</a>(destPkg, srcPkg);
01238                                 g_ptr_array_add(dest-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>, destPkg);
01239                         }
01240                 } <span class="keywordflow">else</span> {
01241                         dest-&gt;<a class="code" href="structAUpdate.html#o8">packages</a> = NULL;
01242                 }
01243                 
01244                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAUpdate.html#o3">date</a> != NULL) {
01245                         dest-&gt;<a class="code" href="structAUpdate.html#o3">date</a> = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structADate.html">ADate</a>));
01246                         <a class="code" href="libuau_8h.html#a92">luau_copyDate</a>(dest-&gt;<a class="code" href="structAUpdate.html#o3">date</a>, src-&gt;<a class="code" href="structAUpdate.html#o3">date</a>);
01247                 } <span class="keywordflow">else</span> {
01248                         dest-&gt;<a class="code" href="structAUpdate.html#o3">date</a> = NULL;
01249                 }
01250                 
01251                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> != NULL) {
01252                         dest-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> = g_ptr_array_new();
01253                         <a class="code" href="libuau_8h.html#a93">luau_copyQuants</a>(dest-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, src-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>);
01254                 } <span class="keywordflow">else</span> {
01255                         dest-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> = NULL;
01256                 }
01257                 
01258                 <span class="comment">/*if (src-&gt;newDate != NULL) {</span>
01259 <span class="comment">                        dest-&gt;newDate = g_malloc(sizeof(ADate));</span>
01260 <span class="comment">                        luau_copyDate(dest-&gt;newDate, src-&gt;newDate);</span>
01261 <span class="comment">                } else {</span>
01262 <span class="comment">                        dest-&gt;newDate = NULL;</span>
01263 <span class="comment">                }*/</span>
01264         }
01265 }
01266 
01267 <span class="keywordtype">void</span>
<a name="l01268"></a><a class="code" href="libuau_8h.html#a89">01268</a> <a class="code" href="libuau_8h.html#a89">luau_copyPackage</a>(<a class="code" href="structAPackage.html">APackage</a> *dest, <span class="keyword">const</span> <a class="code" href="structAPackage.html">APackage</a> *src) {
01269         <span class="keywordtype">int</span> i, curr;
01270         <span class="keywordflow">if</span> (dest == NULL || src == NULL) {
01271                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Null pointer passed to luau_copyPackage"</span>);
01272         } <span class="keywordflow">else</span> {
01273                 dest-&gt;<a class="code" href="structAPackage.html#o0">type</a> = src-&gt;<a class="code" href="structAPackage.html#o0">type</a>;
01274                 dest-&gt;<a class="code" href="structAPackage.html#o4">size</a> = src-&gt;<a class="code" href="structAPackage.html#o4">size</a>;
01275                 strncpy(dest-&gt;<a class="code" href="structAPackage.html#o2">md5sum</a>, src-&gt;<a class="code" href="structAPackage.html#o2">md5sum</a>, 33);
01276                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a> != NULL) {
01277                         dest-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a> = g_ptr_array_new();
01278                         <span class="keywordflow">for</span> (i = 0; i &lt; src-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>-&gt;len; i++) {
01279                                 <span class="keywordflow">if</span> (i%2) <span class="comment">/* odd entries =&gt; strings */</span>
01280                                         g_ptr_array_add(dest-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, g_strdup(g_ptr_array_index(src-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, i)));
01281                                 <span class="keywordflow">else</span> { <span class="comment">/* even entries =&gt; integers */</span>
01282                                         curr = GPOINTER_TO_INT (g_ptr_array_index(src-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, i));
01283                                         g_ptr_array_add(dest-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, GINT_TO_POINTER (curr));
01284                                 }
01285                         }
01286                 }
01287         }
01288         
01289 <span class="preprocessor">#ifdef DEBUG</span>
01290 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; dest-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>-&gt;len; i += 2)
01291                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"URL: %s; weight: %d\n"</span>, (<span class="keywordtype">char</span>*)g_ptr_array_index(dest-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, i+1), GPOINTER_TO_INT (g_ptr_array_index(dest-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, i)));
01292 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
01293 
01294 }
01295 
01302 <span class="keywordtype">void</span>
<a name="l01303"></a><a class="code" href="libuau_8h.html#a90">01303</a> <a class="code" href="libuau_8h.html#a90">luau_copyProgInfo</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *dest, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *src) {
01304         <span class="keywordflow">if</span> (dest == NULL || src == NULL) { 
01305                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Null pointer passed to luau_copyProgInfo"</span>);
01306         } <span class="keywordflow">else</span> {
01307                 dest-&gt;<a class="code" href="structAProgInfo.html#o0">id</a> = g_strdup(src-&gt;<a class="code" href="structAProgInfo.html#o0">id</a>);
01308                 dest-&gt;<a class="code" href="structAProgInfo.html#o1">shortname</a> = g_strdup(src-&gt;<a class="code" href="structAProgInfo.html#o1">shortname</a>);
01309                 dest-&gt;<a class="code" href="structAProgInfo.html#o2">fullname</a> = g_strdup(src-&gt;<a class="code" href="structAProgInfo.html#o2">fullname</a>);
01310                 dest-&gt;<a class="code" href="structAProgInfo.html#o3">desc</a> = g_strdup(src-&gt;<a class="code" href="structAProgInfo.html#o3">desc</a>);
01311                 dest-&gt;<a class="code" href="structAProgInfo.html#o4">url</a> = g_strdup(src-&gt;<a class="code" href="structAProgInfo.html#o4">url</a>);
01312                 dest-&gt;<a class="code" href="structAProgInfo.html#o5">version</a> = g_strdup(src-&gt;<a class="code" href="structAProgInfo.html#o5">version</a>);
01313                 
01314                 <a class="code" href="libuau_8h.html#a91">luau_copyInterface</a>(&amp;(dest-&gt;<a class="code" href="structAProgInfo.html#o8">interface</a>), &amp;(src-&gt;<a class="code" href="structAProgInfo.html#o8">interface</a>));
01315                 
01316                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAProgInfo.html#o7">date</a> != NULL) {
01317                         dest-&gt;<a class="code" href="structAProgInfo.html#o7">date</a> = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structADate.html">ADate</a>));
01318                         <a class="code" href="libuau_8h.html#a92">luau_copyDate</a>(dest-&gt;<a class="code" href="structAProgInfo.html#o7">date</a>, src-&gt;<a class="code" href="structAProgInfo.html#o7">date</a>);
01319                 } <span class="keywordflow">else</span> {
01320                         dest-&gt;<a class="code" href="structAProgInfo.html#o7">date</a> = NULL;
01321                 }
01322                 <span class="keywordflow">if</span> (src-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a> != NULL) {
01323                         <a class="code" href="structGContainer.html">GContainer</a> *srcCont, *destCont;
01324                         dest-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a> = g_ptr_array_new();
01325                         srcCont = <a class="code" href="gcontainer_8h.html#a4">g_container_new_from_data</a>(<a class="code" href="gcontainer_8h.html#a25a0">GCONT_PTR_ARRAY</a>, src-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>);
01326                         destCont = <a class="code" href="gcontainer_8h.html#a4">g_container_new_from_data</a>(<a class="code" href="gcontainer_8h.html#a25a0">GCONT_PTR_ARRAY</a>, dest-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>);
01327                         <a class="code" href="gcontainer_8h.html#a21">g_container_copy</a>(destCont, srcCont);
01328                         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(srcCont, FALSE);
01329                         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(destCont, FALSE);
01330                 } <span class="keywordflow">else</span> {
01331                         dest-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a> = NULL;
01332                 }
01333         }
01334 }
01335 
01342 <span class="keywordtype">void</span>
<a name="l01343"></a><a class="code" href="libuau_8h.html#a91">01343</a> <a class="code" href="libuau_8h.html#a91">luau_copyInterface</a>(<a class="code" href="structAInterface.html">AInterface</a> *dest, <span class="keyword">const</span> <a class="code" href="structAInterface.html">AInterface</a> *src) {
01344         <span class="keywordflow">if</span> (dest == NULL || src == NULL) {
01345                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Null pointer passed to luau_copyInterface"</span>);
01346         } <span class="keywordflow">else</span> {
01347                 dest-&gt;<a class="code" href="structAInterface.html#o0">major</a> = src-&gt;<a class="code" href="structAInterface.html#o0">major</a>;
01348                 dest-&gt;<a class="code" href="structAInterface.html#o1">minor</a> = src-&gt;<a class="code" href="structAInterface.html#o1">minor</a>;
01349         }
01350 }
01351 
01358 <span class="keywordtype">void</span>
<a name="l01359"></a><a class="code" href="libuau_8h.html#a92">01359</a> <a class="code" href="libuau_8h.html#a92">luau_copyDate</a>(<a class="code" href="structADate.html">ADate</a> *dest, <span class="keyword">const</span> <a class="code" href="structADate.html">ADate</a> *src) {
01360         <span class="keywordflow">if</span> (dest == NULL || src == NULL) {
01361                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Null pointer passed to luau_copyDate"</span>);
01362         } <span class="keywordflow">else</span> {
01363                 dest-&gt;<a class="code" href="structADate.html#o2">year</a>  = src-&gt;<a class="code" href="structADate.html#o2">year</a>;
01364                 dest-&gt;<a class="code" href="structADate.html#o1">month</a> = src-&gt;<a class="code" href="structADate.html#o1">month</a>;
01365                 dest-&gt;<a class="code" href="structADate.html#o0">day</a>   = src-&gt;<a class="code" href="structADate.html#o0">day</a>;
01366         }
01367 }
01368 
01369 <span class="keywordtype">void</span>
<a name="l01370"></a><a class="code" href="libuau_8h.html#a93">01370</a> <a class="code" href="libuau_8h.html#a93">luau_copyQuants</a>(GPtrArray *dest, <span class="keyword">const</span> GPtrArray *src) {
01371         <a class="code" href="structAQuantifier.html">AQuantifier</a> *quant;
01372         <span class="keywordtype">int</span> i;
01373         
01374         <span class="keywordflow">for</span> (i = 0; i &lt; src-&gt;len; ++i) {
01375                 quant = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAQuantifier.html">AQuantifier</a>));
01376                 <a class="code" href="libuau_8h.html#a94">luau_copyQuant</a>(quant, g_ptr_array_index(src, i));
01377                 g_ptr_array_add(dest, quant);
01378         }
01379 }
01380 
01381 <span class="keywordtype">void</span>
<a name="l01382"></a><a class="code" href="libuau_8h.html#a94">01382</a> <a class="code" href="libuau_8h.html#a94">luau_copyQuant</a>(<a class="code" href="structAQuantifier.html">AQuantifier</a> *dest, <span class="keyword">const</span> <a class="code" href="structAQuantifier.html">AQuantifier</a> *src) {
01383         dest-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> = src-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a>;
01384         dest-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> = src-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a>;
01385         
01386         <span class="keywordflow">switch</span> (dest-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a>) {
01387                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a101a29">LUAU_QUANT_DATA_DATE</a>:
01388                         dest-&gt;<a class="code" href="structAQuantifier.html#o2">data</a> = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structADate.html">ADate</a>));
01389                         <a class="code" href="libuau_8h.html#a92">luau_copyDate</a>(dest-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>, src-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01390                         <span class="keywordflow">break</span>;
01391 
01392                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a101a30">LUAU_QUANT_DATA_VERSION</a>:
01393                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a101a31">LUAU_QUANT_DATA_INTERFACE</a>:
01394                 <span class="keywordflow">case</span> <a class="code" href="libuau_8h.html#a101a32">LUAU_QUANT_DATA_KEYWORD</a>:
01395                         dest-&gt;<a class="code" href="structAQuantifier.html#o2">data</a> = g_strdup(src-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01396                         <span class="keywordflow">break</span>;
01397                 
01398                 <span class="keywordflow">default</span>:
01399                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Invalid Quantifier Data type - can't copy"</span>);
01400         }
01401 }
01402 
01403 <span class="comment">/* Memory management */</span>
01404 
01410 <span class="keywordtype">void</span>
01411 <a class="code" href="libuau_8h.html#a95">luau_freeUpdateList</a>(GList *updates) {
<a name="l01412"></a><a class="code" href="libuau_8h.html#a95">01412</a>         GList *curr;
01413         
01414         <span class="keywordflow">if</span> (updates != NULL) {
01415                 <span class="keywordflow">for</span> (curr = updates; curr != NULL; curr = curr-&gt;next) {
01416                         <a class="code" href="libuau_8h.html#a97">luau_freeUpdateInfo</a>(curr-&gt;data);
01417                         g_free(curr-&gt;data);
01418                 }
01419                 
01420                 g_list_free(updates);
01421         }
01422 }
01423 
01429 <span class="keywordtype">void</span>
01430 <a class="code" href="libuau_8h.html#a96">luau_freeProgInfo</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *ptr) {
<a name="l01431"></a><a class="code" href="libuau_8h.html#a96">01431</a>         <span class="keywordflow">if</span> (ptr != NULL) {
01432                 <span class="keywordtype">int</span> i;
01433                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o0">id</a>);
01434                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o1">shortname</a>);
01435                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o2">fullname</a>);
01436                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o3">desc</a>);
01437                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o4">url</a>);
01438                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o5">version</a>);
01439                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o6">displayVersion</a>);
01440                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAProgInfo.html#o7">date</a>);
01441                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a> != NULL) {
01442                         <span class="keywordflow">for</span> (i = 0; i &lt; ptr-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>-&gt;len; ++i)
01443                                 g_free(g_ptr_array_index(ptr-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>, i));
01444                         g_ptr_array_free(ptr-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>, TRUE);
01445                 }
01446         } <span class="keywordflow">else</span> {
01447                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Attempt to free NULL pointer"</span>);
01448         }
01449 }
01450 
01456 <span class="keywordtype">void</span>
01457 <a class="code" href="libuau_8h.html#a97">luau_freeUpdateInfo</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *ptr) {
<a name="l01458"></a><a class="code" href="libuau_8h.html#a97">01458</a>         <a class="code" href="structAPackage.html">APackage</a> *pkg;
01459         <a class="code" href="structAQuantifier.html">AQuantifier</a> *quant;
01460         <span class="keywordtype">int</span> i;
01461         
01462         <span class="keywordflow">if</span> (ptr != NULL) {
01463                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAUpdate.html#o0">id</a>);
01464                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAUpdate.html#o3">date</a>);
01465                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAUpdate.html#o4">shortDesc</a>);
01466                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAUpdate.html#o5">fullDesc</a>);
01467                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a>);
01468                 <a class="code" href="util_8h.html#a4">nnull_g_free</a>(ptr-&gt;<a class="code" href="structAUpdate.html#o12">newURL</a>);
01469                 
01470                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> != NULL) {
01471                         <span class="keywordflow">for</span> (i = 0; i &lt; ptr-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>-&gt;len; ++i)
01472                                 g_free(g_ptr_array_index(ptr-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, i));
01473                         g_ptr_array_free(ptr-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, TRUE);
01474                 }
01475                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structAUpdate.html#o8">packages</a> != NULL) {
01476                         <span class="keywordflow">for</span> (i = 0; i &lt; ptr-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>-&gt;len; ++i) {
01477                                 pkg = g_ptr_array_index(ptr-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>, i);
01478                                 <a class="code" href="libuau_8h.html#a98">luau_freePkgInfo</a>(pkg);
01479                                 g_free(pkg);
01480                         }
01481                         g_ptr_array_free(ptr-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>, TRUE);
01482                 }
01483                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> != NULL) {
01484                         <span class="keywordflow">for</span> (i = 0; i &lt; ptr-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>-&gt;len; ++i) {
01485                                 quant = g_ptr_array_index(ptr-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, i);
01486                                 g_free(quant-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>);
01487                                 g_free(quant);
01488                         }
01489                         g_ptr_array_free(ptr-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, TRUE);
01490                 }
01491         } <span class="keywordflow">else</span> {
01492                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Attempt to free NULL pointer"</span>);
01493         }
01494 }
01495 
01501 <span class="keywordtype">void</span>
01502 <a class="code" href="libuau_8h.html#a98">luau_freePkgInfo</a>(<a class="code" href="structAPackage.html">APackage</a> *ptr) {
<a name="l01503"></a><a class="code" href="libuau_8h.html#a98">01503</a>         <span class="keywordtype">int</span> i;
01504         
01505         <span class="keywordflow">if</span> (ptr != NULL) {
01506                 <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a> != NULL) {
01507                         <span class="keywordflow">for</span> (i = 1; i &lt; ptr-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>-&gt;len; i+=2)
01508                                 g_free(g_ptr_array_index(ptr-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, i));
01509                         g_ptr_array_free(ptr-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>, TRUE);
01510                 }
01511         } <span class="keywordflow">else</span> {
01512                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Attempt to free NULL pointer"</span>);
01513         }
01514 }
01515 
01516 
01517 <span class="comment">/* Non-Interface Methods */</span>
01518 
01519 <span class="comment">/* compareAlphaNumeric &lt;VERSION1&gt; &lt;VERSION2&gt;</span>
01520 <span class="comment"> * Returns: 1 or 0.</span>
01521 <span class="comment"> *</span>
01522 <span class="comment"> * Compare two strings and return 1 if VERSION1 &gt; VERSION2, otherwise 0.</span>
01523 <span class="comment"> * Otherwise, gathers digits forward to compare full numbers.</span>
01524 <span class="comment"> */</span>
01525 
01526 <span class="keyword">static</span> <span class="keywordtype">int</span>
01527 <a class="code" href="libuau_8c.html#a0">compareAlphaNumeric</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *v1, <span class="keyword">const</span> <span class="keywordtype">char</span> *v2) {
<a name="l01528"></a><a class="code" href="libuau_8c.html#a0">01528</a>         <span class="keywordtype">int</span> i, len1, len2, limit, result = 0;
01529         
01530         <span class="keywordflow">if</span> (v1 == NULL)
01531                 v1 = <span class="stringliteral">""</span>;
01532         <span class="keywordflow">if</span> (v2 == NULL)
01533                 v2 = <span class="stringliteral">""</span>;
01534         
01535         <span class="comment">/* get length of the longest string to index with over as $limit */</span>
01536         len1 = strlen(v1);
01537         len2 = strlen(v2);
01538         <span class="keywordflow">if</span> (len1 &gt; len2)
01539                 limit = len1;
01540         <span class="keywordflow">else</span>
01541                 limit = len2;
01542         
01543         <span class="keywordflow">for</span> (i = 0; i &lt; limit; ++i) {
01544                 <span class="keywordtype">char</span> char1, char2;
01545                 <span class="keywordtype">int</span> val1, val2;
01546                 
01547                 <span class="comment">/* compare character by character indexing up the string */</span>
01548                 <span class="keywordflow">if</span> (i &lt; len1)
01549                         char1 = v1[i];
01550                 <span class="keywordflow">else</span>
01551                         char1 = <span class="charliteral">'\0'</span>;
01552                 
01553                 <span class="keywordflow">if</span> (i &lt; len2)
01554                         char2 = v2[i];
01555                 <span class="keywordflow">else</span>
01556                         char2 = <span class="charliteral">'\0'</span>;
01557                 
01558                 <span class="comment">/* special case: point release is higher than alphabetic release</span>
01559 <span class="comment">                 * example: REQUIRED 2.5-pre3 &lt; CURRENT 2.5 or REQUIRED alpha-char &lt; CURRENT no char */</span>
01560                 <span class="keywordflow">if</span> (! isdigit(char1) &amp;&amp; char2 == <span class="charliteral">'\0'</span>)
01561                         <span class="keywordflow">return</span> -1;
01562 
01563                 <span class="comment">/* look forward to find next index digit to complete the full number */</span>
01564                 <span class="keywordflow">if</span> (isdigit(v1[i]))
01565                         val1 = atoi(v1 + i);
01566                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (char1 == <span class="charliteral">'\0'</span>)
01567                         val1 = 0;
01568                 <span class="keywordflow">else</span>
01569                         val1 = -1;
01570                 
01571                 <span class="keywordflow">if</span> (isdigit(v2[i]))
01572                         val2 = atoi(v2 + i);
01573                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (char2 == <span class="charliteral">'\0'</span>)
01574                         val2 = 0;
01575                 <span class="keywordflow">else</span>
01576                         val2 = -1;
01577 
01578                 <span class="comment">/* if comparing numbers do an integer compare - otherwise do a string compare */</span>
01579                 <span class="keywordflow">if</span> (val1 != -1 || val2 != -1) {
01580                         <span class="keywordflow">if</span> (val1 &gt; val2) {
01581                                 result = 1;
01582                                 <span class="keywordflow">break</span>;
01583                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val1 &lt; val2) {
01584                                 result = -1;
01585                                 <span class="keywordflow">break</span>;
01586                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val1 &gt;= 10) {
01587                                 <span class="comment">/* Skip over digits of number we just checked */</span>
01588                                 i += log10(val1);
01589                         }
01590                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (char1 &lt; char2) {
01591                         result = -1;
01592                         <span class="keywordflow">break</span>;
01593                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (char1 &gt; char2) {
01594                         result = 1;
01595                         <span class="keywordflow">break</span>;
01596                 }
01597         }
01598         
01599         <span class="keywordflow">return</span> result;
01600 }
01601 
01602 
01610 <span class="keyword">static</span> <span class="keywordtype">void</span>
01611 <a class="code" href="libuau_8c.html#a1">categorizeUpdates</a>(<a class="code" href="structGContainer.html">GContainer</a> *updates, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo) {
<a name="l01612"></a><a class="code" href="libuau_8c.html#a1">01612</a>         <a class="code" href="structGIterator.html">GIterator</a> iter;
01613         <a class="code" href="structAUpdate.html">AUpdate</a> *curr;
01614         
01615         <span class="keywordflow">if</span> (updates == NULL) {
01616                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"NULL pointer passed to categorizeUpdates"</span>);
01617                 <span class="keywordflow">return</span>;
01618         }
01619         
01620         <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, updates);
01621         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter)) {
01622                 curr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01623                 <a class="code" href="libuau_8c.html#a2">categorizeUpdate</a>(curr, progInfo);
01624         }
01625 }
01626 
01627 <span class="keyword">static</span> <span class="keywordtype">void</span>
01628 <a class="code" href="libuau_8c.html#a2">categorizeUpdate</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo) {
<a name="l01629"></a><a class="code" href="libuau_8c.html#a2">01629</a>         <span class="keywordflow">if</span> (<a class="code" href="libuau_8c.html#a3">isIncompatible</a>(update, progInfo))
01630                 <a class="code" href="libuau_8h.html#a78">luau_setKeyword</a>(update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, <span class="stringliteral">"_incompatible"</span>);
01631         <span class="keywordflow">if</span> (<a class="code" href="libuau_8c.html#a4">isOld</a>(update, progInfo))
01632                 <a class="code" href="libuau_8h.html#a78">luau_setKeyword</a>(update-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, <span class="stringliteral">"_old"</span>);
01633 }
01634 
01642 <span class="keyword">static</span> gboolean
01643 <a class="code" href="libuau_8c.html#a3">isIncompatible</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo) {
<a name="l01644"></a><a class="code" href="libuau_8c.html#a3">01644</a>         <a class="code" href="structAQuantifier.html">AQuantifier</a> *curr;
01645         gboolean compatible = TRUE;
01646         <span class="keywordtype">int</span> i;
01647         
01648         <span class="keywordflow">if</span> (update-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> == NULL)
01649                 compatible = TRUE;
01650         <span class="keywordflow">else</span> {
01651                 <span class="keywordflow">for</span> (i = 0; i &lt; update-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>-&gt;len; ++i) {
01652                         curr = g_ptr_array_index(update-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, i);
01653                         
01654                         <span class="keywordflow">if</span> (! <a class="code" href="libuau_8h.html#a86">luau_satisfiesQuant</a>(curr, progInfo)) {
01655                                 compatible = FALSE;
01656                                 <span class="keywordflow">break</span>;
01657                         }
01658                 }
01659         }
01660         
01661         <span class="keywordflow">return</span> (!compatible);
01662 }
01663 
01664 <span class="keyword">static</span> gboolean
01665 <a class="code" href="libuau_8c.html#a4">isOld</a>(<a class="code" href="structAUpdate.html">AUpdate</a> *update, <span class="keyword">const</span> <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo) {
<a name="l01666"></a><a class="code" href="libuau_8c.html#a4">01666</a>         gboolean result;
01667         <span class="keywordtype">int</span> ret;
01668         
01669         <span class="keywordflow">if</span> (update-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a> == NULL || progInfo-&gt;<a class="code" href="structAProgInfo.html#o5">version</a> == NULL)
01670                 result = FALSE;
01671         <span class="keywordflow">else</span> {
01672                 ret = <a class="code" href="libuau_8h.html#a77">luau_versioncmp</a>(update-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a>, progInfo-&gt;<a class="code" href="structAProgInfo.html#o5">version</a>);
01673                 result = (ret != 1);
01674         }
01675         
01676         <span class="keywordflow">return</span> result;
01677 }
01678 
01679 
01680 
01681 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat Jan 15 16:52:30 2005 for luau by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
