<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>luau: database.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>database.c</h1><a href="database_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * luau (Lib Update/Auto-Update): Simple Update Library</span>
00003 <span class="comment"> * Copyright (C) 2003  David Eklund</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * - This library is free software; you can redistribute it and/or             -</span>
00006 <span class="comment"> * - modify it under the terms of the GNU Lesser General Public                -</span>
00007 <span class="comment"> * - License as published by the Free Software Foundation; either              -</span>
00008 <span class="comment"> * - version 2.1 of the License, or (at your option) any later version.        -</span>
00009 <span class="comment"> * -                                                                           -</span>
00010 <span class="comment"> * - This library is distributed in the hope that it will be useful,           -</span>
00011 <span class="comment"> * - but WITHOUT ANY WARRANTY; without even the implied warranty of            -</span>
00012 <span class="comment"> * - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU         -</span>
00013 <span class="comment"> * - Lesser General Public License for more details.                           -</span>
00014 <span class="comment"> * -                                                                           -</span>
00015 <span class="comment"> * - You should have received a copy of the GNU Lesser General Public          -</span>
00016 <span class="comment"> * - License along with this library; if not, write to the Free Software       -</span>
00017 <span class="comment"> * - Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA -</span>
00018 <span class="comment"> */</span>
00019  
00020 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00021 <span class="preprocessor">#include &lt;string.h&gt;</span>
00022 
00023 <span class="preprocessor">#include &lt;db.h&gt;</span>
00024 <span class="preprocessor">#include &lt;glib.h&gt;</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="database_8h.html">database.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="error_8h.html">error.h</a>"</span>
00029 
00030 <span class="preprocessor">#ifdef WITH_DMALLOC</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;dmalloc.h&gt;</span>
00032 <span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
00034 <span class="preprocessor">#if DB_VERSION_MAJOR == 3</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#  define DB_OPEN(ptr, file, db, type, flags, mode) ptr-&gt;open(ptr, dbFile, subcategory, type, flags, mode);</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#elif DB_VERSION_MAJOR == 4</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#  define DB_OPEN(ptr, file, db, type, flags, mode) ptr-&gt;open(ptr, NULL, dbFile, subcategory, type, flags, mode);</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#  error Unsupported version of libdb installed - please retrieve the latest from www.sleepycat.com</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 
<a name="l00043"></a><a class="code" href="structADatabaseHandle.html">00043</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00044"></a><a class="code" href="structADatabaseHandle.html#o0">00044</a>         <span class="keywordtype">char</span> *id;
<a name="l00045"></a><a class="code" href="structADatabaseHandle.html#o1">00045</a>         DB *ptr;
00046 } <a class="code" href="structADatabaseHandle.html">ADatabaseHandle</a>;
00047 
<a name="l00048"></a><a class="code" href="database_8c.html#a0">00048</a> gboolean <a class="code" href="database_8c.html#a0">keepOpen</a> = FALSE;
<a name="l00049"></a><a class="code" href="database_8c.html#a1">00049</a> GPtrArray *<a class="code" href="database_8c.html#a1">dbPs</a> = NULL;
00050 <span class="comment">/* GPtrArray *dbNames = NULL; */</span>
00051 
00052 <span class="keyword">static</span> DB * <a class="code" href="database_8c.html#a2">getDatabaseP</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, gboolean writeable);
00053 <span class="keyword">static</span> DB * <a class="code" href="database_8c.html#a3">openDatabase</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, gboolean needWrite);
00054 
00064 <span class="keywordtype">void</span> *
<a name="l00065"></a><a class="code" href="database_8c.html#a4">00065</a> <a class="code" href="database_8c.html#a4">luau_db_queryDatabase</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, <span class="keyword">const</span> <span class="keywordtype">char</span>* key) {
00066         DB *dbp;
00067         DBT dkey, data;
00068         <span class="keywordtype">int</span> ret;
00069         
00070         dbp = <a class="code" href="database_8c.html#a2">getDatabaseP</a>(category, subcategory, FALSE); <span class="comment">/* getDatabaseP(category, subcategory); */</span>
00071         <span class="keywordflow">if</span> (dbp == NULL) {
00072                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"luau_queryDatabase: Couldn't open database!"</span>);
00073                 <span class="keywordflow">return</span> NULL;
00074         }
00075         
00076         memset(&amp;dkey, 0, <span class="keyword">sizeof</span>(dkey));
00077         memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
00078 
00079         dkey.data = (<span class="keywordtype">void</span>*) key;
00080         dkey.size = <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (strlen(key) + 1);
00081         data.flags = DB_DBT_MALLOC;
00082         
00083         ret = dbp-&gt;get(dbp, NULL, &amp;dkey, &amp;data, 0);
00084         
00085         <span class="keywordflow">if</span> (!<a class="code" href="database_8c.html#a0">keepOpen</a>)
00086                 dbp-&gt;close(dbp, 0);
00087         <span class="keywordflow">if</span> (ret != 0) {
00088                 <span class="keywordflow">if</span> (ret != DB_NOTFOUND)
00089                         <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't query database: %s"</span>, db_strerror(ret));
00090 
00091                 <span class="keywordflow">return</span> NULL;
00092         } <span class="keywordflow">else</span> {
00093                 <span class="keywordflow">return</span> g_strdup(data.data);
00094         }
00095 }
00096 
00106 gboolean
<a name="l00107"></a><a class="code" href="database_8c.html#a5">00107</a> <a class="code" href="database_8c.html#a5">luau_db_keyExists</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, <span class="keyword">const</span> <span class="keywordtype">char</span>* key) {
00108         <span class="keywordflow">return</span> (<a class="code" href="database_8c.html#a4">luau_db_queryDatabase</a>(category, subcategory, key) == NULL);
00109 }
00110 
00111 gboolean
<a name="l00112"></a><a class="code" href="database_8c.html#a6">00112</a> <a class="code" href="database_8c.html#a6">luau_db_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory) {
00113         DB *dbp;
00114         
00115         dbp = <a class="code" href="database_8c.html#a2">getDatabaseP</a>(category, subcategory, TRUE);
00116         
00117         <span class="keywordflow">if</span> (dbp == NULL)
00118                 <span class="keywordflow">return</span> FALSE;
00119         
00120         <span class="keywordflow">else</span> {
00121                 <span class="keywordflow">if</span> (!<a class="code" href="database_8c.html#a0">keepOpen</a>)
00122                         dbp-&gt;close(dbp, 0);
00123                 
00124                 <span class="keywordflow">return</span> TRUE;
00125         }
00126 }
00127 
00128 
00137 GPtrArray *
<a name="l00138"></a><a class="code" href="database_8c.html#a7">00138</a> <a class="code" href="database_8c.html#a7">luau_db_getAllDBKeys</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory) {
00139         <span class="keywordtype">int</span> ret;
00140         DB *dbp;
00141         DBC *dbcp;
00142         DBT key, data;
00143         GPtrArray *keys = g_ptr_array_new();
00144         
00145         <span class="keywordflow">if</span> ((dbp = <a class="code" href="database_8c.html#a2">getDatabaseP</a>(category, subcategory, FALSE)) == NULL) {
00146                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't open database %s.%s!"</span>, category, subcategory);
00147                 <span class="keywordflow">return</span> NULL;
00148         }
00149         
00150         <span class="keywordflow">if</span> ((ret = dbp-&gt;cursor(dbp, NULL, &amp;dbcp, 0)) != 0) {
00151                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't get cursor: %s"</span>, db_strerror(ret));
00152                 <span class="keywordflow">return</span> NULL;
00153         }
00154         
00155         memset(&amp;key, 0, <span class="keyword">sizeof</span>(key));
00156         memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
00157         
00158         <span class="keywordflow">while</span> ((ret = dbcp-&gt;c_get(dbcp, &amp;key, &amp;data, DB_NEXT)) == 0) {
00159                  g_ptr_array_add(keys, g_strdup((<span class="keywordtype">char</span>*)key.data));
00160                 <span class="comment">// g_ptr_array_add(keys, (char*)key.data);</span>
00161                 <span class="comment">//free(key.data);</span>
00162                 <span class="comment">//free(data.data);</span>
00163         }
00164         <span class="keywordflow">if</span> (ret != DB_NOTFOUND) {
00165                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"DBcursor-&gt;get error: %s"</span>, db_strerror(ret));
00166         }
00167         
00168         dbcp-&gt;c_close(dbcp);
00169         <span class="keywordflow">if</span> (!<a class="code" href="database_8c.html#a0">keepOpen</a>)
00170                 dbp-&gt;close(dbp, 0);
00171         
00172         <span class="keywordflow">return</span> keys;
00173 }
00174 
00189 gboolean
<a name="l00190"></a><a class="code" href="database_8c.html#a8">00190</a> <a class="code" href="database_8c.html#a8">luau_db_setValue</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, <span class="keyword">const</span> <span class="keywordtype">char</span>* key, <span class="keyword">const</span> <span class="keywordtype">void</span>* value, size_t size) {
00191         DB *dbp;
00192         DBT dkey, data;
00193         <span class="keywordtype">int</span> ret;
00194         gboolean result = TRUE;
00195         
00196         dbp = <a class="code" href="database_8c.html#a2">getDatabaseP</a>(category, subcategory, TRUE);
00197         <span class="keywordflow">if</span> (dbp == NULL) {
00198                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't get database pointer"</span>);
00199                 <span class="keywordflow">return</span> FALSE;
00200         }
00201         
00202         memset(&amp;dkey, 0, <span class="keyword">sizeof</span>(dkey));
00203         memset(&amp;data, 0, <span class="keyword">sizeof</span>(data));
00204         dkey.data = (<span class="keywordtype">void</span>*) key;
00205         dkey.size = strlen(key)+1;
00206         data.data = (<span class="keywordtype">void</span>*) value;
00207         data.size = <a class="code" href="parseupdates_8c.html#a93">size</a>;
00208         
00209         ret = dbp-&gt;put(dbp, NULL, &amp;dkey, &amp;data, 0);
00210         <span class="keywordflow">if</span> (ret != 0) {
00211                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't create key value pair (%s): %s"</span>, key, db_strerror(ret));
00212                 result = FALSE;
00213         }
00214         
00215         <span class="keywordflow">if</span> (!<a class="code" href="database_8c.html#a0">keepOpen</a>)
00216                 dbp-&gt;close(dbp, 0);
00217         
00218         <span class="keywordflow">return</span> result;
00219 }
00220 
00232 gboolean
<a name="l00233"></a><a class="code" href="database_8c.html#a9">00233</a> <a class="code" href="database_8c.html#a9">luau_db_setValueString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, <span class="keyword">const</span> <span class="keywordtype">char</span>* key, <span class="keyword">const</span> <span class="keywordtype">char</span>* string) {
00234         <a class="code" href="util_8h.html#a1">DBUGOUT</a>(<span class="stringliteral">"Setting \"%s\" to \"%s\" in %s.%s"</span>, key, string, category, subcategory);
00235         <span class="keywordflow">if</span> (string == NULL)
00236                 <span class="keywordflow">return</span> <a class="code" href="database_8c.html#a8">luau_db_setValue</a>(category, subcategory, key, (<span class="keyword">const</span> <span class="keywordtype">void</span>*) NULL, 1);
00237         <span class="keywordflow">else</span>
00238                 <span class="keywordflow">return</span> <a class="code" href="database_8c.html#a8">luau_db_setValue</a>(category, subcategory, key, (<span class="keyword">const</span> <span class="keywordtype">void</span>*) string, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (strlen(string) + 1));
00239 }
00240 
00252 gboolean
<a name="l00253"></a><a class="code" href="database_8c.html#a10">00253</a> <a class="code" href="database_8c.html#a10">luau_db_setValueInt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, <span class="keyword">const</span> <span class="keywordtype">char</span>* key, <span class="keywordtype">int</span> value) {
00254         <a class="code" href="util_8h.html#a1">DBUGOUT</a>(<span class="stringliteral">"Setting \"%s\" to %d in %s.%s"</span>, key, value, category, subcategory);
00255         <span class="keywordflow">return</span> <a class="code" href="database_8c.html#a8">luau_db_setValue</a>(category, subcategory, key, (<span class="keyword">const</span> <span class="keywordtype">void</span>*) &amp;value, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00256 }
00257 
00258 gboolean
<a name="l00259"></a><a class="code" href="database_8c.html#a11">00259</a> <a class="code" href="database_8c.html#a11">luau_db_deleteKey</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, <span class="keyword">const</span> <span class="keywordtype">char</span>* key) {
00260         DB *dbp;
00261         DBT dkey;
00262         <span class="keywordtype">int</span> ret;
00263         
00264         memset(&amp;dkey, 0, <span class="keyword">sizeof</span>(dkey));
00265         dkey.data = (<span class="keywordtype">void</span>*) key;
00266         dkey.size = <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * (strlen(key)+1);
00267         
00268         dbp = <a class="code" href="database_8c.html#a2">getDatabaseP</a>(category, subcategory, TRUE);
00269         ret = dbp-&gt;del(dbp, NULL, &amp;dkey, 0);
00270         
00271         <span class="keywordflow">if</span> (ret != 0 &amp;&amp; ret != DB_NOTFOUND)
00272                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't delete key: %s"</span>, db_strerror(ret));
00273         
00274         <span class="keywordflow">return</span> (ret == 0 || ret == DB_NOTFOUND);
00275 }
00276 
00277 gboolean
<a name="l00278"></a><a class="code" href="database_8c.html#a12">00278</a> <a class="code" href="database_8c.html#a12">luau_db_clear</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory) {
00279         DB *dbp;
00280         <span class="keywordtype">int</span> ret;
00281         <span class="keywordtype">char</span> *filename;
00282         
00283         filename = <a class="code" href="util_8c.html#a3">lutil_vstrcreate</a>(<a class="code" href="database_8h.html#a0">DB_DIR</a> <span class="stringliteral">"/"</span>, category);
00284         
00285         dbp = <a class="code" href="database_8c.html#a2">getDatabaseP</a>(category, subcategory, TRUE);
00286         <span class="comment">/* ret = dbp-&gt;truncate(dbp, NULL, NULL, 0); */</span>
00287         ret = dbp-&gt;remove(dbp, filename, subcategory, 0);
00288         <span class="keywordflow">if</span> (ret != 0)
00289                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't truncate database: %s"</span>, db_strerror(ret));
00290         
00291         <span class="keywordflow">return</span> (ret == 0);
00292 }
00293 
00294 <span class="keywordtype">void</span>
<a name="l00295"></a><a class="code" href="database_8c.html#a13">00295</a> <a class="code" href="database_8c.html#a13">luau_db_keepOpen</a>(gboolean yesOrNo) {
00296         <a class="code" href="database_8c.html#a0">keepOpen</a> = yesOrNo;
00297 }
00298 
00299 <span class="keywordtype">void</span>
<a name="l00300"></a><a class="code" href="database_8c.html#a14">00300</a> <a class="code" href="database_8c.html#a14">luau_db_closeAll</a>(<span class="keywordtype">void</span>) {
00301         <span class="keywordtype">int</span> i;
00302         <a class="code" href="structADatabaseHandle.html">ADatabaseHandle</a> *<a class="code" href="parseupdates_8c.html#a90">curr</a>;
00303         
00304         <span class="keywordflow">if</span> (<a class="code" href="database_8c.html#a1">dbPs</a> == NULL)
00305                 <span class="keywordflow">return</span>;
00306         
00307         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="database_8c.html#a1">dbPs</a>-&gt;len; ++i) {
00308                 <a class="code" href="parseupdates_8c.html#a90">curr</a> = g_ptr_array_index(<a class="code" href="database_8c.html#a1">dbPs</a>, i);
00309                 <span class="keywordflow">if</span> (<a class="code" href="parseupdates_8c.html#a90">curr</a> != NULL) {
00310                         <a class="code" href="util_8h.html#a1">DBUGOUT</a>(<span class="stringliteral">"Closing database with handle %s"</span>, <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a>);
00311                         <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr-&gt;close(<a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr, 0);
00312                         g_free(<a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a>);
00313                         g_free(<a class="code" href="parseupdates_8c.html#a90">curr</a>);
00314                 }
00315         }
00316         
00317         g_ptr_array_free(<a class="code" href="database_8c.html#a1">dbPs</a>, TRUE);
00318         
00319         <a class="code" href="database_8c.html#a1">dbPs</a> = NULL;
00320 }
00321 
00322 
00323 <span class="comment">/* Non-Interface Methods */</span>
00324 
00325 <span class="keyword">static</span> DB *
<a name="l00326"></a><a class="code" href="database_8c.html#a2">00326</a> <a class="code" href="database_8c.html#a2">getDatabaseP</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, gboolean writeable) {
00327         <span class="keywordtype">int</span> i;
00328         DB *ptr = NULL;
00329         <a class="code" href="structADatabaseHandle.html">ADatabaseHandle</a> *<a class="code" href="parseupdates_8c.html#a90">curr</a>;
00330         <span class="keywordtype">char</span> *id, *readonly_id;
00331         
00332         <span class="keywordflow">if</span> (!<a class="code" href="database_8c.html#a0">keepOpen</a>)
00333                 <span class="keywordflow">return</span> <a class="code" href="database_8c.html#a3">openDatabase</a>(category, subcategory, writeable);
00334         
00335         <span class="keywordflow">if</span> (subcategory == NULL)
00336                 id = g_strdup(category);
00337         <span class="keywordflow">else</span>
00338                 id = <a class="code" href="util_8c.html#a3">lutil_vstrcreate</a>(<span class="stringliteral">"_"</span>, category, <span class="stringliteral">"_"</span>, subcategory, NULL);
00339         
00340         <span class="comment">/* Databases opened read-only are identified with a _ro suffix */</span>
00341         readonly_id = <a class="code" href="util_8c.html#a3">lutil_vstrcreate</a>(id, <span class="stringliteral">"_ro"</span>, NULL);
00342         
00343         <span class="keywordflow">if</span> (<a class="code" href="database_8c.html#a1">dbPs</a> == NULL)
00344                 <a class="code" href="database_8c.html#a1">dbPs</a> = g_ptr_array_new();
00345         
00346         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="database_8c.html#a1">dbPs</a>-&gt;len; ++i) {
00347                 <a class="code" href="parseupdates_8c.html#a90">curr</a> = (<a class="code" href="structADatabaseHandle.html">ADatabaseHandle</a>*) g_ptr_array_index(<a class="code" href="database_8c.html#a1">dbPs</a>, i);
00348 
00349                 <span class="keywordflow">if</span> (<a class="code" href="util_8c.html#a0">lutil_streq</a>(id, <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a>)) {
00350                         <span class="comment">/* regardless of whether we only needed write acess, we've found a read-write enabled</span>
00351 <span class="comment">                         * open handle, which will work regardless */</span>
00352                         ptr = <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr;
00353                         <span class="keywordflow">break</span>;
00354                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="util_8c.html#a0">lutil_streq</a>(readonly_id, <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a>)) {
00355                         <span class="comment">/* found an open read-only pointer */</span>
00356                         <span class="keywordflow">if</span> (writeable) {
00357                                 <span class="comment">/* this won't work - we need write access - so we close this open handle and (later)</span>
00358 <span class="comment">                                 * open a new one */</span>
00359                                 <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr-&gt;close(<a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr, 0);
00360                                 g_free(<a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a>);
00361                                 g_free(<a class="code" href="parseupdates_8c.html#a90">curr</a>);
00362                                 g_ptr_array_remove_index_fast(<a class="code" href="database_8c.html#a1">dbPs</a>, i);
00363                                 <span class="comment">/* messes up the order, but doesn't matter since we break from this for loop next */</span>
00364                                 
00365                                 ptr = NULL;
00366                         } <span class="keywordflow">else</span> {
00367                                 <span class="comment">/* only need read-only, so this is fine */</span>
00368                                 ptr = <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr;
00369                         }
00370                         
00371                         <span class="keywordflow">break</span>;
00372                 }
00373         }
00374         
00375         <span class="keywordflow">if</span> (ptr == NULL) {
00376                 <span class="comment">/* no appropriate handle found - open a new one and store it */</span>
00377                 
00378                 <a class="code" href="parseupdates_8c.html#a90">curr</a> = (<a class="code" href="structADatabaseHandle.html">ADatabaseHandle</a>*) g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structADatabaseHandle.html">ADatabaseHandle</a>));
00379                 ptr = <a class="code" href="database_8c.html#a3">openDatabase</a>(category, subcategory, writeable);
00380                 <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;ptr = ptr;
00381                 
00382                 <span class="keywordflow">if</span> (ptr != NULL) {
00383                         <span class="keywordflow">if</span> (writeable) {
00384                                 <a class="code" href="util_8h.html#a1">DBUGOUT</a>(<span class="stringliteral">"Opening Database: handle name %s"</span>, id);
00385                                 <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a> = id;
00386                                 g_free(readonly_id);
00387                         } <span class="keywordflow">else</span> {
00388                                 <span class="comment">/* if we're opening read-only, we store the read-only id (with the _ro tacked on) so we know */</span>
00389                                 <a class="code" href="util_8h.html#a1">DBUGOUT</a>(<span class="stringliteral">"Opening Database: handle name %s"</span>, id);
00390                                 <a class="code" href="parseupdates_8c.html#a90">curr</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a> = readonly_id;
00391                                 g_free(id);
00392                         }
00393         
00394                         g_ptr_array_add(<a class="code" href="database_8c.html#a1">dbPs</a>, <a class="code" href="parseupdates_8c.html#a90">curr</a>);
00395                 }
00396         }
00397         
00398         
00399         <span class="keywordflow">return</span> ptr;
00400 }
00401 
00402 
00413 <span class="keyword">static</span> DB *
<a name="l00414"></a><a class="code" href="database_8c.html#a3">00414</a> <a class="code" href="database_8c.html#a3">openDatabase</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* category, <span class="keyword">const</span> <span class="keywordtype">char</span>* subcategory, gboolean needWrite) {
00415         <span class="keywordtype">int</span> ret, flags;
00416         <span class="keywordtype">char</span> *dbFile;
00417         DB *ptr;
00418         
00419         dbFile = <a class="code" href="util_8c.html#a3">lutil_vstrcreate</a>(<a class="code" href="database_8h.html#a0">DB_DIR</a>, <span class="stringliteral">"/"</span>, category, NULL);
00420         flags = (needWrite ? DB_CREATE : DB_RDONLY);
00421         
00422         <a class="code" href="util_8h.html#a1">DBUGOUT</a>(<span class="stringliteral">"Opening database file %s.%s"</span>, dbFile, subcategory);
00423         
00424         ret = db_create(&amp;ptr, NULL, 0);
00425         <span class="keywordflow">if</span> (ret != 0) {
00426                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't create db pointer: %s"</span>, db_strerror(ret));
00427                 <span class="keywordflow">return</span> NULL;
00428         }
00429         
00430         ret = DB_OPEN(ptr, dbFile, subcategory, DB_BTREE, flags, 0644);
00431 <span class="comment">/*      ret = ptr-&gt;open(ptr, dbFile, subcategory, DB_BTREE, flags, 0644);</span>
00432 <span class="comment">        ret = ptr-&gt;open(ptr, NULL, dbFile, subcategory, DB_BTREE, flags, 0644); */</span>
00433 
00434         <span class="keywordflow">if</span> (ret != 0) {
00435                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Couldn't open %s.%s database: %s"</span>, category, subcategory, db_strerror(ret));
00436                 <span class="keywordflow">return</span> NULL;
00437         }
00438         
00439         g_free(dbFile);
00440         
00441         <span class="keywordflow">return</span> ptr;
00442 }
00443 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Dec 24 06:31:14 2003 for luau by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.2 </small></address>
</body>
</html>
