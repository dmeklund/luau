<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>luau: parseupdatesxml.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a></div>
<h1>parseupdatesxml.c</h1><a href="parseupdatesxml_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"> * luau (Lib Update/Auto-Update): Simple Update Library</span>
00003 <span class="comment"> * Copyright (C) 2003  David Eklund</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * - This library is free software; you can redistribute it and/or             -</span>
00006 <span class="comment"> * - modify it under the terms of the GNU Lesser General Public                -</span>
00007 <span class="comment"> * - License as published by the Free Software Foundation; either              -</span>
00008 <span class="comment"> * - version 2.1 of the License, or (at your option) any later version.        -</span>
00009 <span class="comment"> * -                                                                           -</span>
00010 <span class="comment"> * - This library is distributed in the hope that it will be useful,           -</span>
00011 <span class="comment"> * - but WITHOUT ANY WARRANTY; without even the implied warranty of            -</span>
00012 <span class="comment"> * - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU         -</span>
00013 <span class="comment"> * - Lesser General Public License for more details.                           -</span>
00014 <span class="comment"> * -                                                                           -</span>
00015 <span class="comment"> * - You should have received a copy of the GNU Lesser General Public          -</span>
00016 <span class="comment"> * - License along with this library; if not, write to the Free Software       -</span>
00017 <span class="comment"> * - Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA -</span>
00018 <span class="comment"> */</span>
00019 
00020 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;config.h&gt;</span>
00022 <span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00025 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00026 <span class="preprocessor">#include &lt;string.h&gt;</span>
00027 
00028 <span class="preprocessor">#include &lt;libxml/xmlmemory.h&gt;</span>
00029 <span class="preprocessor">#include &lt;libxml/parser.h&gt;</span>
00030 <span class="preprocessor">#include &lt;glib.h&gt;</span>
00031 
00032 <span class="preprocessor">#include "<a class="code" href="libuau_8h.html">libuau.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="util_8h.html">util.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="code" href="error_8h.html">error.h</a>"</span>
00035 <span class="preprocessor">#include "<a class="code" href="parse_8h.html">parse.h</a>"</span>
00036 <span class="preprocessor">#include "<a class="code" href="parseupdates_8h.html">parseupdates.h</a>"</span>
00037 
00038 <span class="preprocessor">#ifdef WITH_DMALLOC</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;dmalloc.h&gt;</span>
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 <a class="code" href="parseupdatesxml_8c.html#a2">G_LOCK_DEFINE_STATIC</a> (parse);
00043 
<a name="l00044"></a><a class="code" href="structAMirrorList.html">00044</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00045"></a><a class="code" href="structAMirrorList.html#o0">00045</a>         <span class="keywordtype">char</span> *<span class="keywordtype">id</span>;
<a name="l00046"></a><a class="code" href="structAMirrorList.html#o1">00046</a>         <a class="code" href="structGContainer.html">GContainer</a> *mirrors;
00047 } <a class="code" href="structAMirrorList.html">AMirrorList</a>;
00048 
<a name="l00049"></a><a class="code" href="structAMirror.html">00049</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00050"></a><a class="code" href="structAMirror.html#o0">00050</a>         <span class="keywordtype">char</span> *<span class="keywordtype">id</span>;
<a name="l00051"></a><a class="code" href="structAMirror.html#o1">00051</a>         <span class="keywordtype">char</span> *url;
00052 } <a class="code" href="structAMirror.html">AMirror</a>;
00053 
<a name="l00054"></a><a class="code" href="structASetAttributes.html">00054</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00055"></a><a class="code" href="structASetAttributes.html#o0">00055</a>         <a class="code" href="structGContainer.html">GContainer</a> *definedMirrors;
<a name="l00056"></a><a class="code" href="structASetAttributes.html#o1">00056</a>         <a class="code" href="structGContainer.html">GContainer</a> *definedMirrorLists;
<a name="l00057"></a><a class="code" href="structASetAttributes.html#o2">00057</a>         <a class="code" href="structGContainer.html">GContainer</a> *multAttributes;
<a name="l00058"></a><a class="code" href="structASetAttributes.html#o3">00058</a>         <a class="code" href="structGContainer.html">GContainer</a> *singAttributes;
00059 } <a class="code" href="structASetAttributes.html">ASetAttributes</a>;
00060 
<a name="l00061"></a><a class="code" href="structASingAttribute.html">00061</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00062"></a><a class="code" href="structASingAttribute.html#o0">00062</a>         <span class="keywordtype">char</span> *<span class="keywordtype">id</span>;
<a name="l00063"></a><a class="code" href="structASingAttribute.html#o1">00063</a>         <span class="keywordtype">char</span> *value;
00064 } <a class="code" href="structASingAttribute.html">ASingAttribute</a>;
00065 
<a name="l00066"></a><a class="code" href="structAMultAttribute.html">00066</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00067"></a><a class="code" href="structAMultAttribute.html#o0">00067</a>         <span class="keywordtype">char</span> *<span class="keywordtype">id</span>;
<a name="l00068"></a><a class="code" href="structAMultAttribute.html#o1">00068</a>         <a class="code" href="structGContainer.html">GContainer</a> *values;
00069 } <a class="code" href="structAMultAttribute.html">AMultAttribute</a>;
00070 
<a name="l00071"></a><a class="code" href="parseupdatesxml_8c.html#a0">00071</a> <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a> *<a class="code" href="parseupdatesxml_8c.html#a0">updates</a>;
<a name="l00072"></a><a class="code" href="parseupdatesxml_8c.html#a1">00072</a> <span class="keyword">static</span> <a class="code" href="structAUpdate.html">AUpdate</a> *<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>;
00073 
00074 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a3">parseUpdates</a>  (xmlDocPtr doc, xmlNodePtr node);
00075 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a4">parseUpdate</a>   (xmlDocPtr doc, xmlNodePtr node, xmlChar *type, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00076 
00077 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a5">parseProgInfo</a>   (<a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, xmlDocPtr doc, xmlNodePtr node, GError **err);
00078 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a6">parseProgInfoTag</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, xmlDocPtr doc, xmlNodePtr node);
00079 
00080 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a7">parseMirrorList</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00081 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a8">parseMirrorDef</a> (xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keywordtype">char</span> *list_id);
00082 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a9">addToMirrorList</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *list_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *mirror_id);
00083 
00084 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a10">parseSoftware</a>   (xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00085 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a11">parsePackage</a>    (xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00086 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a12">parseMessage</a>    (xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00087 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a13">parseLibupdate</a>  (xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00088 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a14">parseGenericInfo</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00089 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a15">parseUpdateInfo</a> (xmlDocPtr doc, xmlNodePtr node, AUpdateType type, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00090 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a16">parsePkgGroup</a>   (xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00091 
00092 <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a>* <a class="code" href="parseupdatesxml_8c.html#a17">parsePackageProperties</a>  (xmlNodePtr node, <a class="code" href="structAPackage.html">APackage</a> *pkg, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00093 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="parseupdatesxml_8c.html#a18">parsePackageAttrMirrors</a> (<a class="code" href="structAPackage.html">APackage</a> *pkg, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix, <span class="keyword">const</span> <span class="keywordtype">char</span> *loc);
00094 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="parseupdatesxml_8c.html#a19">parsePackageChildMirrors</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structAPackage.html">APackage</a> *pkg, <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix);
00095 
00096 <span class="keyword">static</span> gboolean <a class="code" href="parseupdatesxml_8c.html#a20">parseQuantData</a>(<span class="keywordtype">void</span> **data, <span class="keywordtype">char</span> *str, AQuantDataType quantDataType);
00097 
00098 <span class="keyword">static</span> <a class="code" href="structAMultAttribute.html">AMultAttribute</a>* <a class="code" href="parseupdatesxml_8c.html#a21">appendStringToAttributeList</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value);
00099 
00100 <span class="keyword">static</span> <a class="code" href="structASingAttribute.html">ASingAttribute</a>* <a class="code" href="parseupdatesxml_8c.html#a22">setAttributeValue</a> (<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value);
00101 <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a>*     <a class="code" href="parseupdatesxml_8c.html#a23">getAttributeList</a>  (<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>);
00102 <span class="keyword">static</span> <span class="keywordtype">char</span>*           <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>);
00103 
00104 <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a>* <a class="code" href="parseupdatesxml_8c.html#a25">parseMirrorIDs</a>(<a class="code" href="structGContainer.html">GContainer</a> *ids, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00105 
00106 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a26">initializeSetAttributes</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes);
00107 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a27">copySetAttributes</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *newSet, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, gboolean deepCopy);
00108 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a28">freeSetAttributes</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, gboolean deepFree);
00109 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a29">freeSingAttribute</a>(<a class="code" href="structASingAttribute.html">ASingAttribute</a> *attr);
00110 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="parseupdatesxml_8c.html#a30">freeMultAttribute</a>(<a class="code" href="structAMultAttribute.html">AMultAttribute</a> *attrs);
00111 
00112 
00122 <a class="code" href="structGContainer.html">GContainer</a> *
<a name="l00123"></a><a class="code" href="parseupdatesxml_8c.html#a31">00123</a> <a class="code" href="parseupdatesxml_8c.html#a31">luau_parseXML_updates</a>(<span class="keywordtype">char</span> *contents, GError **err) {
00124         xmlDocPtr doc;
00125         xmlNodePtr node;
00126         xmlChar *interfaceStr;
00127         <a class="code" href="structAInterface.html">AInterface</a> xmlInterface, readableInterface;
00128         gboolean result;
00129         <a class="code" href="structGContainer.html">GContainer</a> *ret;
00130         
00131         g_return_val_if_fail(err == NULL || *err == NULL, NULL);
00132         
00133         <a class="code" href="util_8h.html#a0">G_LOCK</a> (parse);
00134         
00135         <span class="comment">/* Tell libxml2 to store line number info for more helpful error output */</span>
00136         xmlLineNumbersDefault(1);
00137         
00138         <a class="code" href="parseupdatesxml_8c.html#a0">updates</a> = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
00139         doc = xmlParseMemory(contents, strlen(contents));
00140         node = xmlDocGetRootElement(doc);
00141         <span class="keywordflow">if</span> (node == NULL) {
00142                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a36">LUAU_BASE_ERROR_FAILED</a>, <span class="stringliteral">"XML file could not be parsed"</span>);
00143                 xmlFreeDoc(doc);
00144                 <span class="keywordflow">return</span> NULL;
00145         }
00146         
00147         <span class="keywordflow">if</span> (! xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"luau-repository"</span>)) {
00148                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a36">LUAU_BASE_ERROR_FAILED</a>, <span class="stringliteral">"XML error: Invalid root element"</span>);
00149                 xmlFreeDoc(doc);
00150                 <span class="keywordflow">return</span> NULL;
00151         }
00152         
00153         interfaceStr = xmlGetProp(node, <span class="stringliteral">"interface"</span>);
00154         result = <a class="code" href="libuau_8h.html#a71">luau_parseInterface</a>(&amp;xmlInterface, interfaceStr);
00155         xmlFree(interfaceStr);
00156         
00157         <span class="keywordflow">if</span> (result == FALSE)
00158                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"XML interface version either not specified or unreadable: may encounter problems"</span>);
00159         <span class="keywordflow">else</span> {
00160                 readableInterface.<a class="code" href="structAInterface.html#o0">major</a> = <a class="code" href="libuau_8h.html#a3">LUAU_XML_INTERFACE_MAJOR</a>;
00161                 readableInterface.<a class="code" href="structAInterface.html#o1">minor</a> = <a class="code" href="libuau_8h.html#a4">LUAU_XML_INTERFACE_MINOR</a>;
00162                 <span class="keywordflow">if</span> (!<a class="code" href="libuau_8h.html#a85">luau_satisfiesInterface</a>(&amp;readableInterface, &amp;xmlInterface))
00163                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unsupported XML interface specified - will continue, but will most likely encounter errors"</span>);
00164         }
00165         
00166         <a class="code" href="parseupdatesxml_8c.html#a3">parseUpdates</a>(doc, node);
00167         
00168         xmlFreeDoc(doc);
00169         
00170         ret = <a class="code" href="parseupdatesxml_8c.html#a0">updates</a>;
00171         
00172         <a class="code" href="util_8h.html#a1">G_UNLOCK</a> (parse);
00173         
00174         <span class="keywordflow">return</span> ret;
00175 }
00176 
00177 gboolean
<a name="l00178"></a><a class="code" href="parseupdatesxml_8c.html#a32">00178</a> <a class="code" href="parseupdatesxml_8c.html#a32">luau_parseXML_progInfo</a>(GString *contents, <a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, GError **err) {
00179         xmlDocPtr doc;
00180         xmlNodePtr node;
00181         xmlChar *interfaceStr;
00182         <a class="code" href="structAInterface.html">AInterface</a> xmlInterface, readableInterface;
00183         gboolean result;
00184         
00185         g_return_val_if_fail(err == NULL || *err == NULL, FALSE);
00186         
00187         memset(progInfo, 0, <span class="keyword">sizeof</span>(<a class="code" href="structAProgInfo.html">AProgInfo</a>));
00188 
00189         <a class="code" href="util_8h.html#a0">G_LOCK</a> (parse);
00190         
00191         doc = xmlParseMemory(contents-&gt;str, contents-&gt;len);
00192         
00193         <a class="code" href="util_8h.html#a1">G_UNLOCK</a> (parse);
00194         
00195         node = xmlDocGetRootElement(doc);
00196         <span class="keywordflow">if</span> (node == NULL) {
00197                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a36">LUAU_BASE_ERROR_FAILED</a>, <span class="stringliteral">"XML file could not be parsed"</span>);
00198                 xmlFreeDoc(doc);
00199                 <span class="keywordflow">return</span> FALSE;
00200         }
00201         
00202         <span class="keywordflow">if</span> (! xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"luau-repository"</span>)) {
00203                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a36">LUAU_BASE_ERROR_FAILED</a>, <span class="stringliteral">"XML error: Invalid root element"</span>);
00204                 xmlFreeDoc(doc);
00205                 <span class="keywordflow">return</span> FALSE;
00206         }
00207         
00208         interfaceStr = xmlGetProp(node, <span class="stringliteral">"interface"</span>);
00209         <span class="keywordflow">if</span> (interfaceStr == NULL) {
00210                 result = FALSE;
00211         } <span class="keywordflow">else</span> {
00212                 result = <a class="code" href="libuau_8h.html#a71">luau_parseInterface</a>(&amp;xmlInterface, interfaceStr);
00213                 xmlFree(interfaceStr);
00214         }
00215         
00216         <span class="keywordflow">if</span> (result == FALSE)
00217                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"XML interface version either not specified or unreadable: may encounter problems"</span>);
00218         <span class="keywordflow">else</span> {
00219                 readableInterface.<a class="code" href="structAInterface.html#o0">major</a> = <a class="code" href="libuau_8h.html#a3">LUAU_XML_INTERFACE_MAJOR</a>;
00220                 readableInterface.<a class="code" href="structAInterface.html#o1">minor</a> = <a class="code" href="libuau_8h.html#a4">LUAU_XML_INTERFACE_MINOR</a>;
00221                 <span class="keywordflow">if</span> (!<a class="code" href="libuau_8h.html#a85">luau_satisfiesInterface</a>(&amp;readableInterface, &amp;xmlInterface))
00222                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unsupported XML interface specified - will continue, but will most likely encounter errors"</span>);
00223         }
00224         
00225         <a class="code" href="parseupdatesxml_8c.html#a5">parseProgInfo</a>(progInfo, doc, node, err);
00226         
00227         xmlFreeDoc(doc);
00228         
00229         <a class="code" href="util_8h.html#a1">G_UNLOCK</a> (parse);
00230         
00231         <span class="keywordflow">return</span> TRUE;
00232 }
00233 
00234 <span class="comment">/* Non-Interface Methods */</span>
00235 
00236 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00237"></a><a class="code" href="parseupdatesxml_8c.html#a3">00237</a> <a class="code" href="parseupdatesxml_8c.html#a3">parseUpdates</a>(xmlDocPtr doc, xmlNodePtr node) {
00238         xmlChar *type;
00239         gboolean foundProgInfo = FALSE;
00240         <a class="code" href="structASetAttributes.html">ASetAttributes</a> attributes;
00241         
00242         <a class="code" href="parseupdatesxml_8c.html#a26">initializeSetAttributes</a>(&amp;attributes);
00243         
00244         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00245                 <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"update"</span>)) {
00246                         type = xmlGetProp(node, <span class="stringliteral">"type"</span>);
00247                         <a class="code" href="parseupdatesxml_8c.html#a4">parseUpdate</a>(doc, node, type, &amp;attributes);
00248                         xmlFree(type);
00249                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"software"</span>)) {
00250                         <a class="code" href="parseupdatesxml_8c.html#a4">parseUpdate</a>(doc, node, <span class="stringliteral">"software"</span>, &amp;attributes);
00251                         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a> = xmlGetProp(node, <span class="stringliteral">"version"</span>);
00252                         <span class="keywordflow">if</span> (<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a> == NULL)
00253                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a> = g_strdup(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o9">newVersion</a>);
00254                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"program-info"</span>)) {
00255                         <span class="comment">/* we can skip this since it isn't relevant to parsing updates - we do, however,</span>
00256 <span class="comment">                           check to make sure only one &lt;program-info&gt; tag is specified */</span>
00257                    <span class="keywordflow">if</span> (foundProgInfo)
00258                                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Two &lt;program-info&gt; tags found - only one is allowed"</span>);
00259                    foundProgInfo = TRUE;
00260                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"mirror-list"</span>)) {
00261                         <a class="code" href="parseupdatesxml_8c.html#a7">parseMirrorList</a>(doc, node, &amp;attributes);
00262                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"comment"</span>)) {
00263                         <span class="comment">// do nothing</span>
00264                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (! (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"text"</span>)) ) {
00265                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Only tags allowed in &lt;luau-repository&gt; root tag are &lt;update&gt;, &lt;software&gt;, and &lt;program-info&gt;; found '%s', skipping"</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span>*) node-&gt;name);
00266                 }
00267         }
00268         
00269         <span class="keywordflow">if</span> (!foundProgInfo)
00270                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"No &lt;program-info&gt; tag found - required by DTD"</span>);
00271         
00272         <a class="code" href="parseupdatesxml_8c.html#a28">freeSetAttributes</a>(&amp;attributes, TRUE);
00273 }
00274 
00275 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00276"></a><a class="code" href="parseupdatesxml_8c.html#a5">00276</a> <a class="code" href="parseupdatesxml_8c.html#a5">parseProgInfo</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, xmlDocPtr doc, xmlNodePtr node, GError **err) {
00277         gboolean found = FALSE;
00278         
00279         g_return_if_fail(err == NULL || *err == NULL);
00280         
00281         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00282                 <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"program-info"</span>)) {
00283                         <a class="code" href="parseupdatesxml_8c.html#a6">parseProgInfoTag</a>(progInfo, doc, node);
00284                         found = TRUE;
00285                         <span class="keywordflow">break</span>;
00286                 }
00287         }
00288         
00289         <span class="keywordflow">if</span> (!found)
00290                 g_set_error(err, <a class="code" href="libuau_8h.html#a12">LUAU_BASE_ERROR</a>, <a class="code" href="libuau_8h.html#a102a36">LUAU_BASE_ERROR_FAILED</a>, <span class="stringliteral">"Couldn't parse program information: none available in provided file"</span>);
00291 }
00292 
00293 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00294"></a><a class="code" href="parseupdatesxml_8c.html#a6">00294</a> <a class="code" href="parseupdatesxml_8c.html#a6">parseProgInfoTag</a>(<a class="code" href="structAProgInfo.html">AProgInfo</a> *progInfo, xmlDocPtr doc, xmlNodePtr node) {
00295         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *symbols[ ] = {<span class="stringliteral">"shortname"</span>, <span class="stringliteral">"s"</span>,
00296                                          <span class="stringliteral">"fullname"</span>,  <span class="stringliteral">"f"</span>,
00297                                          <span class="stringliteral">"desc"</span>,      <span class="stringliteral">"d"</span>,
00298                                          <span class="stringliteral">"keyword"</span>,   <span class="stringliteral">"k"</span>,
00299                                          <span class="stringliteral">"url"</span>,       <span class="stringliteral">"u"</span>,
00300                                                                          <span class="stringliteral">"text"</span>,      <span class="stringliteral">"t"</span>,
00301                                                                          <span class="stringliteral">"comment"</span>,   <span class="stringliteral">"c"</span>,
00302                                           NULL };
00303         <span class="keywordtype">char</span> result, *temp;
00304         
00305         progInfo-&gt;<a class="code" href="structAProgInfo.html#o0">id</a> = xmlGetProp(node, <span class="stringliteral">"id"</span>);
00306         progInfo-&gt;<a class="code" href="structAProgInfo.html#o8">interface</a>.<a class="code" href="structAInterface.html#o0">major</a> = -1;
00307         progInfo-&gt;<a class="code" href="structAProgInfo.html#o8">interface</a>.<a class="code" href="structAInterface.html#o1">minor</a> = -1;
00308         
00309         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00310                 result = <a class="code" href="parse_8h.html#a2">lutil_parse_parseSymbolArray</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)node-&gt;name, symbols);
00311                 <span class="keywordflow">switch</span> (result) {
00312                         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00313                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00314                                 progInfo-&gt;<a class="code" href="structAProgInfo.html#o1">shortname</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00315                                 xmlFree(temp);
00316                                 <span class="keywordflow">break</span>;
00317                         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
00318                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00319                                 progInfo-&gt;<a class="code" href="structAProgInfo.html#o2">fullname</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00320                                 xmlFree(temp);
00321                                 <span class="keywordflow">break</span>;
00322                         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00323                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00324                                 progInfo-&gt;<a class="code" href="structAProgInfo.html#o3">desc</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00325                                 xmlFree(temp);
00326                                 <span class="keywordflow">break</span>;
00327                         <span class="keywordflow">case</span> <span class="charliteral">'k'</span>:
00328                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00329                                 <span class="keywordflow">if</span> (progInfo-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a> == NULL)
00330                                         progInfo-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a> = g_ptr_array_new();
00331                                 
00332                                 g_ptr_array_add(progInfo-&gt;<a class="code" href="structAProgInfo.html#o9">keywords</a>, g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp)));
00333                                 xmlFree(temp);
00334                                 <span class="keywordflow">break</span>;
00335                         <span class="keywordflow">case</span> <span class="charliteral">'u'</span>:
00336                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00337                                 progInfo-&gt;<a class="code" href="structAProgInfo.html#o4">url</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00338                                 xmlFree(temp);
00339                                 <span class="keywordflow">break</span>;
00340                         <span class="keywordflow">case</span> -1:
00341                                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unrecognized &lt;%s&gt; tag in &lt;program-info&gt; in XML file: Skipping"</span>, node-&gt;name);
00342                                 <span class="keywordflow">break</span>;
00343                 }
00344         }
00345 }
00346 
00347 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00348"></a><a class="code" href="parseupdatesxml_8c.html#a7">00348</a> <a class="code" href="parseupdatesxml_8c.html#a7">parseMirrorList</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes)
00349 {
00350         <span class="keywordtype">char</span> *<span class="keywordtype">id</span>;
00351         
00352         <span class="keywordtype">id</span> = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"id"</span>);
00353         
00354         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next)
00355         {
00356                 <span class="keywordflow">if</span> (xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"mirror-def"</span>))
00357                 {
00358                         <a class="code" href="parseupdatesxml_8c.html#a8">parseMirrorDef</a>(doc, node, attributes, <span class="keywordtype">id</span>);
00359                 }
00360                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"text"</span>) &amp;&amp;
00361                          !xmlStrEqual(node-&gt;name, (<span class="keyword">const</span> xmlChar *) <span class="stringliteral">"comment"</span>))
00362                 {
00363                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unrecognized tag &lt;%s&gt; in &lt;mirror-list&gt;"</span>, node-&gt;name);
00364                 }
00365         }
00366         
00367         g_free(<span class="keywordtype">id</span>);
00368 }
00369 
00370 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00371"></a><a class="code" href="parseupdatesxml_8c.html#a8">00371</a> <a class="code" href="parseupdatesxml_8c.html#a8">parseMirrorDef</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keywordtype">char</span> *list_id)
00372 {
00373         <a class="code" href="structASingAttribute.html">ASingAttribute</a> *attr;
00374         <span class="keywordtype">char</span> *temp, *url, *<span class="keywordtype">id</span>;
00375         
00376         <span class="keywordtype">id</span> = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"id"</span>);
00377         <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == NULL || <span class="keywordtype">id</span>[0] == <span class="charliteral">'\0'</span>)
00378         {
00379                 xmlFree(<span class="keywordtype">id</span>);
00380                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"No mirror ID specified at line %ld"</span>, xmlGetLineNo(node));
00381                 <span class="keywordflow">return</span>;
00382         }
00383         
00384         temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00385         url = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00386         xmlFree(temp);
00387         <span class="keywordflow">if</span> (url == NULL || url[0] == <span class="charliteral">'\0'</span>)
00388         {
00389                 xmlFree(url);
00390                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"No URL specified for mirror '%s' at line %ld"</span>, <span class="keywordtype">id</span>, xmlGetLineNo(node));
00391                 <span class="keywordflow">return</span>;
00392         }
00393         
00394         attr = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structASingAttribute.html">ASingAttribute</a>));
00395         attr-&gt;<a class="code" href="structASingAttribute.html#o0">id</a> = <span class="keywordtype">id</span>;
00396         attr-&gt;<a class="code" href="structASingAttribute.html#o1">value</a> = url;
00397         
00398         <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a>, attr);
00399         <span class="keywordflow">if</span> (list_id != NULL)
00400                 <a class="code" href="parseupdatesxml_8c.html#a9">addToMirrorList</a>(attributes, list_id, <span class="keywordtype">id</span>);
00401 }
00402 
00403 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00404"></a><a class="code" href="parseupdatesxml_8c.html#a9">00404</a> <a class="code" href="parseupdatesxml_8c.html#a9">addToMirrorList</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *list_id, <span class="keyword">const</span> <span class="keywordtype">char</span> *mirror_id)
00405 {
00406         <a class="code" href="structAMirrorList.html">AMirrorList</a> *mirrLst;
00407         <a class="code" href="structGIterator.html">GIterator</a> iter;
00408         gboolean found, result;
00409         
00410         found = FALSE;
00411         
00412         result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a>);
00413         <span class="keywordflow">if</span> (result)
00414         {
00415                 <span class="keywordflow">while</span> (!found &amp;&amp; <a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
00416                 {
00417                         mirrLst = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
00418                         
00419                         <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(list_id, mirrLst-&gt;<a class="code" href="structAMirrorList.html#o0">id</a>))
00420                         {
00421                                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(mirrLst-&gt;<a class="code" href="structAMirrorList.html#o1">mirrors</a>, g_strdup(mirror_id));
00422                                 found = TRUE;
00423                         }
00424                 }
00425         }
00426         <span class="keywordflow">if</span> (!found)
00427         {
00428                 mirrLst = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAMirrorList.html">AMirrorList</a>));
00429                 mirrLst-&gt;<a class="code" href="structAMirrorList.html#o0">id</a> = g_strdup(list_id);
00430                 mirrLst-&gt;<a class="code" href="structAMirrorList.html#o1">mirrors</a> = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
00431                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(mirrLst-&gt;<a class="code" href="structAMirrorList.html#o1">mirrors</a>, g_strdup(mirror_id));
00432                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a>, mirrLst);
00433         }
00434 }
00435                                                                                             
00436         
00437 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00438"></a><a class="code" href="parseupdatesxml_8c.html#a4">00438</a> <a class="code" href="parseupdatesxml_8c.html#a4">parseUpdate</a>(xmlDocPtr doc, xmlNodePtr node, xmlChar *type, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) {
00439         <span class="keywordflow">if</span> (type == NULL) {
00440                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"No type specified for update: skipping"</span>);
00441                 <span class="keywordflow">return</span>;
00442         }
00443         
00444         <span class="comment">/* Create and initialize a new AUpdate object */</span>
00445         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a> = (<a class="code" href="structAUpdate.html">AUpdate</a>*) g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAUpdate.html">AUpdate</a>));
00446         memset(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>, 0, <span class="keyword">sizeof</span>(AUpdate));
00447         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a> = g_ptr_array_new();
00448         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o8">packages</a> = g_ptr_array_new();
00449         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> = NULL;
00450         <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(<a class="code" href="parseupdatesxml_8c.html#a0">updates</a>, <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>); <span class="comment">/* ... and add it to the list */</span>
00451         
00452         
00453         <span class="keywordflow">if</span>      (xmlStrcasecmp(type, <span class="stringliteral">"software"</span>)    == 0) { <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o2">type</a> = <a class="code" href="libuau_8h.html#a99a23">LUAU_SOFTWARE</a>;  }
00454         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xmlStrcasecmp(type, <span class="stringliteral">"message"</span> )    == 0) { <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o2">type</a> = <a class="code" href="libuau_8h.html#a99a24">LUAU_MESSAGE</a>;   }
00455         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (xmlStrcasecmp(type, <span class="stringliteral">"luau-config"</span>) == 0) { <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o2">type</a> = <a class="code" href="libuau_8h.html#a99a25">LUAU_LIBUPDATE</a>; }
00456         <span class="keywordflow">else</span> { 
00457                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unknown 'update' type specified: %s - Skipping"</span>, type);
00458                 <span class="keywordflow">return</span>;
00459         }
00460         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Found update of type %s"</span>, type);
00461         
00462         <a class="code" href="parseupdatesxml_8c.html#a15">parseUpdateInfo</a>(doc, node, <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o2">type</a>, attributes);
00463 }
00464 
00465 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00466"></a><a class="code" href="parseupdatesxml_8c.html#a15">00466</a> <a class="code" href="parseupdatesxml_8c.html#a15">parseUpdateInfo</a>(xmlDocPtr doc, xmlNodePtr node, AUpdateType type, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) {
00467         <a class="code" href="parseupdatesxml_8c.html#a14">parseGenericInfo</a>(doc, node, attributes);
00468         <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a99a23">LUAU_SOFTWARE</a>)
00469                 <a class="code" href="parseupdatesxml_8c.html#a10">parseSoftware</a>(doc, node, attributes);
00470         <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a99a24">LUAU_MESSAGE</a>)
00471                 <a class="code" href="parseupdatesxml_8c.html#a12">parseMessage</a>(doc, node, attributes);
00472         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="libuau_8h.html#a99a25">LUAU_LIBUPDATE</a>)
00473                 <a class="code" href="parseupdatesxml_8c.html#a13">parseLibupdate</a>(doc, node, attributes);
00474 }
00475 
00476 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00477"></a><a class="code" href="parseupdatesxml_8c.html#a14">00477</a> <a class="code" href="parseupdatesxml_8c.html#a14">parseGenericInfo</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) {
00478         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *symbols[ ] = {<span class="stringliteral">"id"</span>,       <span class="stringliteral">"i"</span>,
00479                                          <span class="stringliteral">"short"</span>,    <span class="stringliteral">"s"</span>,
00480                                          <span class="stringliteral">"long"</span>,     <span class="stringliteral">"l"</span>,
00481                                          <span class="stringliteral">"keyword"</span>,  <span class="stringliteral">"k"</span>,
00482                                          <span class="stringliteral">"date"</span>,     <span class="stringliteral">"d"</span>,
00483                                          <span class="stringliteral">"valid"</span>,    <span class="stringliteral">"v"</span>,
00484                                           NULL };
00485         <span class="keywordtype">char</span> result, *temp;
00486         <a class="code" href="structAQuantifier.html">AQuantifier</a> *quant = NULL;
00487         <a class="code" href="libuau_8h.html#a101">AQuantDataType</a> quantDataType;
00488         
00489         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00490                 result = <a class="code" href="parse_8h.html#a2">lutil_parse_parseSymbolArray</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)node-&gt;name, symbols);
00491                 <span class="keywordflow">switch</span> (result) {
00492                         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00493                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00494                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o0">id</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00495                                 xmlFree(temp);
00496                                 <span class="keywordflow">break</span>;
00497                         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00498                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00499                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o4">shortDesc</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00500                                 xmlFree(temp);
00501                                 <span class="keywordflow">break</span>;
00502                         <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00503                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00504                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o5">fullDesc</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00505                                 xmlFree(temp);
00506                                 <span class="keywordflow">break</span>;
00507                         <span class="keywordflow">case</span> <span class="charliteral">'k'</span>:
00508                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00509                                 g_ptr_array_add(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o1">keywords</a>, g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp)));
00510                                 xmlFree(temp);
00511                                 <span class="keywordflow">break</span>;
00512                         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00513                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00514                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o3">date</a> = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structADate.html">ADate</a>));
00515                                 <a class="code" href="libuau_8h.html#a69">luau_parseDate</a>(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o3">date</a>, <a class="code" href="parse_8c.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00516                                 xmlFree(temp);
00517                                 <span class="keywordflow">break</span>;
00518                         <span class="keywordflow">case</span> <span class="charliteral">'v'</span>:
00519                                 temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"type"</span>);
00520                                 
00521                                 quantDataType = <a class="code" href="libuau_8h.html#a87">luau_parseQuantDataType</a>(temp);
00522                                 
00523                                 <span class="keywordflow">if</span> (quantDataType == <a class="code" href="libuau_8h.html#a101a33">LUAU_QUANT_DATA_INVALID</a>) {
00524                                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unsupported quantifier data type: '%s'"</span>, temp);
00525                                         xmlFree(temp);
00526                                         <span class="keywordflow">break</span>;
00527                                 }
00528                                 xmlFree(temp);
00529                                 
00530                                 <span class="keywordflow">if</span> (<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> == NULL)
00531                                         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a> = g_ptr_array_new();
00532                                 
00533                                 temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"from"</span>);
00534                                 <span class="keywordflow">if</span> (temp != NULL) {
00535                                         quant = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAQuantifier.html">AQuantifier</a>));
00536                                         quant-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> = <a class="code" href="libuau_8h.html#a100a26">LUAU_QUANT_FROM</a>;
00537                                         quant-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> = quantDataType;
00538                                         <a class="code" href="parseupdatesxml_8c.html#a20">parseQuantData</a>(&amp;(quant-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>), temp, quantDataType);
00539                                         
00540                                         g_ptr_array_add(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, quant);
00541                                         
00542                                         xmlFree(temp);
00543                                 }
00544                                 
00545                                 temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"to"</span>);
00546                                 <span class="keywordflow">if</span> (temp != NULL) {
00547                                         quant = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAQuantifier.html">AQuantifier</a>));
00548                                         quant-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> = <a class="code" href="libuau_8h.html#a100a27">LUAU_QUANT_TO</a>;
00549                                         quant-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> = quantDataType;
00550                                         <a class="code" href="parseupdatesxml_8c.html#a20">parseQuantData</a>(&amp;(quant-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>), temp, quantDataType);
00551                                         
00552                                         g_ptr_array_add(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, quant);
00553                                         
00554                                         xmlFree(temp);
00555                                 }
00556                                 
00557                                 temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"for"</span>);
00558                                 <span class="keywordflow">if</span> (temp != NULL) {
00559                                         quant = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAQuantifier.html">AQuantifier</a>));
00560                                         quant-&gt;<a class="code" href="structAQuantifier.html#o0">qtype</a> = <a class="code" href="libuau_8h.html#a100a28">LUAU_QUANT_FOR</a>;
00561                                         quant-&gt;<a class="code" href="structAQuantifier.html#o1">dtype</a> = quantDataType;
00562                                         <a class="code" href="parseupdatesxml_8c.html#a20">parseQuantData</a>(&amp;(quant-&gt;<a class="code" href="structAQuantifier.html#o2">data</a>), temp, quantDataType);
00563                                         
00564                                         g_ptr_array_add(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o6">quantifiers</a>, quant);
00565                                         
00566                                         xmlFree(temp);
00567                                 }
00568                                 
00569                                 <span class="keywordflow">break</span>;
00570                 }
00571         }
00572 }
00573 
00574 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00575"></a><a class="code" href="parseupdatesxml_8c.html#a10">00575</a> <a class="code" href="parseupdatesxml_8c.html#a10">parseSoftware</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) { 
00576         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *symbols[ ] = {<span class="stringliteral">"package"</span>,         <span class="stringliteral">"p"</span>,
00577                                                                          <span class="stringliteral">"interface"</span>,       <span class="stringliteral">"i"</span>,
00578                                                                          <span class="stringliteral">"package-group"</span>,   <span class="stringliteral">"g"</span>,
00579                                                                          <span class="stringliteral">"display-version"</span>, <span class="stringliteral">"d"</span>,
00580                                           NULL };
00581         <span class="keywordtype">char</span> result, *temp;
00582         
00583         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00584                 result = <a class="code" href="parse_8h.html#a2">lutil_parse_parseSymbolArray</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)node-&gt;name, symbols);
00585                 <span class="keywordflow">switch</span> (result) {
00586                         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00587                                 <a class="code" href="parseupdatesxml_8c.html#a11">parsePackage</a>(doc, node, attributes);
00588                                 <span class="keywordflow">break</span>;
00589                                 
00590                         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00591                                 temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"version"</span>);
00592                                 <a class="code" href="libuau_8h.html#a71">luau_parseInterface</a>(&amp;(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o11">interface</a>), temp);
00593                                 xmlFree(temp);
00594                                 
00595                                 <span class="keywordflow">break</span>;
00596                                 
00597                         <span class="keywordflow">case</span> <span class="charliteral">'g'</span>:
00598                                 <a class="code" href="parseupdatesxml_8c.html#a16">parsePkgGroup</a>(doc, node, attributes);
00599                                 <span class="keywordflow">break</span>;
00600                                 
00601                         <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00602                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00603                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o10">newDisplayVersion</a> = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00604                                 xmlFree(temp);
00605                                 <span class="keywordflow">break</span>;
00606                 }
00607         }
00608 }
00609 
00610 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00611"></a><a class="code" href="parseupdatesxml_8c.html#a11">00611</a> <a class="code" href="parseupdatesxml_8c.html#a11">parsePackage</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) {
00612         <a class="code" href="structASetAttributes.html">ASetAttributes</a> newAttributes;
00613         GPtrArray *mirrors;
00614         <a class="code" href="structGContainer.html">GContainer</a> *allocated;
00615         <a class="code" href="structAPackage.html">APackage</a> *pkg;
00616         <span class="keywordtype">char</span> *loc, *temp, *suffix;
00617         <span class="keywordtype">int</span> i, total;
00618         
00619         <a class="code" href="parseupdatesxml_8c.html#a27">copySetAttributes</a>(&amp;newAttributes, attributes, FALSE);
00620         
00621         pkg = (<a class="code" href="structAPackage.html">APackage</a>*) g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAPackage.html">APackage</a>));
00622         g_ptr_array_add(<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o8">packages</a>, pkg);
00623         pkg-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a> = g_ptr_array_new();
00624         mirrors = pkg-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>;
00625         
00626         suffix = <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(&amp;newAttributes, <span class="stringliteral">"filename"</span>);
00627         
00628         temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00629         loc = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00630         xmlFree(temp);
00631         
00632         <span class="keywordflow">if</span> (loc != NULL &amp;&amp; loc[0] == <span class="charliteral">'\0'</span>) {
00633                 g_free(loc);
00634                 loc = NULL;
00635         }
00636 
00637         allocated = <a class="code" href="parseupdatesxml_8c.html#a17">parsePackageProperties</a>(node, pkg, &amp;newAttributes);
00638         total  = <a class="code" href="parseupdatesxml_8c.html#a18">parsePackageAttrMirrors</a>(pkg, &amp;newAttributes, suffix, loc);
00639         total += <a class="code" href="parseupdatesxml_8c.html#a19">parsePackageChildMirrors</a>(doc, node, pkg, suffix);
00640         
00641         <span class="keywordflow">if</span> (total != 100 &amp;&amp; total != 0) {
00642                 <span class="keywordtype">int</span> n, sum;
00643                 <span class="keywordtype">float</span> factor;
00644                 
00645                 factor = ((<span class="keywordtype">float</span>)100 / total);
00646                 sum = 0;
00647                 
00648                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Rescaling mirror weights by factor of %.01f (total = %d)"</span>, factor, total);
00649                 <span class="keywordflow">for</span> (i = 0; i &lt; mirrors-&gt;len; i += 2) {
00650                         <span class="keywordflow">if</span> (i+2 == mirrors-&gt;len) <span class="comment">/* last mirror */</span>
00651                                 n = 100 - sum;
00652                         <span class="keywordflow">else</span> {
00653                                 n = GPOINTER_TO_INT (g_ptr_array_index(mirrors, i));
00654                                 n *= factor;
00655                         }
00656                         
00657                         mirrors-&gt;pdata[i] = GINT_TO_POINTER (n);
00658                         
00659                         sum += n;
00660                 }
00661         }
00662 
00663         
00664 <span class="preprocessor">#ifdef DEBUG</span>
00665 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i = 0; i &lt; pkg-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>-&gt;len; i += 2)
00666                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"URL: %s; weight: %d\n"</span>,
00667                                 (<span class="keywordtype">char</span>*)g_ptr_array_index(mirrors, i+1),
00668                                 GPOINTER_TO_INT (g_ptr_array_index(mirrors, i)));
00669 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
00670 
00671         
00672         g_free(loc);
00673         <span class="keywordflow">if</span> (allocated != NULL)
00674                 <a class="code" href="gcontainer_8h.html#a23">g_container_destroy</a>(allocated);
00675         
00676         <a class="code" href="parseupdatesxml_8c.html#a28">freeSetAttributes</a>(&amp;newAttributes, FALSE);
00677 }
00678         
00679 
00680 <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a> *
<a name="l00681"></a><a class="code" href="parseupdatesxml_8c.html#a17">00681</a> <a class="code" href="parseupdatesxml_8c.html#a17">parsePackageProperties</a>(xmlNodePtr node, <a class="code" href="structAPackage.html">APackage</a> *pkg, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes)
00682 {
00683         <a class="code" href="structGContainer.html">GContainer</a> *allocated;
00684         GPtrArray *mirrors;
00685         <span class="keywordtype">char</span> *temp;
00686         
00687         allocated = NULL;
00688         
00689         mirrors = pkg-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>;
00690         
00691         temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"md5"</span>);
00692         <span class="keywordflow">if</span> (temp != NULL) {
00693                 strncpy(pkg-&gt;<a class="code" href="structAPackage.html#o2">md5sum</a>, temp, 33);
00694                 xmlFree(temp);
00695         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (temp = <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(attributes, <span class="stringliteral">"md5"</span>)) != NULL ) {
00696                 strncpy(pkg-&gt;<a class="code" href="structAPackage.html#o2">md5sum</a>, temp, 33);
00697         } <span class="keywordflow">else</span> {
00698                 pkg-&gt;<a class="code" href="structAPackage.html#o2">md5sum</a>[0] = <span class="charliteral">'\0'</span>;
00699         }
00700         
00701         temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"size"</span>);
00702         <span class="keywordflow">if</span> (temp != NULL) {
00703                 pkg-&gt;<a class="code" href="structAPackage.html#o4">size</a> = atoi(temp);
00704                 xmlFree(temp);
00705         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (temp = <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(attributes, <span class="stringliteral">"size"</span>)) != NULL ) {
00706                 pkg-&gt;<a class="code" href="structAPackage.html#o4">size</a> = atoi(temp);
00707         } <span class="keywordflow">else</span> {
00708                 pkg-&gt;<a class="code" href="structAPackage.html#o4">size</a> = 0;
00709         }
00710         
00711         temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"type"</span>);
00712         <span class="keywordflow">if</span> (temp != NULL) {
00713                 pkg-&gt;<a class="code" href="structAPackage.html#o0">type</a> = <a class="code" href="libuau_8h.html#a70">luau_parsePkgType</a>(temp);
00714                 xmlFree(temp);
00715         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (temp = <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(attributes, <span class="stringliteral">"type"</span>)) != NULL ) {
00716                 pkg-&gt;<a class="code" href="structAPackage.html#o0">type</a> = <a class="code" href="libuau_8h.html#a70">luau_parsePkgType</a>(temp);
00717         } <span class="keywordflow">else</span> {
00718                 pkg-&gt;<a class="code" href="structAPackage.html#o0">type</a> = <a class="code" href="libuau_8h.html#a11">LUAU_UNKNOWN</a>;
00719         }
00720         
00721         temp = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"mirror-id"</span>);
00722         <span class="keywordflow">if</span> (temp != NULL)
00723         {
00724                 <a class="code" href="structAMultAttribute.html">AMultAttribute</a> *attrs;
00725                 
00726                 allocated = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
00727                 
00728                 attrs = <a class="code" href="parseupdatesxml_8c.html#a21">appendStringToAttributeList</a>(attributes, <span class="stringliteral">"mirror-id"</span>, temp);
00729                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(allocated, attrs-&gt;<a class="code" href="structAMultAttribute.html#o0">id</a>);
00730                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(allocated, attrs-&gt;<a class="code" href="structAMultAttribute.html#o1">values</a>);
00731                 <a class="code" href="gcontainer_8h.html#a7">g_container_concat</a>(allocated, attrs-&gt;<a class="code" href="structAMultAttribute.html#o1">values</a>);
00732                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(allocated, attrs);
00733                 
00734                 xmlFree(temp);
00735         }
00736         
00737         pkg-&gt;<a class="code" href="structAPackage.html#o3">version</a> = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"version"</span>);
00738         <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structAPackage.html#o3">version</a> == NULL)
00739                 pkg-&gt;<a class="code" href="structAPackage.html#o3">version</a> = <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(attributes, <span class="stringliteral">"version"</span>);
00740                 
00741         <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o7">availableFormats</a> = (<a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o7">availableFormats</a> | pkg-&gt;<a class="code" href="structAPackage.html#o0">type</a>);
00742         
00743         <span class="keywordflow">return</span> allocated;
00744 }
00745 
00746 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00747"></a><a class="code" href="parseupdatesxml_8c.html#a18">00747</a> <a class="code" href="parseupdatesxml_8c.html#a18">parsePackageAttrMirrors</a>(<a class="code" href="structAPackage.html">APackage</a> *pkg, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix, <span class="keyword">const</span> <span class="keywordtype">char</span> *loc)
00748 {
00749         GPtrArray *mirrors;
00750         <a class="code" href="structGContainer.html">GContainer</a> *mirrorList, *mirrorIDs, *tmp;
00751         <a class="code" href="structGIterator.html">GIterator</a> iter;
00752         gboolean result;
00753         <span class="keywordtype">char</span> *temp, *prefix;
00754         <span class="keywordtype">int</span> total = 0;
00755         
00756         mirrors = pkg-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>;
00757         
00758         mirrorList = <a class="code" href="parseupdatesxml_8c.html#a23">getAttributeList</a>(attributes, <span class="stringliteral">"mirror-url"</span>);
00759         mirrorIDs  = <a class="code" href="parseupdatesxml_8c.html#a23">getAttributeList</a>(attributes, <span class="stringliteral">"mirror-id"</span>);
00760         
00761         g_assert(mirrorList != NULL);
00762         g_assert(mirrorIDs  != NULL);
00763         
00764         <span class="keywordflow">if</span> (mirrorIDs-&gt;<a class="code" href="structGContainer.html#o1">len</a> &gt; 0)
00765         {
00766                 tmp = <a class="code" href="parseupdatesxml_8c.html#a25">parseMirrorIDs</a>(mirrorIDs, attributes);
00767                 <a class="code" href="gcontainer_8h.html#a7">g_container_concat</a>(mirrorList, tmp);
00768                 <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(tmp, TRUE);
00769         }
00770 
00771         
00772         <span class="keywordflow">if</span> (loc != NULL || suffix != NULL)
00773         {
00774                 result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, mirrorList);
00775                 <span class="keywordflow">if</span> (result)
00776                 {
00777                         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
00778                         {
00779                                 prefix = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
00780                                 g_assert(prefix != NULL);
00781                                 
00782                                 <span class="comment">/* We have to be careful not to pass any unintended NULL values</span>
00783 <span class="comment">                                   to vstrcreate, because a NULL value tells vstrcreate to terminate</span>
00784 <span class="comment">                                   (an unfortunate necessity to deal with C's unsavory handling of a</span>
00785 <span class="comment">                                   variable number of arguments) */</span>
00786                                 <span class="keywordflow">if</span> (suffix == NULL) <span class="comment">/* loc != NULL */</span>
00787                                         temp = <a class="code" href="util_8h.html#a13">lutil_vstrcreate</a>(prefix, loc, NULL);
00788                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (loc == NULL) <span class="comment">/* suffix != NULL */</span>
00789                                         temp = <a class="code" href="util_8h.html#a13">lutil_vstrcreate</a>(prefix, suffix, NULL);
00790                                 <span class="keywordflow">else</span> <span class="comment">/* loc != NULL, suffix != NULL */</span>
00791                                         temp = <a class="code" href="util_8h.html#a13">lutil_vstrcreate</a>(prefix, loc, suffix, NULL);
00792                                 
00793                                 g_ptr_array_add(mirrors, GINT_TO_POINTER (100));
00794                                 g_ptr_array_add(mirrors, temp);
00795                                 total += 100;
00796                         }
00797                 }
00798         }
00799                 
00800         <span class="keywordflow">if</span> (mirrorList-&gt;<a class="code" href="structGContainer.html#o1">len</a> == 0 &amp;&amp; loc != NULL)
00801         {
00802                 <span class="keywordflow">if</span> (suffix != NULL)
00803                         temp = <a class="code" href="util_8h.html#a13">lutil_vstrcreate</a>(loc, suffix, NULL);
00804                 <span class="keywordflow">else</span>
00805                         temp = g_strdup(loc);
00806                 
00807                 g_ptr_array_add(mirrors, GINT_TO_POINTER (100));
00808                 g_ptr_array_add(mirrors, temp);
00809                 total += 100;
00810         }
00811         
00812         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(mirrorList, TRUE);
00813         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(mirrorIDs, TRUE);
00814         
00815         <span class="keywordflow">return</span> total;
00816 }
00817 
00818 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00819"></a><a class="code" href="parseupdatesxml_8c.html#a19">00819</a> <a class="code" href="parseupdatesxml_8c.html#a19">parsePackageChildMirrors</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structAPackage.html">APackage</a> *pkg, <span class="keyword">const</span> <span class="keywordtype">char</span> *suffix)
00820 {
00821         GPtrArray *mirrors;
00822         <span class="keywordtype">char</span> *percentage, *loc, *temp;
00823         <span class="keywordtype">int</span> i, total;
00824         
00825         total = 0;
00826         
00827         <span class="keywordflow">if</span> (node-&gt;xmlChildrenNode != NULL) {
00828                 mirrors = pkg-&gt;<a class="code" href="structAPackage.html#o1">mirrors</a>;
00829                 
00830                 <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00831                         <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(node-&gt;name, <span class="stringliteral">"mirror"</span>)) {
00832                                 percentage = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"weight"</span>);
00833                                 <span class="keywordflow">if</span> (percentage == NULL) {
00834                                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Weight for mirror not specified - using default"</span>);
00835                                         g_ptr_array_add(mirrors, GINT_TO_POINTER (100));
00836                                         total += 100;
00837                                 } <span class="keywordflow">else</span> {
00838                                         i = atoi(percentage);
00839                                         <span class="keywordflow">if</span> (i &lt;= 0) i = 1;
00840                                         g_ptr_array_add(mirrors, GINT_TO_POINTER (i));
00841                                         xmlFree(percentage);
00842                                         
00843                                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Weight for mirror: %d"</span>, i);
00844                                         
00845                                         total += i;
00846                                 }
00847                                 
00848                                 temp = (<span class="keywordtype">char</span>*) xmlNodeListGetString(doc, node-&gt;xmlChildrenNode, 1);
00849                                 loc = g_strdup(<a class="code" href="parse_8h.html#a6">lutil_parse_deleteWhitespace</a>(temp));
00850                                 xmlFree(temp);
00851                                 <span class="keywordflow">if</span> (suffix != NULL) {
00852                                         temp = <a class="code" href="util_8h.html#a13">lutil_vstrcreate</a>(loc, suffix, NULL);
00853                                         g_free(loc);
00854                                         loc = temp;
00855                                 }
00856                                 g_ptr_array_add(mirrors, loc);
00857                                 
00858                                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Mirror location: %s"</span>, loc);
00859                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="util_8h.html#a10">lutil_streq</a>(node-&gt;name, <span class="stringliteral">"text"</span>) &amp;&amp; !<a class="code" href="util_8h.html#a10">lutil_streq</a>(node-&gt;name, <span class="stringliteral">"comment"</span>)) {
00860                                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Invalid tag '&lt;%s&gt;' in &lt;package&gt; section (only '&lt;mirror&gt;' allowed)"</span>, node-&gt;name);
00861                         }
00862                 }
00863                 
00864         }
00865         
00866         <span class="keywordflow">return</span> total;
00867 }
00868 
00869 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00870"></a><a class="code" href="parseupdatesxml_8c.html#a12">00870</a> <a class="code" href="parseupdatesxml_8c.html#a12">parseMessage</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) {
00871         <span class="comment">/* Nothing to do here!  There are (currently) no XML tags specific to message updates */</span>
00872 }
00873 
00874 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00875"></a><a class="code" href="parseupdatesxml_8c.html#a13">00875</a> <a class="code" href="parseupdatesxml_8c.html#a13">parseLibupdate</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes) {
00876         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *symbols[ ] = { <span class="stringliteral">"set"</span>, <span class="stringliteral">"s"</span>,
00877                                           NULL };
00878         <span class="keywordtype">char</span> result;
00879         
00880         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00881                 result = <a class="code" href="parse_8h.html#a2">lutil_parse_parseSymbolArray</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)node-&gt;name, symbols);
00882                 <span class="keywordflow">switch</span> (result) {
00883                         <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00884                                 <a class="code" href="parseupdatesxml_8c.html#a1">currUpdate</a>-&gt;<a class="code" href="structAUpdate.html#o12">newURL</a> = (<span class="keywordtype">char</span>*) xmlGetProp(node, <span class="stringliteral">"url"</span>);
00885                                 <span class="keywordflow">break</span>;
00886                 }
00887         }
00888 }
00889 
00890 <span class="keyword">static</span> gboolean
<a name="l00891"></a><a class="code" href="parseupdatesxml_8c.html#a20">00891</a> <a class="code" href="parseupdatesxml_8c.html#a20">parseQuantData</a>(<span class="keywordtype">void</span> **data, <span class="keywordtype">char</span> *str, AQuantDataType quantDataType) {
00892         gboolean result;
00893         
00894         <span class="keywordflow">if</span> (quantDataType == <a class="code" href="libuau_8h.html#a101a30">LUAU_QUANT_DATA_VERSION</a> || quantDataType == <a class="code" href="libuau_8h.html#a101a32">LUAU_QUANT_DATA_KEYWORD</a>) {
00895                 *data = g_strdup(str);
00896                 result = TRUE;
00897         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (quantDataType == <a class="code" href="libuau_8h.html#a101a31">LUAU_QUANT_DATA_INTERFACE</a>) {
00898                 *data = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAInterface.html">AInterface</a>));
00899                 result = <a class="code" href="libuau_8h.html#a71">luau_parseInterface</a>((AInterface*) *data, str);
00900         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (quantDataType == <a class="code" href="libuau_8h.html#a101a29">LUAU_QUANT_DATA_DATE</a>) {
00901                 *data = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structADate.html">ADate</a>));
00902                 result = <a class="code" href="libuau_8h.html#a69">luau_parseDate</a>((ADate*) *data, str);
00903         } <span class="keywordflow">else</span> {
00904                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"Internal Error: Unrecognized quantifier data type (%d)"</span>, quantDataType);
00905                 result = FALSE;
00906         }
00907         
00908         <span class="keywordflow">return</span> result;
00909 }
00910 
00911 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00912"></a><a class="code" href="parseupdatesxml_8c.html#a16">00912</a> <a class="code" href="parseupdatesxml_8c.html#a16">parsePkgGroup</a>(xmlDocPtr doc, xmlNodePtr node, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes)
00913 {
00914         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *symbols[ ] = { <span class="stringliteral">"package"</span>, <span class="stringliteral">"p"</span>,
00915                                               <span class="stringliteral">"package-group"</span>, <span class="stringliteral">"g"</span>,
00916                                                                           <span class="stringliteral">"text"</span>, <span class="stringliteral">"t"</span>,
00917                                                                           <span class="stringliteral">"comment"</span>, <span class="stringliteral">"c"</span>,
00918                                           NULL };
00919         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *sing_names[ ] = { <span class="stringliteral">"option"</span>, <span class="stringliteral">"type"</span>, <span class="stringliteral">"size"</span>, <span class="stringliteral">"md5"</span>, <span class="stringliteral">"filename"</span>, <span class="stringliteral">"version"</span> };
00920         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *mult_names[ ] = { <span class="stringliteral">"mirror-url"</span>, <span class="stringliteral">"mirror-id"</span> };
00921         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> nSingNames = 6;
00922         <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> nMultNames = 2;
00923         
00924         <a class="code" href="structASingAttribute.html">ASingAttribute</a> *singAttr;
00925         <a class="code" href="structAMultAttribute.html">AMultAttribute</a> *multAttr;
00926         <a class="code" href="structASetAttributes.html">ASetAttributes</a> newAttributes;
00927         <a class="code" href="structGContainer.html">GContainer</a> *newSingAttributes = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
00928         <a class="code" href="structGContainer.html">GContainer</a> *newMultAttributes = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
00929         <a class="code" href="structGIterator.html">GIterator</a> iter;
00930         <span class="keywordtype">char</span>  *value, result;
00931         <span class="keyword">const</span> <span class="keywordtype">char</span> *name;
00932         <span class="keywordtype">int</span> i;
00933         
00934         <span class="comment">/* g_list_copy does only a shallow copy, but that's all right.  We do this so that</span>
00935 <span class="comment">           any new attributes we append on here will not affect the attributes passed in</span>
00936 <span class="comment">           by the calling function. */</span>
00937         <a class="code" href="parseupdatesxml_8c.html#a27">copySetAttributes</a>(&amp;newAttributes, attributes, FALSE);
00938         <span class="comment">/* When we go through and eliminate any malloc'd memory at the end of this function</span>
00939 <span class="comment">           we need to be sure to -only- eliminate memory we allocated, not anything that</span>
00940 <span class="comment">           was in the list passed in.  So we keep a pointer to the last attribute given to</span>
00941 <span class="comment">           us and start with the one after that when we go through to free everything. */</span>
00942         <span class="comment">/*result = g_container_get_iter_last(&amp;lastOldElement, attributes);</span>
00943 <span class="comment">        if (!result)</span>
00944 <span class="comment">                return;</span>
00945 <span class="comment">        */</span>
00946         <span class="comment">/* Collect any new attributes specified in this package-group tag */</span>
00947         <span class="keywordflow">for</span> (i = 0; i &lt; nSingNames; ++i) {
00948                 name = sing_names[i];
00949                 value = (<span class="keywordtype">char</span>*) xmlGetProp(node, name);
00950                 <span class="keywordflow">if</span> (value != NULL) {
00951                         singAttr = <a class="code" href="parseupdatesxml_8c.html#a22">setAttributeValue</a>(&amp;newAttributes, name, value);
00952                         <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(newSingAttributes, singAttr);
00953                         xmlFree(value);
00954                 }
00955         }
00956         <span class="keywordflow">for</span> (i = 0; i &lt; nMultNames; ++i) {
00957                 name = mult_names[i];
00958                 value = (<span class="keywordtype">char</span>*) xmlGetProp(node, name);
00959                 <span class="keywordflow">if</span> (value != NULL) {
00960                         multAttr = <a class="code" href="parseupdatesxml_8c.html#a21">appendStringToAttributeList</a>(&amp;newAttributes, name, value);
00961                         <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(newMultAttributes, multAttr);
00962                         xmlFree(value);
00963                 }
00964         }
00965         
00966         <span class="comment">/* Parse the children elements, passing along any attributes picked up */</span>
00967         <span class="keywordflow">for</span> (node = node-&gt;xmlChildrenNode; node != NULL; node = node-&gt;next) {
00968                 result = <a class="code" href="parse_8h.html#a2">lutil_parse_parseSymbolArray</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)node-&gt;name, symbols);
00969                 
00970                 <span class="keywordflow">switch</span> (result) {
00971                         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00972                                 <a class="code" href="parseupdatesxml_8c.html#a11">parsePackage</a>(doc, node, &amp;newAttributes);
00973                                 <span class="keywordflow">break</span>;
00974                         
00975                         <span class="keywordflow">case</span> <span class="charliteral">'g'</span>:
00976                                 <a class="code" href="parseupdatesxml_8c.html#a16">parsePkgGroup</a>(doc, node, &amp;newAttributes);
00977                                 <span class="keywordflow">break</span>;
00978                         
00979                         <span class="keywordflow">case</span> -1:
00980                                 <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"Unrecognized &lt;%s&gt; tag in &lt;package-group&gt; at line %ld in repository file: Skipping"</span>, node-&gt;name, xmlGetLineNo(node));
00981                                 <span class="keywordflow">break</span>;
00982 
00983                 }
00984         }
00985         
00986         <span class="comment">/* Remember - we aren't actually freeing the attribute list passed into</span>
00987 <span class="comment">           the function (that would be a no no!): we're only freeing the -copy-</span>
00988 <span class="comment">           of those attributes we made at the beginning of this function, along</span>
00989 <span class="comment">           with any new ones we may've added) */</span>
00990         result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, newSingAttributes);
00991         <span class="keywordflow">if</span> (result)
00992         {
00993                 <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
00994                 {
00995                         singAttr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
00996                         <a class="code" href="parseupdatesxml_8c.html#a29">freeSingAttribute</a>(singAttr);
00997                         <span class="comment">//g_free(singAttr);</span>
00998                 }
00999         }
01000         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(newSingAttributes, TRUE);
01001         
01002         result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, newMultAttributes);
01003         <span class="keywordflow">if</span> (result)
01004         {
01005                 <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
01006                 {
01007                         multAttr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01008                         <a class="code" href="parseupdatesxml_8c.html#a30">freeMultAttribute</a>(multAttr);
01009                         <span class="comment">//g_free(multAttr);</span>
01010                 }
01011         }
01012         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(newMultAttributes, TRUE);
01013         
01014         <span class="comment">/* A shallow free - again, not actually free'ing the pointers contained</span>
01015 <span class="comment">           in the list (except for what was done above) */</span>
01016         <a class="code" href="parseupdatesxml_8c.html#a28">freeSetAttributes</a>(&amp;newAttributes, FALSE);
01017 }
01018 
01019 <span class="keyword">static</span> <a class="code" href="structAMultAttribute.html">AMultAttribute</a> *
<a name="l01020"></a><a class="code" href="parseupdatesxml_8c.html#a21">01020</a> <a class="code" href="parseupdatesxml_8c.html#a21">appendStringToAttributeList</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
01021 {
01022         <a class="code" href="structAMultAttribute.html">AMultAttribute</a> *attrs;
01023         <a class="code" href="structGContainer.html">GContainer</a> *newAttrs;
01024         
01025         g_assert(attributes != NULL);
01026         g_assert(<span class="keywordtype">id</span> != NULL);
01027         g_assert(value != NULL);
01028         
01029         newAttrs = <a class="code" href="util_8h.html#a16">lutil_gsplit</a>(<span class="stringliteral">";"</span>, value);
01030         
01031         attrs = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structAMultAttribute.html">AMultAttribute</a>));
01032         attrs-&gt;<a class="code" href="structAMultAttribute.html#o0">id</a> = g_strdup(<span class="keywordtype">id</span>);
01033         attrs-&gt;<a class="code" href="structAMultAttribute.html#o1">values</a> = newAttrs;
01034         
01035         <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a>, attrs);
01036         
01037         <span class="keywordflow">return</span> attrs;
01038 }
01039 <span class="comment">/*</span>
01040 <span class="comment">static void</span>
01041 <span class="comment">appendAttrToAttributeList(ASetAttributes *attributes, const char *id, ASingAttribute *new_attr)</span>
01042 <span class="comment">{</span>
01043 <span class="comment">        AMultAttribute *attr, *temp_attr;</span>
01044 <span class="comment">        GIterator iter;</span>
01045 <span class="comment">        gboolean found, result;</span>
01046 <span class="comment">        </span>
01047 <span class="comment">        found = FALSE;</span>
01048 <span class="comment">        </span>
01049 <span class="comment">        result = g_container_getIter(&amp;iter, attributes-&gt;multAttributes</span>
01050 <span class="comment">        for (curr = attributes; curr != NULL; curr = curr-&gt;next)</span>
01051 <span class="comment">        {</span>
01052 <span class="comment">                attr = curr-&gt;data;</span>
01053 <span class="comment">                g_assert(attr != NULL);</span>
01054 <span class="comment">                if (lutil_streq(id, attr-&gt;id))</span>
01055 <span class="comment">                {</span>
01056 <span class="comment">                        found = TRUE;</span>
01057 <span class="comment">                        break;</span>
01058 <span class="comment">                }</span>
01059 <span class="comment">        }</span>
01060 <span class="comment">        </span>
01061 <span class="comment">        if (found)</span>
01062 <span class="comment">        {</span>
01063 <span class="comment">                found = FALSE;</span>
01064 <span class="comment">                for (curr = attr-&gt;value; curr != NULL; curr = curr-&gt;next)</span>
01065 <span class="comment">                {</span>
01066 <span class="comment">                        curr_attr = curr-&gt;data;</span>
01067 <span class="comment">                        g_assert(curr_attr != NULL);</span>
01068 <span class="comment">                        if (lutil_streq(curr_attr-&gt;id, new_attr-&gt;id))</span>
01069 <span class="comment">                        {</span>
01070 <span class="comment">                                curr_attr-&gt;value = g_list_append(curr_attr-&gt;value, new_attr-&gt;value);</span>
01071 <span class="comment">                                found = TRUE;</span>
01072 <span class="comment">                                break;</span>
01073 <span class="comment">                        }</span>
01074 <span class="comment">                }</span>
01075 <span class="comment">                </span>
01076 <span class="comment">                if (!found)</span>
01077 <span class="comment">                {</span>
01078 <span class="comment">                        temp_attr = g_malloc(sizeof(ANamedAttribute));</span>
01079 <span class="comment">                        temp_attr-&gt;id = new_attr-&gt;id;</span>
01080 <span class="comment">                        temp_attr-&gt;value = g_list_append(NULL, new_attr-&gt;value);</span>
01081 <span class="comment">                        attr-&gt;value = g_list_append(attr-&gt;value, temp_attr);</span>
01082 <span class="comment">                }</span>
01083 <span class="comment">        }</span>
01084 <span class="comment">        else</span>
01085 <span class="comment">        {</span>
01086 <span class="comment">                temp_attr = g_malloc(sizeof(ANamedAttribute));</span>
01087 <span class="comment">                temp_attr-&gt;id = new_attr-&gt;id;</span>
01088 <span class="comment">                temp_attr-&gt;value = g_list_append(NULL, new_attr-&gt;value);</span>
01089 <span class="comment">                </span>
01090 <span class="comment">                attr = g_malloc(sizeof(ANamedAttribute));</span>
01091 <span class="comment">                attr-&gt;id = id;</span>
01092 <span class="comment">                attr-&gt;value = g_list_append(NULL, temp_attr);</span>
01093 <span class="comment">                </span>
01094 <span class="comment">                attributes = g_list_append(attributes, attr);</span>
01095 <span class="comment">        }</span>
01096 <span class="comment">        </span>
01097 <span class="comment">        return attributes;</span>
01098 <span class="comment">}</span>
01099 <span class="comment">*/</span>
01100                                                        
01101 <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a> *
<a name="l01102"></a><a class="code" href="parseupdatesxml_8c.html#a23">01102</a> <a class="code" href="parseupdatesxml_8c.html#a23">getAttributeList</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
01103 {
01104         <a class="code" href="structAMultAttribute.html">AMultAttribute</a> *attr;
01105         <a class="code" href="structGContainer.html">GContainer</a> *results, *list;
01106         <a class="code" href="structGIterator.html">GIterator</a> iter;
01107         gboolean result;
01108         
01109         g_assert(attributes != NULL);
01110         g_assert(<span class="keywordtype">id</span> != NULL);
01111         
01112         results = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
01113         
01114         result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a>);
01115         <span class="keywordflow">if</span> (!result)
01116                 <span class="keywordflow">return</span> results;
01117         
01118         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
01119         {
01120                 attr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01121                 g_assert(attr != NULL);
01122                 
01123                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(<span class="keywordtype">id</span>, attr-&gt;<a class="code" href="structAMultAttribute.html#o0">id</a>))
01124                 {
01125                         list = attr-&gt;<a class="code" href="structAMultAttribute.html#o1">values</a>;
01126                         <a class="code" href="gcontainer_8h.html#a7">g_container_concat</a>(results, list);
01127                 }
01128         }
01129         
01130         <span class="keywordflow">return</span> results;
01131 }
01132 
01133 <span class="keyword">static</span> <a class="code" href="structASingAttribute.html">ASingAttribute</a> *
<a name="l01134"></a><a class="code" href="parseupdatesxml_8c.html#a22">01134</a> <a class="code" href="parseupdatesxml_8c.html#a22">setAttributeValue</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
01135 {
01136         <a class="code" href="structASingAttribute.html">ASingAttribute</a> *attr;
01137         
01138         g_assert(attributes != NULL);
01139         g_assert(<span class="keywordtype">id</span> != NULL);
01140         g_assert(value != NULL);
01141         
01142         attr = g_malloc(<span class="keyword">sizeof</span>(<a class="code" href="structASingAttribute.html">ASingAttribute</a>));
01143         
01144         attr-&gt;<a class="code" href="structASingAttribute.html#o0">id</a> = g_strdup(<span class="keywordtype">id</span>);
01145         attr-&gt;<a class="code" href="structASingAttribute.html#o1">value</a> = g_strdup(value);
01146         <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a>, attr);
01147         
01148         <span class="keywordflow">return</span> attr;
01149 }
01150 
01151 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01152"></a><a class="code" href="parseupdatesxml_8c.html#a24">01152</a> <a class="code" href="parseupdatesxml_8c.html#a24">getAttributeString</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
01153 {
01154         <a class="code" href="structASingAttribute.html">ASingAttribute</a> *attr;
01155         <a class="code" href="structGIterator.html">GIterator</a> iter;
01156         gboolean result;
01157         <span class="keywordtype">char</span> *value = NULL;
01158         
01159         g_assert(<span class="keywordtype">id</span> != NULL);
01160         g_assert(attributes != NULL);
01161         
01162         result = <a class="code" href="gcontainer_8h.html#a14">g_container_get_iter_last</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a>);
01163         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a19">g_iterator_hasPrev</a>(&amp;iter))
01164         {
01165                 attr = <a class="code" href="gcontainer_8h.html#a17">g_iterator_prev</a>(&amp;iter);
01166                 g_assert(attr != NULL);
01167                 
01168                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(<span class="keywordtype">id</span>, attr-&gt;<a class="code" href="structASingAttribute.html#o0">id</a>)) {
01169                         value = attr-&gt;<a class="code" href="structASingAttribute.html#o1">value</a>;
01170                         <span class="keywordflow">break</span>;
01171                 }
01172         }
01173         
01174         <span class="keywordflow">return</span> value;
01175 }
01176 
01177 <span class="keyword">static</span> <a class="code" href="structGContainer.html">GContainer</a> *
<a name="l01178"></a><a class="code" href="parseupdatesxml_8c.html#a25">01178</a> <a class="code" href="parseupdatesxml_8c.html#a25">parseMirrorIDs</a>(<a class="code" href="structGContainer.html">GContainer</a> *ids, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes)
01179 {
01180         <a class="code" href="structAMirror.html">AMirror</a> *mirr;
01181         <a class="code" href="structAMirrorList.html">AMirrorList</a> *mirrLst;
01182         <a class="code" href="structGContainer.html">GContainer</a> *results;
01183         <a class="code" href="structGIterator.html">GIterator</a> iter1, iter2;
01184         gboolean found, result;
01185         <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>;
01186         
01187         g_assert(ids != NULL);
01188         g_assert(attributes != NULL);
01189         
01190         results = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
01191         result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter1, ids);
01192         
01193         <span class="keywordflow">if</span> (!result)
01194                 <span class="keywordflow">return</span> results;
01195         
01196         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter1))
01197         {
01198                 <span class="keywordtype">id</span> = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter1);
01199                 g_assert(<span class="keywordtype">id</span> != NULL);
01200                 found = FALSE;
01201                 
01202                 result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter2, attributes-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a>);
01203                 <span class="keywordflow">if</span> (!result)
01204                         <span class="keywordflow">return</span> results;
01205                 
01206                 <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter2))
01207                 {
01208                         mirr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter2);
01209                         g_assert(mirr != NULL);
01210 
01211                         <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(<span class="keywordtype">id</span>, mirr-&gt;<a class="code" href="structAMirror.html#o0">id</a>))
01212                         {
01213                                 <a class="code" href="gcontainer_8h.html#a6">g_container_add</a>(results, mirr-&gt;<a class="code" href="structAMirror.html#o1">url</a>);
01214                                 found = TRUE;
01215                         }
01216                 }
01217                 
01218                 <span class="keywordflow">if</span> (!found)
01219                 {
01220                         result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter2, attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a>);
01221                         <span class="keywordflow">if</span> (!result)
01222                                 <span class="keywordflow">return</span> results;
01223                         
01224                         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter2))
01225                         {
01226                                 mirrLst = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter2);
01227                                 g_assert(mirrLst != NULL);
01228                                 
01229                                 <span class="keywordflow">if</span> (<a class="code" href="util_8h.html#a10">lutil_streq</a>(<span class="keywordtype">id</span>, mirrLst-&gt;<a class="code" href="structAMirrorList.html#o0">id</a>))
01230                                 {
01231                                         <a class="code" href="structGContainer.html">GContainer</a> *tmp = <a class="code" href="parseupdatesxml_8c.html#a25">parseMirrorIDs</a>(mirrLst-&gt;<a class="code" href="structAMirrorList.html#o1">mirrors</a>, attributes);
01232                                         <a class="code" href="gcontainer_8h.html#a7">g_container_concat</a>(results, tmp);
01233                                         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(tmp, TRUE);
01234                                         found = TRUE;
01235                                 }
01236                         }
01237                 }
01238                 
01239                 <span class="keywordflow">if</span> (!found)
01240                         <a class="code" href="error_8h.html#a2">DBUGOUT</a>(<span class="stringliteral">"No such mirror ID: %s"</span>, <span class="keywordtype">id</span>);
01241         }
01242         
01243         <span class="keywordflow">return</span> results;
01244 }
01245                                 
01246 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01247"></a><a class="code" href="parseupdatesxml_8c.html#a26">01247</a> <a class="code" href="parseupdatesxml_8c.html#a26">initializeSetAttributes</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes)
01248 {
01249         attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a> = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
01250         attributes-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a> = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
01251         attributes-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a> = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
01252         attributes-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a> = <a class="code" href="gcontainer_8h.html#a3">g_container_new</a>(<a class="code" href="gcontainer_8h.html#a25a1">GCONT_LIST</a>);
01253 }
01254 
01255 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01256"></a><a class="code" href="parseupdatesxml_8c.html#a27">01256</a> <a class="code" href="parseupdatesxml_8c.html#a27">copySetAttributes</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *newSet, <a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, gboolean deepCopy)
01257 {
01258         <span class="keywordflow">if</span> (deepCopy)
01259                 <a class="code" href="error_8h.html#a1">ERROR</a>(<span class="stringliteral">"ASetAttributes deep copy not supported"</span>);
01260         
01261         g_assert(attributes != NULL);
01262         
01263         newSet-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a> = <a class="code" href="gcontainer_8h.html#a5">g_container_dup</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a>);
01264         newSet-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a> = <a class="code" href="gcontainer_8h.html#a5">g_container_dup</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a>);
01265         newSet-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a> = <a class="code" href="gcontainer_8h.html#a5">g_container_dup</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a>);
01266         newSet-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a> = <a class="code" href="gcontainer_8h.html#a5">g_container_dup</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a>);
01267 }
01268 
01269 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01270"></a><a class="code" href="parseupdatesxml_8c.html#a28">01270</a> <a class="code" href="parseupdatesxml_8c.html#a28">freeSetAttributes</a>(<a class="code" href="structASetAttributes.html">ASetAttributes</a> *attributes, gboolean deepFree)
01271 {
01272         g_assert(attributes != NULL);
01273 
01274         <span class="keywordflow">if</span> (deepFree)
01275         {
01276                 <a class="code" href="structAMultAttribute.html">AMultAttribute</a> *attrs;
01277                 <a class="code" href="structASingAttribute.html">ASingAttribute</a> *attr;
01278                 <a class="code" href="structGIterator.html">GIterator</a> iter;
01279                 gboolean result;
01280                 
01281                 result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a>);
01282                 <span class="keywordflow">if</span> (result)
01283                 {
01284                         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
01285                         {
01286                                 attrs = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01287                                 <a class="code" href="parseupdatesxml_8c.html#a30">freeMultAttribute</a>(attrs);
01288                         }
01289                 }
01290                 
01291                 result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a>);
01292                 <span class="keywordflow">if</span> (result)
01293                 {
01294                         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
01295                         {
01296                                 attr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01297                                 <a class="code" href="parseupdatesxml_8c.html#a29">freeSingAttribute</a>(attr);
01298                         }
01299                 }
01300                 
01301                 result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a>);
01302                 <span class="keywordflow">if</span> (result)
01303                 {
01304                         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
01305                         {
01306                                 attr = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01307                                 <a class="code" href="parseupdatesxml_8c.html#a29">freeSingAttribute</a>(attr);
01308                         }
01309                 }
01310                 
01311                 result = <a class="code" href="gcontainer_8h.html#a13">g_container_get_iter</a>(&amp;iter, attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a>);
01312                 <span class="keywordflow">if</span> (result)
01313                 {
01314                         <span class="keywordflow">while</span> (<a class="code" href="gcontainer_8h.html#a18">g_iterator_hasNext</a>(&amp;iter))
01315                         {
01316                                 attrs = <a class="code" href="gcontainer_8h.html#a16">g_iterator_next</a>(&amp;iter);
01317                                 <a class="code" href="parseupdatesxml_8c.html#a30">freeMultAttribute</a>(attrs);
01318                         }
01319                 }
01320         }
01321         
01322         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o2">multAttributes</a>, TRUE);
01323         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o3">singAttributes</a>, TRUE);
01324         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o0">definedMirrors</a>, TRUE);
01325         <a class="code" href="gcontainer_8h.html#a20">g_container_free</a>(attributes-&gt;<a class="code" href="structASetAttributes.html#o1">definedMirrorLists</a>, TRUE);
01326 }
01327 
01328 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01329"></a><a class="code" href="parseupdatesxml_8c.html#a29">01329</a> <a class="code" href="parseupdatesxml_8c.html#a29">freeSingAttribute</a>(<a class="code" href="structASingAttribute.html">ASingAttribute</a> *attr)
01330 {
01331         g_assert(attr != NULL);
01332         
01333         g_free(attr-&gt;<a class="code" href="structASingAttribute.html#o0">id</a>);
01334         g_free(attr-&gt;<a class="code" href="structASingAttribute.html#o1">value</a>);
01335         g_free(attr);
01336 }
01337 
01338 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01339"></a><a class="code" href="parseupdatesxml_8c.html#a30">01339</a> <a class="code" href="parseupdatesxml_8c.html#a30">freeMultAttribute</a>(<a class="code" href="structAMultAttribute.html">AMultAttribute</a> *attrs)
01340 {
01341         g_assert(attrs != NULL);
01342         g_assert(attrs-&gt;<a class="code" href="structAMultAttribute.html#o1">values</a> != NULL);
01343         
01344         <a class="code" href="gcontainer_8h.html#a23">g_container_destroy</a>(attrs-&gt;<a class="code" href="structAMultAttribute.html#o1">values</a>);
01345         g_free(attrs-&gt;<a class="code" href="structAMultAttribute.html#o0">id</a>);
01346         g_free(attrs);
01347 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat Jan 15 16:52:30 2005 for luau by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
